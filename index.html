<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">

    

    

    <title>ç‚¹æ»´è¯—è¯</title>
    <meta name="author" content="shiguofu">
    <meta name="version" content="1.0.0">
    <meta name="keywords" content>
    <meta name="description" content="å¥½ç©æœ‰è¶£é•¿çŸ¥è¯†">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">

    
    <link rel="alternate" href="/atom.xml" title="ç‚¹æ»´è¯—è¯" type="application/atom+xml">
    
    
    <link rel="icon" href="http://shiguofu.cn/favicon.ico">
    

    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <main class="app">
        <header class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">ç‚¹æ»´è¯—è¯</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item active" href="/">
                <span class="nav-text">é¦–é¡µ</span>
            </a>
        
            <a class="nav-item" href="/categories/backend">
                <span class="nav-text">åç«¯</span>
            </a>
        
            <a class="nav-item" href="/tags">
                <span class="nav-text">æ ‡ç­¾</span>
            </a>
        
            <a class="nav-item" href="/archives">
                <span class="nav-text">å½’æ¡£</span>
            </a>
        
            <a class="nav-item" href="/about">
                <span class="nav-text">å…³äº</span>
            </a>
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://shiguofu2012.github.io"></form>

        
        

        
        <div class="author-meta">
            
            <div class="author-avatar">
                <a href="/">
                    <img src="http://shiguofu.cn/static/images/diandi.jpg" title="å…¬ä¼—å·ï¼šitman-1">
                </a>
            </div>
            
            <div class="author-name">å…¬ä¼—å·ï¼šitman-1</div>
            <div class="author-work">ç¨‹åºçŒ¿ï¼Œè‹¦Bå¥‹æ–—çš„ä¼ªæ–‡è‰ºè€å¹´</div>
            <div class="author-location">
                <i class="icon-location vm"></i>
                <span class="vm">wuhan, China</span>
            </div>
            
            <div class="author-thread-wrap">
                <div class="author-threads clearfix">
                    
                        <a class="thread-item" href="https://github.com/shiguofu2012" target="_blank" rel="noopener">
                            <!-- Generated by IcoMoon.io -->
<svg viewbox="0 0 1024 1024" width="38" height="38" fill="currentColor">
<path d="M512 32.12c-265.004 0-479.88 220.23-479.88 492.090 0 217.446 137.536 401.684 328.202 466.81 23.994 4.498 32.778-10.712 32.778-23.78 0-11.782-0.428-42.632-0.642-83.764-133.466 29.778-161.744-65.984-161.744-65.984-21.852-56.772-53.344-71.982-53.344-71.982-43.49-30.636 3.214-29.992 3.214-29.992 48.202 3.428 73.482 50.772 73.482 50.772 42.846 75.196 112.258 53.558 139.68 40.918 4.284-31.706 16.71-53.558 30.42-65.77-106.474-12.426-218.516-54.63-218.516-243.152 0-53.772 18.638-97.69 49.274-131.966-4.928-12.426-21.424-62.556 4.714-130.252 0 0 40.276-13.282 131.966 50.344 38.348-10.926 79.266-16.282 120.184-16.496 40.704 0.214 81.836 5.57 120.184 16.496 91.692-63.626 131.752-50.344 131.752-50.344 26.136 67.698 9.64 117.828 4.714 130.252 30.636 34.492 49.274 78.408 49.274 131.966 0 188.952-112.258 230.514-219.16 242.724 17.138 15.21 32.564 45.202 32.564 91.048 0 65.77-0.642 118.898-0.642 134.966 0 13.068 8.57 28.492 32.992 23.566 191.094-64.912 328.418-249.152 328.418-466.382 0-271.86-214.874-492.090-479.88-492.090z"/>
</svg>

                        </a>
                    
                        <a class="thread-item" href="http://weibo.com/shiguofu2012" target="_blank" rel="noopener">
                            <!-- Generated by IcoMoon.io -->
<svg viewbox="0 0 1024 1024" width="38" height="38" fill="currentColor">
<path d="M21.332 512c0-270.988 219.68-490.666 490.668-490.666s490.666 219.68 490.666 490.666c0 270.988-219.678 490.666-490.666 490.666s-490.666-219.678-490.666-490.666zM960 512c0-247.424-200.576-448-448-448s-448 200.576-448 448c0 247.424 200.576 448 448 448s448-200.576 448-448zM768 597.332c47.128 0 85.332-38.206 85.332-85.332s-38.206-85.332-85.332-85.332c-47.128 0-85.332 38.204-85.332 85.332s38.206 85.332 85.332 85.332zM512 597.332c47.128 0 85.332-38.206 85.332-85.332s-38.206-85.332-85.332-85.332c-47.128 0-85.332 38.204-85.332 85.332s38.204 85.332 85.332 85.332zM255.998 597.332c47.128 0 85.332-38.206 85.332-85.332s-38.204-85.332-85.332-85.332c-47.128 0-85.332 38.204-85.332 85.332s38.204 85.332 85.332 85.332z"/>
</svg>

                        </a>
                    
                        <a class="thread-item" href="https://twitter.com/shiguofu2012" target="_blank" rel="noopener">
                            <!-- Generated by IcoMoon.io -->
<svg viewbox="0 0 1024 1024" width="38" height="38" fill="currentColor">
<path d="M512.029 31.011c-263.32 0-476.784 213.502-476.784 476.784 0 263.32 213.464 476.743 476.784 476.743s476.743-213.424 476.743-476.743c0-263.282-213.444-476.784-476.743-476.784zM752.193 411.663c0.251 5.151 0.349 10.319 0.349 15.548 0 158.786-120.856 341.85-341.85 341.85-67.844 0-131.021-19.884-184.188-53.961 9.41 1.104 18.955 1.665 28.656 1.665 56.305 0 108.115-19.208 149.221-51.425-52.567-0.987-96.925-35.741-112.22-83.468 7.32 1.433 14.85 2.149 22.595 2.149 10.959 0 21.569-1.433 31.656-4.201-54.987-11.035-96.402-59.634-96.402-117.796 0-0.524 0-1.025 0.020-1.549 16.186 9.003 34.716 14.404 54.427 15.044-32.258-21.587-53.458-58.317-53.458-100.023 0-22.015 5.925-42.673 16.264-60.408 59.266 72.683 147.807 120.527 247.676 125.521-2.053-8.77-3.118-17.968-3.118-27.378 0-66.333 53.787-120.14 120.158-120.14 34.561 0 65.771 14.599 87.69 37.93 27.378-5.363 53.091-15.393 76.305-29.16-9.003 28.074-28.036 51.618-52.858 66.47 24.338-2.903 47.495-9.37 69.024-18.917-16.070 24.144-36.459 45.306-59.945 62.248z"/>
</svg>

                        </a>
                    
                </div>
            </div>
            
        </div>
        
    </div>
</aside>

</header>

        <div id="content" class="content">
    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2024/05/22/leetcodeæ— é‡å¤å­—ç¬¦ä¸²çš„æœ€å¤§é•¿åº¦/">Leetcodeä¹‹æ— é‡å¤å­—ç¬¦ä¸²çš„æœ€é•¿å­ä¸²</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://shiguofu2012.github.io/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2024-05-22T13:35:20.000Z" itemprop="datePublished">2024-05-22</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/algorithm/">algorithm</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h3 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸² s ï¼Œè¯·ä½ æ‰¾å‡ºå…¶ä¸­ä¸å«æœ‰é‡å¤å­—ç¬¦çš„ æœ€é•¿ å­ä¸² çš„é•¿åº¦ã€‚</span><br></pre></td></tr></table></figure>

<h4 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ç¤ºä¾‹ 1:</span><br><span class="line"></span><br><span class="line">è¾“å…¥: s = &quot;abcabcbb&quot;</span><br><span class="line">è¾“å‡º: 3 </span><br><span class="line">è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ &quot;abc&quot;ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 3ã€‚</span><br><span class="line">ç¤ºä¾‹ 2:</span><br><span class="line"></span><br><span class="line">è¾“å…¥: s = &quot;bbbbb&quot;</span><br><span class="line">è¾“å‡º: 1</span><br><span class="line">è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ &quot;b&quot;ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 1ã€‚</span><br><span class="line">ç¤ºä¾‹ 3:</span><br><span class="line"></span><br><span class="line">è¾“å…¥: s = &quot;pwwkew&quot;</span><br><span class="line">è¾“å‡º: 3</span><br><span class="line">è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ &quot;wke&quot;ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 3ã€‚</span><br><span class="line">     è¯·æ³¨æ„ï¼Œä½ çš„ç­”æ¡ˆå¿…é¡»æ˜¯ å­ä¸² çš„é•¿åº¦ï¼Œ&quot;pwke&quot; æ˜¯ä¸€ä¸ªå­åºåˆ—ï¼Œä¸æ˜¯å­ä¸²ã€‚</span><br></pre></td></tr></table></figure>

<h4 id="æš´åŠ›è§£æ³•"><a href="#æš´åŠ›è§£æ³•" class="headerlink" title="æš´åŠ›è§£æ³•"></a>æš´åŠ›è§£æ³•</h4><p>è¿™ä¸ªé¢˜æœ€å®¹æ˜“æƒ³åˆ°çš„è¿˜æ˜¯æš´åŠ›è§£æ³•ï¼Œæ—¢ç„¶è¦æ‰¾æœ€å¤§çš„å­ä¸²ï¼Œ æˆ‘å°±ä»å¤´å¼€å§‹ä¸€ä¸ªä¸€ä¸ªæ‰¾ã€‚</p>
<p>å›ºå®šå­ä¸²çš„å·¦è¾¹ç•Œï¼Œå³è¾¹ç•Œå¾€å³ç§»åŠ¨ï¼Œé€ä¸ªå¾€å­ä¸²ä¸­æ·»åŠ å­—ç¬¦ï¼Œç›´åˆ°å­ä¸²ä¸­å·²ç»å­˜åœ¨å­—ç¬¦ï¼Œè¿™æ—¶æ‰¾åˆ°ä¸€ä¸ªæœ€å¤§å­ä¸²ä¸é‡å¤çš„å­ä¸² è®°å½•é•¿åº¦ï¼›å·¦è¾¹ç•Œå³ç§»ä¸€ä¸ªå­—ç¬¦ï¼Œç»§ç»­æ“ä½œï¼Œä¸æ–­æ›¿æ¢æœ€å¤§å€¼ã€‚</p>
<p>è¿™é‡Œçš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(n2)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LenOfNonRepeatedSubstr æ— é‡å¤å­ä¸²çš„æœ€å¤§é•¿åº¦ 1. æš´åŠ›ä¹‹ç¾</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LenOfNonRepeatedSubstr</span><span class="params">(str <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	maxStr := <span class="string">""</span></span><br><span class="line">	cur := <span class="number">0</span></span><br><span class="line">	maxLen := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> index := <span class="number">0</span>; index &lt; <span class="built_in">len</span>(str); index += <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> strings.Index(maxStr, <span class="keyword">string</span>(str[index])) != <span class="number">-1</span> &#123; <span class="comment">// æ‰¾åˆ°äº†ï¼Œ å›é€€å¹¶ä¸”ç½®ç©º</span></span><br><span class="line">			maxStr = <span class="string">""</span></span><br><span class="line">			index = cur     <span class="comment">// ç»§ç»­æŸ¥æ‰¾ä¸‹ä¸€ä¸ªä½ç½®å¼€å§‹çš„å­ä¸²</span></span><br><span class="line">			cur = index + <span class="number">1</span> <span class="comment">// è®°å½•å½“å‰å­ä¸²çš„èµ·å§‹ä½ç½®</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123; <span class="comment">// æ— é‡å¤ ç›´æ¥å¢åŠ </span></span><br><span class="line">			maxStr += <span class="keyword">string</span>(str[index])</span><br><span class="line">			<span class="keyword">if</span> maxLen &lt; <span class="built_in">len</span>(maxStr) &#123;</span><br><span class="line">				maxLen = <span class="built_in">len</span>(maxStr)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> maxLen</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>#### </p>
<h4 id="å›æº¯çš„ä½ç½®å¾…æŸ¥æ‰¾"><a href="#å›æº¯çš„ä½ç½®å¾…æŸ¥æ‰¾" class="headerlink" title="å›æº¯çš„ä½ç½®å¾…æŸ¥æ‰¾"></a>å›æº¯çš„ä½ç½®å¾…æŸ¥æ‰¾</h4><p>æš´åŠ›è§£æ³•åœ¨äºï¼Œæ¯æ¬¡éƒ½é‡æ–°å¼€å§‹åŒ¹é…ä¸‹ä¸€ä¸ªä½ç½®ï¼Œæ²¡æœ‰åˆ©ç”¨ä¸Šæ¬¡åŒ¹é…åˆ°çš„ä½ç½®ï¼Œå‡å¦‚abcac åŒ¹é…åˆ°ç¬¬äºŒä¸ªaçš„æ—¶å€™ï¼Œè¦é‡æ–°ä»bå¼€å§‹åŒ¹é…ã€‚</p>
<p>å®é™…å¹¶ä¸éœ€è¦ï¼Œabcæ˜¯æ— é‡å¤çš„ï¼Œåé¢çš„aå·²ç»é‡å¤äº†ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨abcä¸­æ‰¾åˆ° a é‡å¤çš„ä½ç½®ï¼ŒæŠŠä»–ä¹‹å‰çš„å­ä¸²å»æ‰ï¼Œç»§ç»­å¾€ååŒ¹é….</p>
<p>æ¯”å¦‚abc åŒ¹é…åˆ° açš„æ—¶å€™ é‡å¤äº†ï¼Œbcaä¸é‡å¤ç»§ç»­å¾€ååŒ¹é…ã€‚æ—¶é—´å¤æ‚åº¦ O(N)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LenOfNonRepeatedSubstrV1 æ— é‡å¤å­ä¸²çš„æœ€å¤§é•¿åº¦ åˆ©ç”¨å·²ç»æ¯”è¾ƒçš„æœ€å¤§å­ä¸²</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LenOfNonRepeatedSubstrV1</span><span class="params">(str <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	maxStr := <span class="string">""</span></span><br><span class="line">	maxLen := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> index := <span class="number">0</span>; index &lt; <span class="built_in">len</span>(str); index += <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> strings.Index(maxStr, <span class="keyword">string</span>(str[index])) != <span class="number">-1</span> &#123; <span class="comment">// æ‰¾åˆ°äº†ï¼Œå»æ‰æœ€å·¦è¾¹çš„å­—ç¬¦ï¼Œç»§ç»­æŸ¥æ‰¾</span></span><br><span class="line">			<span class="comment">// i..j å¦‚æœæ˜¯æœ€å¤§ä¸é‡å¤çš„ï¼Œé‚£ä¹ˆi+1...j ä¸å¯èƒ½æ˜¯æœ€å¤§çš„</span></span><br><span class="line">			<span class="comment">// ç›´æ¥å°†å·¦è¾¹çš„å»æ‰ çœ‹j+1æ˜¯å¦åœ¨å­ä¸² é€ä¸ªå»æ‰å·¦è¾¹çš„å­—ç¬¦</span></span><br><span class="line">			maxStr = maxStr[<span class="number">1</span>:] <span class="comment">// å»æ‰æœ€å·¦è¾¹çš„å­—ç¬¦</span></span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">    <span class="comment">// ä»¥ä¸Šforå¾ªç¯å¯ç­‰ä»·äº</span></span><br><span class="line">    <span class="comment">// pos := strings.Index(maxStr, string(str[index]))</span></span><br><span class="line">		<span class="comment">// if pos != -1 &#123;</span></span><br><span class="line">		<span class="comment">// 	maxStr = maxStr[pos+1:]</span></span><br><span class="line">		<span class="comment">// &#125;</span></span><br><span class="line">    </span><br><span class="line">		<span class="comment">// j+1ä¸åœ¨å­ä¸²äº†</span></span><br><span class="line">		maxStr += <span class="keyword">string</span>(str[index])</span><br><span class="line">		<span class="keyword">if</span> maxLen &lt; <span class="built_in">len</span>(maxStr) &#123;</span><br><span class="line">			maxLen = <span class="built_in">len</span>(maxStr)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> maxLen</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªåœ¨åŒ¹é…çš„æ—¶å€™ è¿˜æ˜¯ä¼šéå†æŸ¥æ‰¾maxStr ä¸­æ˜¯å¦åŒ…å«å­—ç¬¦ï¼Œè¿™é‡Œåšä¸ªæ”¹è¿›</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LenOfNonRepeatedSubstrV2 æ— é‡å¤å­ä¸²çš„æœ€å¤§é•¿åº¦ åˆ©ç”¨å·²ç»æ¯”è¾ƒçš„æœ€å¤§å­ä¸²</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LenOfNonRepeatedSubstrV2</span><span class="params">(str <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	maxLen := <span class="number">0</span></span><br><span class="line">	strMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">byte</span>]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	rk := <span class="number">-1</span> <span class="comment">// åˆå§‹åŒ– rk ä¸ºå·¦è¾¹çš„</span></span><br><span class="line">	<span class="keyword">for</span> index := <span class="number">0</span>; index &lt; <span class="built_in">len</span>(str); index += <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> index != <span class="number">0</span> &#123;</span><br><span class="line">			<span class="built_in">delete</span>(strMap, str[index<span class="number">-1</span>]) <span class="comment">// å­˜åœ¨é‡å¤çš„ å°±å»æ‰å·¦è¾¹</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> rk+<span class="number">1</span> &lt; <span class="built_in">len</span>(str) &#123;</span><br><span class="line">			<span class="keyword">if</span> _, ok := strMap[str[rk+<span class="number">1</span>]]; !ok &#123; <span class="comment">// ä¸é‡å¤å°±æ”¾å…¥ å¹¶ä¸”æŒ‡é’ˆåç§»</span></span><br><span class="line">				strMap[str[rk+<span class="number">1</span>]] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">				rk += <span class="number">1</span></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		maxLen = max(maxLen, rk-index+<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> maxLen</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåªæ˜¯æŠŠå­—ç¬¦ä¸²æ¢æˆäº† mapï¼ŒæŸ¥æ‰¾çš„æ—¶å€™ä¸ç”¨éå†.</p>
<p>åæ¥çœ‹åˆ«äººæ€»ç»“ï¼Œæ‰å‘ç° è¿™ä¸ªæ–¹æ³•å«åš æ»‘åŠ¨çª—å£ï¼Œç»´æŠ¤ä¸€ä¸ªçª—å£ï¼Œä¸Šé¢çš„ä»£ç å®ç° å°±æ˜¯ maxStr æˆ–è€…strMap çª—å£ä¸­å‡ºç°è¿‡çš„å­—ç¬¦ï¼Œå°±é€æ­¥ç¼©å°å·¦è¾¹çª—å£ï¼Œä¹‹åç»§ç»­æ‰©å¤§å³è¾¹çª—å£ã€‚</p>
<p>ä¸ç®¡å«ä»€ä¹ˆå­—ç¬¦ä¸²åŒ¹é… ä¼˜åŒ–æ–¹æ³• éƒ½æ˜¯ä»å·²ç»åŒ¹é…çš„å­ä¸²ä¸­ï¼Œç»§ç»­å¾€åæ“ä½œï¼Œå°±æ˜¯åˆ©ç”¨å‰é¢çš„åŒ¹é…ï¼Œä¸èƒ½æ¯æ¬¡éƒ½é‡æ–°å¼€å§‹ã€‚</p>
<p>ä¸€æ™šä¸Šä¸€ä¸ªç®—æ³•ï¼Œ çœŸæ˜¯è¡°ğŸ¶ã€‚</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2024/05/21/leetcodeä¸‰æ•°ä¹‹å’Œ/">Leetcodeä¹‹ä¸‰æ•°ä¹‹å’Œ</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://shiguofu2012.github.io/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2024-05-21T14:35:20.000Z" itemprop="datePublished">2024-05-21</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/algorithm/">algorithm</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h3 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ nums ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨ä¸‰å…ƒç»„ [nums[i], nums[j], nums[k]] æ»¡è¶³ i != jã€i != k ä¸” j != k ï¼ŒåŒæ—¶è¿˜æ»¡è¶³ nums[i] + nums[j] + nums[k] == 0 ã€‚è¯·</span><br><span class="line"></span><br><span class="line">ä½ è¿”å›æ‰€æœ‰å’Œä¸º 0 ä¸”ä¸é‡å¤çš„ä¸‰å…ƒç»„ã€‚</span><br><span class="line"></span><br><span class="line">æ³¨æ„ï¼šç­”æ¡ˆä¸­ä¸å¯ä»¥åŒ…å«é‡å¤çš„ä¸‰å…ƒç»„ã€‚</span><br></pre></td></tr></table></figure>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">ç¤ºä¾‹ 1ï¼š</span><br><span class="line">è¾“å…¥ï¼šnums = [-1,0,1,2,-1,-4]</span><br><span class="line">è¾“å‡ºï¼š[[-1,-1,2],[-1,0,1]]</span><br><span class="line">è§£é‡Šï¼š</span><br><span class="line">nums[0] + nums[1] + nums[2] = (-1) + 0 + 1 = 0 ã€‚</span><br><span class="line">nums[1] + nums[2] + nums[4] = 0 + 1 + (-1) = 0 ã€‚</span><br><span class="line">nums[0] + nums[3] + nums[4] = (-1) + 2 + (-1) = 0 ã€‚</span><br><span class="line">ä¸åŒçš„ä¸‰å…ƒç»„æ˜¯ [-1,0,1] å’Œ [-1,-1,2] ã€‚</span><br><span class="line">æ³¨æ„ï¼Œè¾“å‡ºçš„é¡ºåºå’Œä¸‰å…ƒç»„çš„é¡ºåºå¹¶ä¸é‡è¦ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ç¤ºä¾‹ 2ï¼š</span><br><span class="line"></span><br><span class="line">è¾“å…¥ï¼šnums = [0,1,1]</span><br><span class="line">è¾“å‡ºï¼š[]</span><br><span class="line">è§£é‡Šï¼šå”¯ä¸€å¯èƒ½çš„ä¸‰å…ƒç»„å’Œä¸ä¸º 0 ã€‚</span><br><span class="line">ç¤ºä¾‹ 3ï¼š</span><br><span class="line"></span><br><span class="line">è¾“å…¥ï¼šnums = [0,0,0]</span><br><span class="line">è¾“å‡ºï¼š[[0,0,0]]</span><br><span class="line">è§£é‡Šï¼šå”¯ä¸€å¯èƒ½çš„ä¸‰å…ƒç»„å’Œä¸º 0 ã€‚</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">æç¤ºï¼š</span><br><span class="line"></span><br><span class="line">3 &lt;= nums.length &lt;= 3000</span><br><span class="line">-105 &lt;= nums[i] &lt;= 105</span><br></pre></td></tr></table></figure>

<h4 id="æš´åŠ›è§£æ³•"><a href="#æš´åŠ›è§£æ³•" class="headerlink" title="æš´åŠ›è§£æ³•"></a>æš´åŠ›è§£æ³•</h4><p>æœ€ç®€å•çš„å¾€å¾€éƒ½æ˜¯æš´åŠ›è§£æ³•ï¼Œä¸‰ä¸ªæ•° å°±ä¸‰é‡å¾ªç¯ï¼Œ æ¯”è¾ƒç®€å•ï¼Œç›´æ¥ä¸Šä»£ç </p>
<p>ä¸‰é‡å¾ªç¯æ—¶é—´å¤æ‚åº¦æ˜¯ O(N3)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ThreeNumsBaoli æš´åŠ›ä¹‹ç¾</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ThreeNumsBaoli</span><span class="params">(nums []<span class="keyword">int</span>)</span> [][]<span class="title">int</span></span> &#123;</span><br><span class="line">	res := <span class="built_in">make</span>([][]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line">	repMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	<span class="keyword">for</span> index := <span class="number">0</span>; index &lt; <span class="built_in">len</span>(nums); index += <span class="number">1</span> &#123; <span class="comment">// å›ºå®šç¬¬ä¸€ä¸ªæ•°</span></span><br><span class="line">		<span class="keyword">for</span> j := index + <span class="number">1</span>; j &lt; <span class="built_in">len</span>(nums); j += <span class="number">1</span> &#123; <span class="comment">// å›ºå®šç¬¬äºŒä¸ªä¸é‡å¤çš„æ•°</span></span><br><span class="line">			<span class="keyword">for</span> k := j + <span class="number">1</span>; k &lt; <span class="built_in">len</span>(nums); k += <span class="number">1</span> &#123; <span class="comment">// ç¬¬ä¸‰ä¸ªä¸é‡å¤çš„æ•°</span></span><br><span class="line">				<span class="keyword">if</span> nums[index]+nums[j]+nums[k] == <span class="number">0</span> &#123;</span><br><span class="line">					unVal := getUniqueVal([<span class="number">3</span>]<span class="keyword">int</span>&#123;nums[index], nums[j], nums[k]&#125;)</span><br><span class="line">					<span class="keyword">if</span> _, ok := repMap[unVal]; ok &#123;</span><br><span class="line">						<span class="keyword">continue</span></span><br><span class="line">					&#125;</span><br><span class="line">					repMap[unVal] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">					res = <span class="built_in">append</span>(res, []<span class="keyword">int</span>&#123;nums[index], nums[j], nums[k]&#125;)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getUniqueVal</span><span class="params">(nums [3]<span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123; <span class="comment">// è¿™é‡Œæ˜¯ä¸ºäº†å»é‡å¤</span></span><br><span class="line">	<span class="keyword">for</span> index := <span class="number">1</span>; index &lt; <span class="built_in">len</span>(nums); index += <span class="number">1</span> &#123;</span><br><span class="line">		t := nums[index]</span><br><span class="line">		j := index - <span class="number">1</span></span><br><span class="line">		<span class="keyword">for</span> ; j &gt;= <span class="number">0</span>; j-- &#123;</span><br><span class="line">			<span class="keyword">if</span> nums[j] &lt; t &#123;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">			nums[j+<span class="number">1</span>] = nums[j]</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// æ’å…¥jåé¢</span></span><br><span class="line">		nums[j+<span class="number">1</span>] = t</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">"%d,%d,%d"</span>, nums[<span class="number">0</span>], nums[<span class="number">1</span>], nums[<span class="number">2</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="åŒæŒ‡é’ˆæ³•"><a href="#åŒæŒ‡é’ˆæ³•" class="headerlink" title="åŒæŒ‡é’ˆæ³•"></a>åŒæŒ‡é’ˆæ³•</h4><p>è¿™é‡Œæ—¢ç„¶ä¸‰ä¸ªæ•°ä¹‹å’Œä¸º0ï¼Œ è¦ä¹ˆä¸‰ä¸ªæ•°éƒ½æ˜¯0ï¼Œ å¿…é¡»æœ‰ä¸€ä¸ªè´Ÿæ•°ï¼Œè¿™é‡Œæ˜¯ä¸æ˜¯å¯ä»¥è€ƒè™‘å…ˆå°†æ•°ç»„æ’åºï¼Œå›ºå®šä¸€ä¸ªæ•°ï¼Œ è¯¥æ•°åé¢ä½¿ç”¨ï¼Œå¤´å°¾åŒæŒ‡é’ˆï¼Œå°†ä¸‰ä¸ªæŒ‡é’ˆä½ç½®çš„æ•°ç›¸åŠ ï¼Œå¦‚æœå°äº0ï¼Œ é‚£å°†å·¦è¾¹çš„æŒ‡é’ˆå³ç§»ï¼Œè¿™é‡Œä¸ºå•¥ï¼Ÿ ç›´æ¥å°±å³ç§»ï¼Œå› ä¸ºæ•°ç»„æœ‰åºï¼Œå³è¾¹æŒ‡é’ˆå·²ç»æ˜¯æœ€å¤§çš„æ•°äº†ï¼Œåªèƒ½å¢åŠ æœ€å°çš„æ•°ï¼Œæ‰å¯èƒ½ç­‰äº0ã€‚åº”è¯¥å¾ˆå¥½ç†è§£ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ThreeNumRep</span><span class="params">(nums []<span class="keyword">int</span>)</span> [][]<span class="title">int</span></span> &#123;</span><br><span class="line">	sort.Ints(nums)</span><br><span class="line">	res := <span class="built_in">make</span>([][]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> index := <span class="number">0</span>; index &lt; <span class="built_in">len</span>(nums) &amp;&amp; nums[index] &lt;= <span class="number">0</span>; index += <span class="number">1</span> &#123; <span class="comment">// å›ºå®šç¬¬ä¸€ä¸ªæ•°</span></span><br><span class="line">		<span class="keyword">if</span> index &gt; <span class="number">0</span> &amp;&amp; nums[index] == nums[index<span class="number">-1</span>] &#123; <span class="comment">// ç¬¬ä¸€ä¸ªæ•°é‡å¤çš„å¿½ç•¥</span></span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">    </span><br><span class="line">		left, right := index+<span class="number">1</span>, <span class="built_in">len</span>(nums)<span class="number">-1</span></span><br><span class="line">		<span class="keyword">for</span> left &lt; right &#123; <span class="comment">// åé¢ä¸¤ä¸ªæ•°</span></span><br><span class="line">			s := nums[index] + nums[left] + nums[right]</span><br><span class="line">			<span class="keyword">if</span> s &gt; <span class="number">0</span> &#123;</span><br><span class="line">				right -= <span class="number">1</span></span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> s &lt; <span class="number">0</span> &#123;</span><br><span class="line">				left += <span class="number">1</span></span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> s == <span class="number">0</span> &#123; <span class="comment">// ç­‰äº0 è¦æ³¨æ„ 1. å·¦å³æŒ‡é’ˆè¦éƒ½ç§»åŠ¨</span></span><br><span class="line">				res = <span class="built_in">append</span>(res, []<span class="keyword">int</span>&#123;nums[index], nums[left], nums[right]&#125;)</span><br><span class="line">				left += <span class="number">1</span></span><br><span class="line">				right -= <span class="number">1</span> <span class="comment">// å…ˆç§»åŠ¨ å·¦å³æŒ‡é’ˆï¼Œé¿å…å‡ºç°ä¸‹é¢ä¸¤ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³çš„æƒ…å†µ, å½“æ—¶è¸©å‘äº†ï¼Œæ™ºå•†å ªå¿§</span></span><br><span class="line">				<span class="keyword">for</span> left &lt; right &amp;&amp; nums[left<span class="number">-1</span>] == nums[left] &#123; <span class="comment">// è¿™é‡Œæ˜¯æŠŠé‡å¤çš„æ•° ç›´æ¥å¿½ç•¥æ‰</span></span><br><span class="line">					left += <span class="number">1</span></span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">for</span> left &lt; right &amp;&amp; nums[right+<span class="number">1</span>] == nums[right] &#123;</span><br><span class="line">					right -= <span class="number">1</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»£ç å®ç°çš„æ˜¯æ€è·¯ï¼Œæ€è·¯æœ‰äº†ä»£ç å®ç° è¿˜æåŠå¤©ï¼Œè¿™æ˜¯ç¼–ç èƒ½åŠ›çš„é—®é¢˜å—ï¼Ÿ å†™è¿‡ä¹‹å å†æ¥çœ‹è¿™ä¸ªæ€è·¯æœ‰ï¼Œä»£ç åˆè¦æåŠå¤©ï¼Œæˆ‘ç†è§£åº”è¯¥æ˜¯è§çš„å°‘äº†ã€‚</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2024/05/17/MacOsä¸‹Typoraæ°¸ä¹…ä½¿ç”¨/">MacOSæ°¸ä¹…å…è´¹ä½¿ç”¨Typora</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://shiguofu2012.github.io/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2024-05-17T13:00:00.000Z" itemprop="datePublished">2024-05-17</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/software/">software</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h3 id="Typora"><a href="#Typora" class="headerlink" title="Typora"></a>Typora</h3><p>Typoraæ˜¯ä¸€æ¬¾ Markdown ç¼–è¾‘å™¨å’Œé˜…è¯»å™¨ã€‚</p>
<p>ä¸ªäººè§‰å¾—æŒºå¥½ç”¨çš„ï¼Œå¯æ˜¯å·²ç»å¼€å¯æ”¶å‰²æ¨¡å¼ã€‚</p>
<p>è¿™é‡Œé™„ä¸Šæ¿€æ´»çš„è½¯ä»¶ä¸‹è½½åœ°å€ï¼Œä¸‹è½½çš„å¯èƒ½æ¯”è¾ƒæ…¢ï¼Œå¤§å®¶è€å¿ƒç­‰å¾….</p>
<p><a href="https://shiguofu.cn/static/upload/typora1.8.10_mac.dmg" target="_blank" rel="noopener">macç‰ˆæœ¬Typora</a></p>
<p><a href="https://shiguofu.cn/static/upload/winç³»ç»Ÿ1.8.10(é™„å¸¦æ¿€æ´»).zip" target="_blank" rel="noopener">winç³»ç»Ÿ1.8.10(é™„å¸¦æ¿€æ´»)</a></p>
<h3 id="å®‰è£…ä½¿ç”¨"><a href="#å®‰è£…ä½¿ç”¨" class="headerlink" title="å®‰è£…ä½¿ç”¨"></a>å®‰è£…ä½¿ç”¨</h3><p>ä¸‹è½½å®‰è£…å®Œæˆåï¼Œåœ¨macä¸‹ä¼šæç¤ºå¦‚ä¸‹é”™è¯¯</p>
<p><img src="https://img.alicdn.com/imgextra/i1/675448601/O1CN01B0Icei2DPJWFoUeQD_!!675448601-2-ampmedia.png" alt="img"></p>
<p>æŒ‰ç…§å¦‚ä¸‹é…ç½® â€œä»è¦æ‰“å¼€â€ å°±å¯ä»¥äº†</p>
<p><img src="https://img.alicdn.com/imgextra/i3/O1CN01ulm8ta1TkrpiA4Kpf_!!0-amp.jpg" alt="img"></p>
<p>æ‰“å¼€å å°±å¯ä»¥å¼€å¿ƒçš„ä½¿ç”¨äº†ã€‚</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/10/20/æ§åˆ¶åç¨‹(goroutine)çš„å¹¶å‘æ•°é‡/">æ§åˆ¶åç¨‹(goroutine)çš„å¹¶å‘æ•°é‡</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://shiguofu2012.github.io/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2021-10-20T08:57:16.000Z" itemprop="datePublished">2021-10-20</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/Golang/">Golang</a>, <a class="article-tag-link" href="/tags/Goroutines/">Goroutines</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h4 id="1-å¹¶å‘è¿‡é«˜å¯¼è‡´ç¨‹åºå´©æºƒ"><a href="#1-å¹¶å‘è¿‡é«˜å¯¼è‡´ç¨‹åºå´©æºƒ" class="headerlink" title="1. å¹¶å‘è¿‡é«˜å¯¼è‡´ç¨‹åºå´©æºƒ"></a>1. å¹¶å‘è¿‡é«˜å¯¼è‡´ç¨‹åºå´©æºƒ</h4><p>å…ˆçœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­  </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; math.MaxInt32; i++ &#123;</span><br><span class="line">		wg.Add(<span class="number">1</span>)</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">			<span class="keyword">defer</span> wg.Done()</span><br><span class="line">			fmt.Println(i)</span><br><span class="line">			time.Sleep(time.Second)</span><br><span class="line">		&#125;(i)</span><br><span class="line">	&#125;</span><br><span class="line">	wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªä¾‹å­è¦åˆ›å»º math.MaxInt32ä¸ªåç¨‹ï¼Œæ¯ä¸ªåç¨‹åªæ˜¯è¾“å‡ºå½“å‰çš„ç¼–å·ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œä¼šä¹±åºè¾“å‡º 0 ï½math.MaxInt32 çš„æ•°å­—ï¼Œä½†å®é™…æ‰§è¡Œä¸€æ®µæ—¶é—´å ç›´æ¥panicã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">1298211</span><br><span class="line">251117</span><br><span class="line">1297752</span><br><span class="line">panic: too many concurrent operations on a single file or socket (max 1048575)</span><br><span class="line"></span><br><span class="line">goroutine 1300064 [running]:</span><br><span class="line">internal/poll.(*fdMutex).rwlock(0xc000026120, 0x0?)</span><br><span class="line">	/usr/local/go/src/internal/poll/fd_mutex.go:147 +0x11b</span><br><span class="line">internal/poll.(*FD).writeLock(...)</span><br><span class="line">	/usr/local/go/src/internal/poll/fd_mutex.go:239</span><br><span class="line">internal/poll.(*FD).Write(0xc000026120, &#123;0xc11b3ff928, 0x8, 0x8&#125;)</span><br><span class="line">	/usr/local/go/src/internal/poll/fd_unix.go:370 +0x72</span><br><span class="line">os.(*File).write(...)</span><br><span class="line">	/usr/local/go/src/os/file_posix.go:48</span><br><span class="line">os.(*File).Write(0xc000012018, &#123;0xc11b3ff928?, 0x8, 0xc1255acf50?&#125;)</span><br><span class="line">	/usr/local/go/src/os/file.go:175 +0x65</span><br><span class="line">fmt.Fprintln(&#123;0x10c6b88, 0xc000012018&#125;, &#123;0xc1255acf90, 0x1, 0x1&#125;)</span><br><span class="line">	/usr/local/go/src/fmt/print.go:285 +0x75</span><br><span class="line">fmt.Println(...)</span><br><span class="line">	/usr/local/go/src/fmt/print.go:294</span><br><span class="line">main.main.func1(0x0?)</span><br><span class="line">	/Users/shiguofu/Documents/hw.go:16 +0x8f</span><br><span class="line">created by main.main</span><br><span class="line">	/Users/shiguofu/Documents/hw.go:14 +0x3c</span><br><span class="line">panic: too many concurrent operations on a single file or socket (max 1048575)</span><br></pre></td></tr></table></figure>

<p>æŠ¥é”™ä¿¡æ¯ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œtoo many concurrent operations on a single file or socket</p>
<p>å¯¹å•ä¸ª file/socket çš„å¹¶å‘æ“ä½œä¸ªæ•°è¶…è¿‡äº†ç³»ç»Ÿæœ€å¤§å€¼ï¼Œè¿™ä¸ªé”™è¯¯æ˜¯ç”±äºfmt.Sprintfå¼•èµ·çš„ï¼Œå®ƒå°†æ ¼å¼åŒ–æ•°æ®è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºã€‚æ ‡å‡†è¾“å‡ºåœ¨linuxç³»ç»Ÿä¸­æ˜¯æ–‡ä»¶æè¿°ç¬¦ä¸º1çš„æ–‡ä»¶ï¼Œæ ‡å‡†é”™è¯¯è¾“å‡ºæ˜¯2ï¼Œæ ‡å‡†è¾“å…¥æ˜¯0ã€‚</p>
<p>æ€»ä¹‹å°±æ˜¯ç³»ç»Ÿèµ„æºè€—å°½äº†ã€‚</p>
<p>é‚£å‡å¦‚å»æ‰fmtè¿™è¡Œè¾“å‡ºå‘¢ï¼Ÿç¨‹åºå¾ˆå¯èƒ½å°±ä¼šå› ä¸ºå†…éƒ¨ä¸è¶³è€Œè¢«è¿«é€€å‡ºï¼Œç¬”è€…å°è¯•å»æ‰è·‘å‡ºé”™è¯¯ï¼Œç”µè„‘16Gçš„ï¼Œè·‘åˆ°5Gå¤šå·²ç»å¡çš„ä¸è¡Œï¼Œ å°±å¼ºè¡Œé€€å‡ºäº†ã€‚å…¶å®ä¹Ÿå¥½ç†è§£ï¼Œæ¯ä¸ªåç¨‹çº¦å ç”¨2Kæ§ä»¶ï¼Œ1Mä¸ªåç¨‹å°±æ˜¯2Gçš„å†…å­˜ï¼Œé‚£Math.MaxInt è¯»è€…è‡ªå·±è®¡ç®—ä¸‹ã€‚</p>
<h3 id="2-å¦‚ä½•è§£å†³å‘¢"><a href="#2-å¦‚ä½•è§£å†³å‘¢" class="headerlink" title="2. å¦‚ä½•è§£å†³å‘¢"></a>2. å¦‚ä½•è§£å†³å‘¢</h3><h4 id="2-1-åˆ©ç”¨channelçš„ç¼“å†²åŒºå¤§å°æ¥æ§åˆ¶åç¨‹ä¸ªæ•°"><a href="#2-1-åˆ©ç”¨channelçš„ç¼“å†²åŒºå¤§å°æ¥æ§åˆ¶åç¨‹ä¸ªæ•°" class="headerlink" title="2.1 åˆ©ç”¨channelçš„ç¼“å†²åŒºå¤§å°æ¥æ§åˆ¶åç¨‹ä¸ªæ•°"></a>2.1 åˆ©ç”¨channelçš„ç¼“å†²åŒºå¤§å°æ¥æ§åˆ¶åç¨‹ä¸ªæ•°</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">3</span>)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">		ch &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">		wg.Add(<span class="number">1</span>)</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">			<span class="keyword">defer</span> wg.Done()</span><br><span class="line">			log.Println(i)</span><br><span class="line">			time.Sleep(time.Second)</span><br><span class="line">			&lt;-ch</span><br><span class="line">		&#125;(i)</span><br><span class="line">	&#125;</span><br><span class="line">	wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>make(chan struct{}, 3) ç¼“å†²åŒºå¤§å°ä¸º3ï¼Œæ²¡æœ‰è¢«æ¶ˆè´¹çš„æƒ…å†µä¸‹ï¼Œæœ€å¤šå‘é€3ä¸ªå°±è¢«é˜»å¡äº†</li>
<li>å¼€å¯åç¨‹å‰ å¾€é€šé“å†™å…¥æ•°æ®ï¼Œç¼“å†²åŒºæ»¡ å°±é˜»å¡äº†</li>
<li>åç¨‹ç»“æŸå æ¶ˆè´¹é€šé“æ•°æ®ï¼Œç¼“å†²åŒºå°±å¯ä»¥ç»§ç»­å†™å…¥æ•°æ®ï¼Œå°±å¯ä»¥å†åˆ›å»ºæ–°çš„åç¨‹</li>
</ul>
<p>å¦‚ä¸‹è¿›è¡Œå°è£…ï¼Œå¯ç›´æ¥åƒwaitgroupä¸€æ ·ä½¿ç”¨</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> defaultSize = <span class="number">32</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// SizeWaitGroup the struct control limit of waitgroup</span></span><br><span class="line"><span class="keyword">type</span> SizeWaitGroup <span class="keyword">struct</span> &#123;</span><br><span class="line">	buf <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;  <span class="comment">// buffer to buf the current number of goroutines</span></span><br><span class="line">	wg  sync.WaitGroup <span class="comment">// the real wait group</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewSizeWaitGroup wait group with limit</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSizeWaitGroup</span><span class="params">(size <span class="keyword">int</span>)</span> *<span class="title">SizeWaitGroup</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> size &lt;= <span class="number">0</span> &#123;</span><br><span class="line">		size = defaultSize</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;SizeWaitGroup&#123;</span><br><span class="line">		buf: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, size),</span><br><span class="line">		wg:  sync.WaitGroup&#123;&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *SizeWaitGroup)</span> <span class="title">Add</span><span class="params">()</span></span> &#123;</span><br><span class="line">	_ = c.AddWithContext(context.Background())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddWithContext</span></span><br><span class="line"><span class="comment">// blocking if the number of goroutines has been reached</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *SizeWaitGroup)</span> <span class="title">AddWithContext</span><span class="params">(ctx context.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">		<span class="keyword">return</span> ctx.Err()</span><br><span class="line">	<span class="keyword">case</span> c.buf &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;: <span class="comment">// block</span></span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	&#125;</span><br><span class="line">	c.wg.Add(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Done</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *SizeWaitGroup)</span> <span class="title">Done</span><span class="params">()</span></span> &#123;</span><br><span class="line">	&lt;-c.buf</span><br><span class="line">	c.wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Wait</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *SizeWaitGroup)</span> <span class="title">Wait</span><span class="params">()</span></span> &#123;</span><br><span class="line">	c.wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-è°ƒæ•´ç³»ç»Ÿèµ„æºä¸Šé™"><a href="#2-2-è°ƒæ•´ç³»ç»Ÿèµ„æºä¸Šé™" class="headerlink" title="2.2 è°ƒæ•´ç³»ç»Ÿèµ„æºä¸Šé™"></a>2.2 è°ƒæ•´ç³»ç»Ÿèµ„æºä¸Šé™</h4><h5 id="2-2-1-ulimit"><a href="#2-2-1-ulimit" class="headerlink" title="2.2.1 ulimit"></a>2.2.1 ulimit</h5><p>æœ‰äº›åœºæ™¯ä¸‹ï¼Œå³ä½¿æˆ‘ä»¬æœ‰æ•ˆåœ°é™åˆ¶äº†åç¨‹çš„å¹¶å‘æ•°é‡ï¼Œä½†æ˜¯ä»æ—§å‡ºç°äº†æŸä¸€ç±»èµ„æºä¸è¶³çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>too many open files</li>
<li>out of memory</li>
<li>â€¦</li>
</ul>
<p>æ“ä½œç³»ç»Ÿé€šå¸¸ä¼šé™åˆ¶åŒæ—¶æ‰“å¼€æ–‡ä»¶æ•°é‡ã€æ ˆç©ºé—´å¤§å°ç­‰ï¼Œ<code>ulimit -a</code> å¯ä»¥çœ‹åˆ°ç³»ç»Ÿå½“å‰çš„è®¾ç½®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">core file size          (blocks, -c) 0</span><br><span class="line">data seg size           (kbytes, -d) unlimited</span><br><span class="line">scheduling priority             (-e) 0</span><br><span class="line">file size               (blocks, -f) unlimited</span><br><span class="line">pending signals                 (-i) 63068</span><br><span class="line">max locked memory       (kbytes, -l) 64</span><br><span class="line">max memory size         (kbytes, -m) unlimited</span><br><span class="line">open files                      (-n) 65535</span><br><span class="line">pipe size            (512 bytes, -p) 8</span><br><span class="line">POSIX message queues     (bytes, -q) 819200</span><br><span class="line">real-time priority              (-r) 0</span><br><span class="line">stack size              (kbytes, -s) 8192</span><br><span class="line">cpu time               (seconds, -t) unlimited</span><br><span class="line">max user processes              (-u) 63068</span><br><span class="line">virtual memory          (kbytes, -v) unlimited</span><br><span class="line">file locks                      (-x) unlimited</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>ulimit -n 999999</code>ï¼Œå°†åŒæ—¶æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„æ•°é‡è°ƒæ•´ä¸º 999999 æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå…¶ä»–çš„å‚æ•°ä¹Ÿå¯ä»¥æŒ‰éœ€è°ƒæ•´ã€‚</p>
<h5 id="2-2-2-è™šæ‹Ÿå†…å­˜-virtual-memory"><a href="#2-2-2-è™šæ‹Ÿå†…å­˜-virtual-memory" class="headerlink" title="2.2.2  è™šæ‹Ÿå†…å­˜(virtual memory)"></a>2.2.2  è™šæ‹Ÿå†…å­˜(virtual memory)</h5><p>è™šæ‹Ÿå†…å­˜æ˜¯ä¸€é¡¹éå¸¸å¸¸è§çš„æŠ€æœ¯äº†ï¼Œå³åœ¨å†…å­˜ä¸è¶³æ—¶ï¼Œå°†ç£ç›˜æ˜ å°„ä¸ºå†…å­˜ä½¿ç”¨ï¼Œæ¯”å¦‚ linux ä¸‹çš„äº¤æ¢åˆ†åŒº(swap space)ã€‚</p>
<p>åœ¨linuxåˆ›å»ºäº¤æ¢åˆ†åŒº</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo fallocate -l 20G /mnt/.swapfile # åˆ›å»º 20G ç©ºæ–‡ä»¶</span><br><span class="line">sudo mkswap /mnt/.swapfile    # è½¬æ¢ä¸ºäº¤æ¢åˆ†åŒºæ–‡ä»¶</span><br><span class="line">sudo chmod 600 /mnt/.swapfile # ä¿®æ”¹æƒé™ä¸º 600</span><br><span class="line">sudo swapon /mnt/.swapfile    # æ¿€æ´»äº¤æ¢åˆ†åŒº</span><br><span class="line">free -m # æŸ¥çœ‹å½“å‰å†…å­˜ä½¿ç”¨æƒ…å†µ(åŒ…æ‹¬äº¤æ¢åˆ†åŒº)</span><br></pre></td></tr></table></figure>

<p>å…³é—­äº¤æ¢åˆ†åŒº</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo swapoff /mnt/.swapfile</span><br><span class="line">rm -rf /mnt/.swapfile</span><br></pre></td></tr></table></figure>

<p>ç£ç›˜çš„ I/O è¯»å†™æ€§èƒ½å’Œå†…å­˜æ¡ç›¸å·®æ˜¯éå¸¸å¤§çš„ï¼Œä¾‹å¦‚ DDR3 çš„å†…å­˜æ¡è¯»å†™é€Ÿç‡å¾ˆå®¹æ˜“è¾¾åˆ° 20GB/sï¼Œä½†æ˜¯ SSD å›ºæ€ç¡¬ç›˜çš„è¯»å†™æ€§èƒ½é€šå¸¸åªèƒ½è¾¾åˆ° 0.5GB/sï¼Œç›¸å·® 40å€ä¹‹å¤šã€‚å› æ­¤ï¼Œä½¿ç”¨è™šæ‹Ÿå†…å­˜æŠ€æœ¯å°†ç¡¬ç›˜æ˜ å°„ä¸ºå†…å­˜ä½¿ç”¨ï¼Œæ˜¾ç„¶ä¼šå¯¹æ€§èƒ½äº§ç”Ÿä¸€å®šçš„å½±å“ã€‚å¦‚æœåº”ç”¨ç¨‹åºåªæ˜¯åœ¨è¾ƒçŸ­çš„æ—¶é—´å†…éœ€è¦è¾ƒå¤§çš„å†…å­˜ï¼Œé‚£ä¹ˆè™šæ‹Ÿå†…å­˜èƒ½å¤Ÿæœ‰æ•ˆé¿å… <code>out of memory</code> çš„é—®é¢˜ã€‚å¦‚æœåº”ç”¨ç¨‹åºé•¿æœŸé«˜é¢‘åº¦è¯»å†™å¤§é‡å†…å­˜ï¼Œé‚£ä¹ˆè™šæ‹Ÿå†…å­˜å¯¹æ€§èƒ½çš„å½±å“å°±æ¯”è¾ƒæ˜æ˜¾äº†ã€‚</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/10/07/ESé›†ç¾¤é…ç½®ç”¨æˆ·å¯†ç /">ESé›†ç¾¤é…ç½®ç”¨æˆ·å¯†ç </a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://shiguofu2012.github.io/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2021-10-07T08:57:16.000Z" itemprop="datePublished">2021-10-07</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/ElasticSearch/">ElasticSearch</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h3 id="ElastiSearché›†ç¾¤é…ç½®ç”¨æˆ·å¯†ç "><a href="#ElastiSearché›†ç¾¤é…ç½®ç”¨æˆ·å¯†ç " class="headerlink" title="ElastiSearché›†ç¾¤é…ç½®ç”¨æˆ·å¯†ç "></a>ElastiSearché›†ç¾¤é…ç½®ç”¨æˆ·å¯†ç </h3><blockquote>
<p>ESé›†ç¾¤é…ç½®å¯åŠ¨æˆåŠŸåï¼Œé»˜è®¤æ˜¯æ²¡æœ‰å¯†ç çš„ï¼Œç»å¸¸è¢«å†…éƒ¨æ‰«å‡ºå®‰å…¨æ¼æ´ï¼Œå­˜åœ¨æ•°æ®æ³„æ¼åŠç¯¡æ”¹çš„é£é™©ã€‚</p>
</blockquote>
<h4 id="é›†ç¾¤è¯ä¹¦è®¾ç½®"><a href="#é›†ç¾¤è¯ä¹¦è®¾ç½®" class="headerlink" title="é›†ç¾¤è¯ä¹¦è®¾ç½®"></a>é›†ç¾¤è¯ä¹¦è®¾ç½®</h4><p>å¯ç”¨äº†x-packæ¨¡å—ï¼Œé‚£ä¹ˆé›†ç¾¤ä¸­çš„å„èŠ‚ç‚¹ä¹‹é—´é€šè®¯å°±å¿…é¡»å®‰å…¨è®¤è¯ã€‚ä¸ºäº†è§£å†³èŠ‚ç‚¹é—´é€šè®¯çš„è®¤è¯é—®ï¼Œæˆ‘ä»¬éœ€è¦åˆ¶ä½œè¯ä¹¦ã€‚</p>
<p>ä¸ç„¶ç›´æ¥ç”Ÿæˆå¯†ç çš„è¯ï¼Œ ä¼šæŠ¥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cause: Cluster state has not been recovered yet, cannot write to the [null]index</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch-certutil  cert</span><br></pre></td></tr></table></figure>

<p>æŒ‰ç…§æç¤ºä¸€æ­¥ä¸€æ­¥ç”Ÿæˆelastic-certificates.p12 æ–‡ä»¶ã€‚</p>
<h4 id="elasticsearch-ymlè®¾ç½®"><a href="#elasticsearch-ymlè®¾ç½®" class="headerlink" title="elasticsearch.ymlè®¾ç½®"></a>elasticsearch.ymlè®¾ç½®</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">xpack.security.enabled: true</span><br><span class="line">xpack.security.transport.ssl.enabled: true</span><br><span class="line">xpack.security.transport.ssl.keystore.type: PKCS12</span><br><span class="line">xpack.security.transport.ssl.truststore.type: PKCS12</span><br><span class="line">xpack.security.transport.ssl.verification_mode: certificate</span><br><span class="line">xpack.security.transport.ssl.keystore.path: elastic-certificates.p12</span><br><span class="line">xpack.security.transport.ssl.truststore.path: elastic-certificates.p12</span><br></pre></td></tr></table></figure>

<p>å°†ç”Ÿæˆçš„è¯ä¹¦æ”¾åœ¨esæ ¹ç›®å½•çš„configæ–‡ä»¶å¤¹ä¸‹ï¼Œå¦‚ elasticsearch/config/elastic-certificates.p12ã€‚</p>
<p>é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½è¿›è¡ŒåŒæ ·çš„é…ç½®ï¼Œé‡å¯æ‰€æœ‰èŠ‚ç‚¹ã€‚</p>
<blockquote>
<p>Elasticsearch æœ‰ä¸¤ä¸ªçº§åˆ«çš„é€šä¿¡ï¼Œä¼ è¾“é€šä¿¡å’Œ http é€šä¿¡ã€‚ ä¼ è¾“åè®®ç”¨äº Elasticsearch èŠ‚ç‚¹ä¹‹é—´çš„å†…éƒ¨é€šä¿¡ï¼Œhttp åè®®ç”¨äºå®¢æˆ·ç«¯åˆ° Elasticsearch é›†ç¾¤çš„é€šä¿¡ã€‚<br>ä¸ªäººè®¤ä¸ºä¸Šé¢åªè®¾ç½®äº†å†…éƒ¨ä¼ è¾“åè®®ç›´æ¥çš„è¯ä¹¦ï¼Œæ‰€ä»¥åªç”¨certç”Ÿæˆ ï¼Œæ²¡æœ‰caç”Ÿæˆã€‚</p>
<p>elasticsearch.ymlè®¾ç½®é‡Œé¢ä¹Ÿåªè®¾ç½®äº† xpack.security.transport.sslï¼Œ æ²¡æœ‰è®¾ç½®xpack.security.http.sslâ€¦</p>
</blockquote>
<h4 id="å¼€å§‹è®¾ç½®å¯†ç "><a href="#å¼€å§‹è®¾ç½®å¯†ç " class="headerlink" title="å¼€å§‹è®¾ç½®å¯†ç "></a>å¼€å§‹è®¾ç½®å¯†ç </h4><p>åœ¨ä»»æ„èŠ‚ç‚¹ä¸­æ‰§è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch-setup-passwords interactive</span><br></pre></td></tr></table></figure>

<p>æŒ‰ç…§æç¤ºä¸€æ­¥ä¸€æ­¥è¾“å…¥å¯†ç å³å¯è®¾ç½®æˆåŠŸã€‚</p>
<h4 id="éªŒè¯å¯†ç "><a href="#éªŒè¯å¯†ç " class="headerlink" title="éªŒè¯å¯†ç "></a>éªŒè¯å¯†ç </h4><p>ESéªŒè¯å½“ç„¶æ˜¯ç”¨curlæµ‹è¯•</p>
<p>è¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼Œè´¦å·å¯†ç æ›¿æ¢ä¸ºè‡ªå·±çš„ï¼Œæ­£ç¡®è¾“å‡ºå¦‚ä¸‹ä¿¡æ¯å³è®¾ç½®æˆåŠŸã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:9200/_cat/nodes --user elastic:xxxxx</span><br><span class="line"></span><br><span class="line">10.10.x.x 17 99 0 0.06 0.09 0.12 xxxx * es-node3</span><br><span class="line">10.10.x.x 35 99 0 0.06 0.09 0.12 xxxx - es-node2</span><br><span class="line">10.10.x.x 40 99 0 0.06 0.09 0.12 xxxx - es-node1</span><br></pre></td></tr></table></figure>

<h4 id="ESä¿®æ”¹å¯†ç "><a href="#ESä¿®æ”¹å¯†ç " class="headerlink" title="ESä¿®æ”¹å¯†ç "></a>ESä¿®æ”¹å¯†ç </h4><ol>
<li>ä½¿ç”¨curlå‘½ä»¤ä¿®æ”¹å¯†ç </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT -u elastic:xxx http://localhost:9200/_xpack/security/user/elastic/_password -H </span><br><span class="line">&quot;Content-Type: application/json&quot; -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;password&quot;: &quot;your passwd&quot;</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>å¯†ç å¿˜è®°</li>
</ol>
<p>è¿›å…¥esä»»æ„èŠ‚ç‚¹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/bin/elasticsearch-users useradd misspasswd -r superuser</span><br><span class="line">Enter new password: </span><br><span class="line">ERROR: Invalid password...passwords must be at least [6] characters long</span><br><span class="line">[root@cfeeab4bb0eb elasticsearch]# ./bin/elasticsearch-users useradd misspasswd -r superuser</span><br><span class="line">Enter new password: </span><br><span class="line">Retype new password:</span><br></pre></td></tr></table></figure>

<p>ç„¶åä½¿ç”¨æ–°å»ºçš„ç”¨æˆ·æ‰§è¡Œ1æ“ä½œå³å¯ä¿®æ”¹å¯†ç .</p>
<h4 id="es-docker-composeé…ç½®"><a href="#es-docker-composeé…ç½®" class="headerlink" title="es docker-composeé…ç½®"></a>es docker-composeé…ç½®</h4><p><a href="https://github.com/shiguofu2012/scripts/blob/master/docker-compose/es.yml" target="_blank" rel="noopener">https://github.com/shiguofu2012/scripts/blob/master/docker-compose/es.yml</a></p>
<p>è¿è¡Œå‡†å¤‡ï¼š</p>
<ol>
<li>åˆ›å»ºç›®å½•ï¼Œé…ç½®æ–‡ä»¶è¯ä¹¦æ–‡ä»¶éƒ½æ˜¯åœ¨å®¿ä¸»æœºå™¨ä¸Šçš„/root/data/es-7.5.1-{1,2,3}ç›®å½•ä¸‹</li>
<li>è¯ä¹¦æ–‡ä»¶(è¯ä¹¦ç”Ÿæˆè§ä¸Šæ–‡)/é…ç½®æ–‡ä»¶</li>
</ol>
<p>é…ç½®æ–‡ä»¶1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: test</span><br><span class="line">node.name: es-node3</span><br><span class="line"># network.bind_host: 0.0.0.0</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"># network.publish_host: elasticsearch03</span><br><span class="line">http.port: 9200</span><br><span class="line">transport.tcp.port: 9300</span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br><span class="line">node.master: true</span><br><span class="line">node.data: true  </span><br><span class="line">cluster.initial_master_nodes: [&quot;es-node1&quot;, &quot;es-node2&quot;, &quot;es-node3&quot;]</span><br><span class="line"># åŠ host</span><br><span class="line">discovery.seed_hosts: [&quot;elasticsearch01&quot;,&quot;elasticsearch03&quot;, &quot;elasticsearch02&quot;] </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xpack.security.enabled: true          </span><br><span class="line">xpack.security.transport.ssl.enabled: true</span><br><span class="line">xpack.security.transport.ssl.keystore.type: PKCS12</span><br><span class="line">xpack.security.transport.ssl.truststore.type: PKCS12                                                                                              </span><br><span class="line">xpack.security.transport.ssl.verification_mode: certificate</span><br><span class="line">xpack.security.transport.ssl.keystore.path: elastic-certificates.p12</span><br><span class="line">xpack.security.transport.ssl.truststore.path: elastic-certificates.p12</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;2.2&apos;</span><br><span class="line">services:</span><br><span class="line">  elasticsearch01:</span><br><span class="line">    image: elasticsearch:7.10.1</span><br><span class="line">    container_name: es01</span><br><span class="line">    networks:</span><br><span class="line">      - shiguofu_net</span><br><span class="line">    # environment:  æ”¾å…¥é…ç½®æ–‡ä»¶</span><br><span class="line">      # - discovery.type=single-node</span><br><span class="line">      # - xpack.security.enabled=true</span><br><span class="line">      # - xpack.license.self_generated.type=basic</span><br><span class="line">      # - xpack.security.transport.ssl.enabled=true</span><br><span class="line">    ports:</span><br><span class="line">      - 9200:9200</span><br><span class="line">      - 9201:9300</span><br><span class="line">    volumes:</span><br><span class="line">      - /root/data/es-7.5.1-1:/usr/share/elasticsearch/data</span><br><span class="line">      - /usr/local/jdk:/usr/share/elasticsearch/jdk</span><br><span class="line">      - /root/data/es-7.5.1-1/elastic-certificates.p12:/usr/share/elasticsearch/config/elastic-certificates.p12</span><br><span class="line">      - /root/data/es-7.5.1-1/es.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span><br><span class="line"></span><br><span class="line">  elasticsearch02:</span><br><span class="line">    image: elasticsearch:7.10.1</span><br><span class="line">    container_name: es02</span><br><span class="line">    networks:</span><br><span class="line">      - shiguofu_net</span><br><span class="line">    # environment: æ”¾å…¥é…ç½®æ–‡ä»¶</span><br><span class="line">      # - discovery.type=single-node</span><br><span class="line">      # - xpack.security.enabled=true</span><br><span class="line">      # - xpack.license.self_generated.type=basic</span><br><span class="line">      # - xpack.security.transport.ssl.enabled=true</span><br><span class="line">    ports:</span><br><span class="line">      - 9300:9200</span><br><span class="line">      - 9301:9300</span><br><span class="line">    volumes:</span><br><span class="line">      - /usr/local/jdk:/usr/share/elasticsearch/jdk</span><br><span class="line">      - /root/data/es-7.5.1-2:/usr/share/elasticsearch/data</span><br><span class="line">      - /root/data/es-7.5.1-2/elastic-certificates.p12:/usr/share/elasticsearch/config/elastic-certificates.p12</span><br><span class="line">      - /root/data/es-7.5.1-2/es.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span><br><span class="line">  elasticsearch03:</span><br><span class="line">    image: elasticsearch:7.10.1</span><br><span class="line">    container_name: es03</span><br><span class="line">    networks:</span><br><span class="line">      - shiguofu_net</span><br><span class="line">    # environment:  æ”¾å…¥é…ç½®æ–‡ä»¶</span><br><span class="line">      # - discovery.type=single-node</span><br><span class="line">      # - xpack.security.enabled=true</span><br><span class="line">      # - xpack.license.self_generated.type=basic</span><br><span class="line">      # - xpack.security.transport.ssl.enabled=true</span><br><span class="line">    ports:</span><br><span class="line">      - 6666:9200</span><br><span class="line">      - 6667:9300</span><br><span class="line">    volumes:</span><br><span class="line">      - /root/data/es-7.5.1-3:/usr/share/elasticsearch/data</span><br><span class="line">      - /root/data/es-7.5.1-3/elastic-certificates.p12:/usr/share/elasticsearch/config/elastic-certificates.p12</span><br><span class="line">      - /usr/local/jdk:/usr/share/elasticsearch/jdk</span><br><span class="line">      - /root/data/es-7.5.1-3/es.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  kibana:</span><br><span class="line">    image: kibana:7.10.1</span><br><span class="line">    container_name: kibana</span><br><span class="line">    links:</span><br><span class="line">      - elasticsearch01</span><br><span class="line">    networks:</span><br><span class="line">      - shiguofu_net</span><br><span class="line">    environment:</span><br><span class="line">      - ELASTICSEARCH_HOSTS=&quot;http://elasticsearch01:9200&quot;</span><br><span class="line">      - ELASTICSEARCH_USERNAME=&quot;elastic&quot;</span><br><span class="line">      - ELASTICSEARCH_PASSWORD=&quot;aeQwQKM0N0nY&quot;</span><br><span class="line">    depends_on:</span><br><span class="line">      - elasticsearch01</span><br><span class="line">    ports:</span><br><span class="line">      - 5601:5601</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  shiguofu_net:</span><br><span class="line">    driver: bridge</span><br><span class="line">    ipam:</span><br><span class="line">      config:</span><br><span class="line">        - subnet: 10.10.2.0/24</span><br></pre></td></tr></table></figure>


        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/09/20/Nginxå†…ç½®å˜é‡/">Nginx è´Ÿè½½å‡è¡¡ç®—æ³•</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://shiguofu2012.github.io/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2021-09-20T10:25:01.000Z" itemprop="datePublished">2021-09-20</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/Load-Balance/">Load Balance</a>, <a class="article-tag-link" href="/tags/Nginx/">Nginx</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h3 id="nginx-å†…ç½®å˜é‡"><a href="#nginx-å†…ç½®å˜é‡" class="headerlink" title="nginx å†…ç½®å˜é‡"></a>nginx å†…ç½®å˜é‡</h3><p>å†…ç½®å˜é‡å­˜æ”¾åœ¨ ngx_http_core_module æ¨¡å—ä¸­ï¼Œå˜é‡çš„å‘½åæ–¹å¼å’Œ apache æœåŠ¡å™¨å˜é‡æ˜¯ä¸€è‡´çš„ã€‚æ€»è€Œè¨€ä¹‹ï¼Œè¿™äº›å˜é‡ä»£è¡¨ç€å®¢æˆ·ç«¯è¯·æ±‚å¤´çš„å†…å®¹ï¼Œä¾‹å¦‚httpuseragent,http_cookie, ç­‰ç­‰ã€‚</p>
<p>ä¸‹é¢æ˜¯ nginx æ”¯æŒçš„æ‰€æœ‰å†…ç½®å˜é‡ï¼š</p>
<h4 id="arg-name"><a href="#arg-name" class="headerlink" title="$arg_name"></a><strong>$arg_name</strong></h4><p>è¿™ä¸ªå˜é‡æ˜¯è·å–é“¾æ¥ä¸­å‚æ•°åä¸º <strong>name</strong> å¯¹åº”çš„å€¼ï¼›<br> å¦‚è¯·æ±‚é“¾æ¥: <a href="https://link.ld246.com/forward?goto=http%3A%2F%2Fservice.shiguofu.cn%2Ftest%3Fname%3D100%26a%3D200" target="_blank" rel="noopener">http://service.shiguofu.cn/test?name=100&amp;a=200</a><br> argnâ€‹ame=â€²100â€²,arg_a = â€˜200â€™</p>
<h4 id="args"><a href="#args" class="headerlink" title="$args"></a>$args</h4><p>è¿™ä¸ªå˜é‡è·å–é“¾æ¥ä¸­æ‰€æœ‰çš„å‚æ•°ï¼Œå³é“¾æ¥é—®å·åé¢çš„æ‰€æœ‰çš„ä¸œè¥¿ï¼›<br> å¦‚ï¼š<a href="https://link.ld246.com/forward?goto=http%3A%2F%2Fservice.shiguofu.cn%2Ftest%3Fname%3D100%26a%3D200" target="_blank" rel="noopener">http://service.shiguofu.cn/test?name=100&amp;a=200</a><br> $args = â€˜name=100&amp;a=200â€™</p>
<h4 id="binary-remote-addr"><a href="#binary-remote-addr" class="headerlink" title="$binary_remote_addr"></a><strong>$binary_remote_addr</strong></h4><p>å®¢æˆ·ç«¯çš„äºŒè¿›åˆ¶çš„ ip åœ°å€ï¼›</p>
<h4 id="body-bytes-sent"><a href="#body-bytes-sent" class="headerlink" title="$body_bytes_sent"></a><strong>$body_bytes_sent</strong></h4><p>ä¼ è¾“ç»™å®¢æˆ·ç«¯çš„å­—èŠ‚æ•°ï¼Œå“åº”å¤´ä¸è®¡ç®—åœ¨å†…ï¼›</p>
<h4 id="bytes-sent"><a href="#bytes-sent" class="headerlink" title="$bytes_sent"></a><strong>$bytes_sent</strong></h4><p>nginx è¿”å›ç»™å®¢æˆ·ç«¯çš„å­—èŠ‚æ•°ï¼ŒåŒ…æ‹¬å“åº”å¤´å’Œå“åº”ä½“;</p>
<h4 id="connection"><a href="#connection" class="headerlink" title="$connection"></a><strong>$connection</strong></h4><p>TCP è¿æ¥çš„åºåˆ—å·ï¼Œå¹¶ä¸æ˜¯ä¸€æ¬¡ http è¯·æ±‚å°±ä¼šæ›´æ»‘ä¸€ä¸ªåºåˆ—å·ï¼Œhttp æœ‰ keep-alive æœºåˆ¶ï¼Œä¸€ä¸ªåºåˆ—å·ä¼šç»´æŒ</p>
<h4 id="connection-requests"><a href="#connection-requests" class="headerlink" title="connection_requests"></a><strong>connection_requests</strong></h4><p>TCP è¿æ¥å½“å‰çš„è¯·æ±‚æ•°é‡ï¼ŒæœåŠ¡å¤„ç†è¯·æ±‚çš„ä¸ªæ•°ï¼Œé‡å¯åé‡ç½®ä¸º 0</p>
<h4 id="content-length"><a href="#content-length" class="headerlink" title="$content_length"></a><strong>$content_length</strong></h4><p>â€œContent-Lengthâ€ è¯·æ±‚å¤´å­—æ®µï¼Œ å®¢æˆ·ç«¯è¯·æ±‚çš„å¤´éƒ¨ä¸­çš„ content-length å€¼ï¼›</p>
<h4 id="content-type"><a href="#content-type" class="headerlink" title="$content_type"></a><strong>$content_type</strong></h4><p>â€œContent-Typeâ€ è¯·æ±‚å¤´å­—æ®µ</p>
<h4 id="cookie-name"><a href="#cookie-name" class="headerlink" title="$cookie_name"></a><strong>$cookie_name</strong></h4><p>è·å– cookie åç§°ä¸º name çš„ cookie å€¼ï¼›<br> å¦‚ cookieï¼šPHP_VERSION: 1.0; NAME:XIAOMING;â€¦.<br> $cookie_NAME = â€˜XIAOMING</p>
<h4 id="document-root"><a href="#document-root" class="headerlink" title="document_root"></a><strong>document_root</strong></h4><p>å½“å‰è¯·æ±‚çš„æ–‡æ¡£æ ¹ç›®å½•æˆ–åˆ«å,å³é…ç½®æ–‡ä»¶ä¸­çš„ root ç›®å½•ï¼›</p>
<h4 id="document-uri"><a href="#document-uri" class="headerlink" title="$document_uri"></a><strong>$document_uri</strong></h4><p>å³è¯·æ±‚çš„ uriï¼›<br> å¦‚ï¼š<a href="https://link.ld246.com/forward?goto=http%3A%2F%2Fservice.shiguofu.cn%2Ftest%2Findex%3Fa%3D1" target="_blank" rel="noopener">http://service.shiguofu.cn/test/index?a=1</a><br> $document_uri = /test/index</p>
<h4 id="host"><a href="#host" class="headerlink" title="$host"></a><strong>$host</strong></h4><p>è¯·æ±‚çš„ hostï¼Œ ä¼˜å…ˆçº§ï¼šHTTP è¯·æ±‚è¡Œçš„ä¸»æœºå &gt; è¯·æ±‚å¤´ä¸­çš„â€HOSTâ€å­—æ®µ &gt; ç¬¦åˆè¯·æ±‚çš„æœåŠ¡å™¨å</p>
<h4 id="hostname"><a href="#hostname" class="headerlink" title="$hostname"></a><strong>$hostname</strong></h4><p>è¯·æ±‚çš„æœåŠ¡ä¸»æœºå</p>
<h4 id="http-name"><a href="#http-name" class="headerlink" title="$http_name"></a><strong>$http_name</strong></h4><p>åŒ¹é…ä»»æ„è¯·æ±‚å¤´å­—æ®µï¼› å˜é‡åä¸­çš„ååŠéƒ¨åˆ†â€œnameâ€å¯ä»¥æ›¿æ¢æˆä»»æ„è¯·æ±‚å¤´å­—æ®µï¼Œå¦‚åœ¨é…ç½®æ–‡ä»¶ä¸­éœ€è¦è·å– http è¯·æ±‚å¤´ï¼šâ€œAccept-Languageâ€ï¼Œé‚£ä¹ˆå°†â€œï¼â€æ›¿æ¢ä¸ºä¸‹åˆ’çº¿ï¼Œå¤§å†™å­—æ¯æ›¿æ¢ä¸ºå°å†™ï¼Œå½¢å¦‚ï¼š$http_accept_language å³å¯ï¼›</p>
<h4 id="https"><a href="#https" class="headerlink" title="$https"></a><strong>$https</strong></h4><p>å¦‚æœå¼€å¯äº† SSL å®‰å…¨æ¨¡å¼ï¼Œå€¼ä¸ºâ€œonâ€ï¼Œå¦åˆ™ä¸ºç©ºå­—ç¬¦ä¸²ï¼›</p>
<h4 id="is-args"><a href="#is-args" class="headerlink" title="$is_args"></a><strong>$is_args</strong></h4><p>å¦‚æœè¯·æ±‚ä¸­æœ‰å‚æ•°ï¼Œå€¼ä¸ºâ€œ?â€ï¼Œå¦åˆ™ä¸ºç©ºå­—ç¬¦ä¸²ï¼›</p>
<h4 id="msec"><a href="#msec" class="headerlink" title="$msec"></a><strong>$msec</strong></h4><p>å½“å‰çš„ Unix æ—¶é—´æˆ³ï¼›</p>
<h4 id="nginx-version"><a href="#nginx-version" class="headerlink" title="$nginx_version"></a><strong>$nginx_version</strong></h4><p>nginx ç‰ˆæœ¬ï¼›</p>
<h4 id="pid"><a href="#pid" class="headerlink" title="$pid"></a><strong>$pid</strong></h4><p>nginx è¿›ç¨‹ pid</p>
<h4 id="pipe"><a href="#pipe" class="headerlink" title="$pipe"></a><strong>$pipe</strong></h4><p>å¦‚æœè¯·æ±‚æ¥è‡ªç®¡é“é€šä¿¡ï¼Œå€¼ä¸ºâ€œpâ€ï¼Œå¦åˆ™ä¸ºâ€œ.â€</p>
<h4 id="proxy-protocol-addr"><a href="#proxy-protocol-addr" class="headerlink" title="$proxy_protocol_addr"></a><strong>$proxy_protocol_addr</strong></h4><p>è·å–ä»£ç†è®¿é—®æœåŠ¡å™¨çš„å®¢æˆ·ç«¯åœ°å€ï¼Œå¦‚æœæ˜¯ç›´æ¥è®¿é—®ï¼Œè¯¥å€¼ä¸ºç©ºå­—ç¬¦ä¸²ã€‚æœ‰äº›æ‡µæ‡‚ï¼›</p>
<h4 id="query-string"><a href="#query-string" class="headerlink" title="query_string"></a><strong>query_string</strong></h4><p>é“¾æ¥ä¸­çš„å‚æ•°åˆ—è¡¨ï¼ŒåŒ $args;</p>
<h4 id="realpath-root"><a href="#realpath-root" class="headerlink" title="$realpath_root"></a><strong>$realpath_root</strong></h4><p>å½“å‰è¯·æ±‚çš„æ–‡æ¡£æ ¹ç›®å½•æˆ–åˆ«åçš„çœŸå®è·¯å¾„ï¼Œä¼šå°†æ‰€æœ‰ç¬¦å·è¿æ¥è½¬æ¢ä¸ºçœŸå®è·¯å¾„;</p>
<h4 id="remote-addr"><a href="#remote-addr" class="headerlink" title="$remote_addr"></a><strong>$remote_addr</strong></h4><p>å®¢æˆ·ç«¯åœ°å€</p>
<h4 id="remote-port"><a href="#remote-port" class="headerlink" title="$remote_port"></a><strong>$remote_port</strong></h4><p>å®¢æˆ·ç«¯ç«¯å£</p>
<h4 id="remote-user"><a href="#remote-user" class="headerlink" title="$remote_user"></a><strong>$remote_user</strong></h4><p>ç”¨äº HTTP åŸºç¡€è®¤è¯æœåŠ¡çš„ç”¨æˆ·å;</p>
<p>####ã€€<strong>$request</strong></p>
<p>HTTP è¯·æ±‚çš„æ–¹æ³•/è·¯å¾„åŠç‰ˆæœ¬ï¼›<br> å¦‚ï¼š <a href="https://link.ld246.com/forward?goto=http%3A%2F%2Fservice.shiguofu.cn%2Ftest%2Findex" target="_blank" rel="noopener">http://service.shiguofu.cn/test/index</a><br> $request = GET /test/index HTTP/1.1</p>
<h4 id="request-body"><a href="#request-body" class="headerlink" title="$request_body"></a><strong>$request_body</strong></h4><p>å®¢æˆ·ç«¯çš„è¯·æ±‚ä¸»ä½“ï¼›post ä¸­çš„ body çš„æ•°æ®éƒ¨åˆ†</p>
<h4 id="request-completion"><a href="#request-completion" class="headerlink" title="$request_completion"></a><strong>$request_completion</strong></h4><p>å¦‚æœè¯·æ±‚æˆåŠŸï¼Œå€¼ä¸ºâ€OKâ€ï¼Œå¦‚æœè¯·æ±‚æœªå®Œæˆæˆ–è€…è¯·æ±‚ä¸æ˜¯ä¸€ä¸ªèŒƒå›´è¯·æ±‚çš„æœ€åä¸€éƒ¨åˆ†ï¼Œåˆ™ä¸ºç©ºï¼›</p>
<h4 id="request-filename"><a href="#request-filename" class="headerlink" title="request_filename"></a><strong>request_filename</strong></h4><p>å½“å‰è¿æ¥è¯·æ±‚çš„æ–‡ä»¶è·¯å¾„ï¼Œç”± root æˆ– alias æŒ‡ä»¤ä¸ URI è¯·æ±‚ç”Ÿæˆ;</p>
<h4 id="request-length"><a href="#request-length" class="headerlink" title="$request_length"></a><strong>$request_length</strong></h4><p>è¯·æ±‚çš„é•¿åº¦ (åŒ…æ‹¬è¯·æ±‚çš„åœ°å€, http è¯·æ±‚å¤´å’Œè¯·æ±‚ä¸»ä½“);</p>
<h4 id="request-method"><a href="#request-method" class="headerlink" title="$request_method"></a><strong>$request_method</strong></h4><p>HTTP è¯·æ±‚æ–¹æ³•ï¼Œé€šå¸¸ä¸ºâ€œGETâ€â€œPOSTâ€ç­‰</p>
<h4 id="request-time"><a href="#request-time" class="headerlink" title="$request_time"></a><strong>$request_time</strong></h4><p>å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ä½¿ç”¨çš„æ—¶é—´; ä»è¯»å–å®¢æˆ·ç«¯çš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¼€å§‹è®¡æ—¶ï¼›</p>
<h4 id="request-uri"><a href="#request-uri" class="headerlink" title="$request_uri"></a><strong>$request_uri</strong></h4><p>å®¢æˆ·ç«¯è¯·æ±‚çš„ uriï¼›<br> å¦‚ï¼š<a href="https://link.ld246.com/forward?goto=http%3A%2F%2Fservice.shiguofu.cn%2Ftest%2Findex%3Fa%3D1%26b%3D200" target="_blank" rel="noopener">http://service.shiguofu.cn/test/index?a=1&amp;b=200</a><br> $request_uri = /test/index?a=1&amp;b=200</p>
<h4 id="scheme"><a href="#scheme" class="headerlink" title="$scheme"></a>$scheme</h4><p>è¯·æ±‚ä½¿ç”¨çš„ Web åè®®, â€œhttpâ€ æˆ– â€œhttpsâ€</p>
<h4 id="sent-http-name"><a href="#sent-http-name" class="headerlink" title="$sent_http_name"></a>$sent_http_name</h4><p>è®¾ç½®ä»»æ„ http å“åº”å¤´å­—æ®µï¼› å˜é‡åä¸­çš„ååŠéƒ¨åˆ†â€œnameâ€å¯ä»¥æ›¿æ¢æˆä»»æ„å“åº”å¤´å­—æ®µï¼Œå¦‚éœ€è¦è®¾ç½®å“åº”å¤´ Content-lengthï¼Œé‚£ä¹ˆå°†â€œï¼â€æ›¿æ¢ä¸ºä¸‹åˆ’çº¿ï¼Œå¤§å†™å­—æ¯æ›¿æ¢ä¸ºå°å†™ï¼Œå½¢å¦‚ï¼š$sent_http_content_length 4096 å³å¯ï¼›</p>
<h4 id="server-addr"><a href="#server-addr" class="headerlink" title="$server_addr"></a><strong>$server_addr</strong></h4><p>æœåŠ¡å™¨ç«¯åœ°å€ï¼›å¦‚ ï¼š 172.27.0.15</p>
<h4 id="server-name"><a href="#server-name" class="headerlink" title="$server_name"></a><strong>$server_name</strong></h4><p>æœåŠ¡å™¨åï¼›å¦‚ service.shiguofu.cn</p>
<h4 id="server-port"><a href="#server-port" class="headerlink" title="$server_port"></a><strong>$server_port</strong></h4><p>æœåŠ¡å™¨ç«¯å£å·</p>
<h4 id="server-protocol"><a href="#server-protocol" class="headerlink" title="$server_protocol"></a><strong>$server_protocol</strong></h4><p>æœåŠ¡å™¨çš„ HTTP ç‰ˆæœ¬, é€šå¸¸ä¸º â€œHTTP/1.0â€ æˆ– â€œHTTP/1.1â€</p>
<h4 id="status"><a href="#status" class="headerlink" title="$status"></a><strong>$status</strong></h4><p>HTTP å“åº”ä»£ç </p>
<h4 id="tcpinfortt-tcpinfo-rttvar-tcpinfosndcwnd-tcpinfo-rcv-space"><a href="#tcpinfortt-tcpinfo-rttvar-tcpinfosndcwnd-tcpinfo-rcv-space" class="headerlink" title="tcpinfortt,tcpinfo_rttvar, tcpinfosndcwnd,tcpinfo_rcv_space"></a><strong>tcpinfortt,tcpinfo_rttvar, tcpinfosndcwnd,tcpinfo_rcv_space</strong></h4><p>å®¢æˆ·ç«¯ TCP è¿æ¥çš„å…·ä½“ä¿¡æ¯</p>
<h4 id="time-iso8601"><a href="#time-iso8601" class="headerlink" title="$time_iso8601"></a><strong>$time_iso8601</strong></h4><p>æœåŠ¡å™¨æ—¶é—´çš„ ISO 8610 æ ¼å¼</p>
<h4 id="time-local"><a href="#time-local" class="headerlink" title="$time_local"></a><strong>$time_local</strong></h4><p>æœåŠ¡å™¨æ—¶é—´ï¼ˆLOG Format æ ¼å¼ï¼‰</p>
<h4 id="uri"><a href="#uri" class="headerlink" title="$uri"></a><strong>$uri</strong></h4><p>è¯·æ±‚ä¸­çš„å½“å‰ URI(ä¸å¸¦è¯·æ±‚å‚æ•°ï¼Œå‚æ•°ä½äº $args)ï¼›</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/09/04/Nginxè´Ÿè½½å‡è¡¡ç®—æ³•/">Nginx è´Ÿè½½å‡è¡¡ç®—æ³•</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://shiguofu2012.github.io/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2021-09-04T07:25:01.000Z" itemprop="datePublished">2021-09-04</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/Load-Balance/">Load Balance</a>, <a class="article-tag-link" href="/tags/Nginx/">Nginx</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <br>

<blockquote>
<p>Nginx æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ HTTP å’Œåå‘ä»£ç†æœåŠ¡ï¼Œå› å®ƒçš„ç¨³å®šæ€§ã€ä¸°å¯Œçš„åŠŸèƒ½é›†ã€ç¤ºä¾‹é…ç½®æ–‡ä»¶å’Œä½ç³»ç»Ÿèµ„æºçš„æ¶ˆè€—è€Œé—»åã€‚</p>
<p>å…¶ç‰¹ç‚¹æ˜¯å æœ‰å†…å­˜å°‘ï¼Œå¹¶å‘èƒ½åŠ›å¼ºï¼Œäº‹å®ä¸Š nginx çš„å¹¶å‘èƒ½åŠ›ç¡®å®åœ¨åŒç±»å‹çš„ç½‘é¡µæœåŠ¡å™¨ä¸­è¡¨ç°è¾ƒå¥½ï¼Œä¸­å›½å¤§é™†ä½¿ç”¨ nginx ç½‘ç«™ç”¨æˆ·æœ‰ï¼šç™¾åº¦ã€äº¬ä¸œã€æ–°æµªã€ç½‘æ˜“ã€è…¾è®¯ã€æ·˜å®ç­‰ã€‚</p>
<p>å½“ Nginx ä½œä¸ºä»£ç†æœåŠ¡ï¼Œåç«¯å¯æ”¯æŒçš„åº”ç”¨ä¹Ÿæ˜¯å¤šç§ç±»å‹çš„ï¼Œæ¯”å¦‚åŸºäº python çš„ uwsgiã€php çš„ fastcgi ä»¥åŠ TCPã€HTTPã€UDP ç­‰åè®®ï¼›</p>
</blockquote>
<h2 id="1-é…ç½®-NGINX-ä»£ç†åç«¯åº”ç”¨"><a href="#1-é…ç½®-NGINX-ä»£ç†åç«¯åº”ç”¨" class="headerlink" title="1 é…ç½® NGINX ä»£ç†åç«¯åº”ç”¨"></a>1 é…ç½® NGINX ä»£ç†åç«¯åº”ç”¨</h2><h3 id="1-1-ä»£ç†-uwsgi"><a href="#1-1-ä»£ç†-uwsgi" class="headerlink" title="1.1 ä»£ç† uwsgi"></a>1.1 ä»£ç† uwsgi</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream service &#123;</span><br><span class="line">   server localhost:8888;</span><br><span class="line">   server 192.168.0.2:8889;</span><br><span class="line">   server example.shiguofu.cn:8899;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">   location /app/service&#123;</span><br><span class="line">      uwsgi_pass service;</span><br><span class="line">      include uwsgi_params;   #uwsgiå‚æ•°è¡¨ï¼Œåœ¨/etc/nginx/ç›®å½•</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šé…ç½®è¡¨ç¤ºï¼Œä¸»è¦ä½¿ç”¨ nginx çš„æŒ‡ä»¤ <strong>uwsgi_pass</strong>ï¼Œä½¿ç”¨ Nginx çš„ uwsgi æ¨¡å—å°†åŒ¹é…åˆ° location çš„è·¯å¾„è½¬å‘åˆ°æœ‰ <strong>upstream</strong> å—çº§æŒ‡ä»¤ä»£ç†çš„ uwsgi æœåŠ¡ï¼Œè¿™é‡Œé»˜è®¤æ˜¯è½®è¯¢çš„æ–¹å¼ï¼›<br> æ‰€æœ‰çš„ uwsgi æœåŠ¡åœ¨ upstream ä¸­ç”± <strong>server</strong> æŒ‡ä»¤å®Œæˆï¼Œserver æŒ‡ä»¤æ¥æ”¶ UNIX å¥—æ¥å­—ã€IP åœ°å€ã€FQDN ååŠä¸€äº›å¯é€‰å‚æ•°ï¼Œå‚æ•°ä¸‹æ–‡ä¼šæåŠï¼›</p>
<h3 id="1-2-ä»£ç†-HTTP"><a href="#1-2-ä»£ç†-HTTP" class="headerlink" title="1.2 ä»£ç† HTTP"></a>1.2 ä»£ç† HTTP</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream service &#123;</span><br><span class="line">   server localhost:8888;</span><br><span class="line">   server 192.168.0.2:8889;</span><br><span class="line">   server example.shiguofu.cn:8899;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">   location /app/service&#123;</span><br><span class="line">      proxy_pass http://service;</span><br><span class="line">      include proxy_params;      </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ Nginx çš„ <strong>porxy_pass</strong> æŒ‡ä»¤ï¼Œå°†åŒ¹é… location çš„è·¯å¾„çš„è¯·æ±‚è½¬å‘åˆ° <strong>upstream</strong> å—çº§æŒ‡ä»¤ä»£ç†çš„ HTTP æœåŠ¡ï¼ŒåŒæ ·é‡‡ç”¨è½®è¯¢çš„æ–¹å¼ï¼›<br> æ‰€æœ‰çš„ HTTP æœåŠ¡åœ¨ upstream ä¸­ç”± <strong>server</strong> æŒ‡ä»¤å®Œæˆï¼Œserver æŒ‡ä»¤æ¥æ”¶ UNIX å¥—æ¥å­—ã€IP åœ°å€ã€FQDN ååŠä¸€äº›å¯é€‰å‚æ•°ï¼Œå‚æ•°ä¸‹æ–‡ä¼šæåŠï¼›<br> ä¸åŒçš„åœ°æ–¹åœ¨äº proxy_pass è¦åŠ ä¸Š httpï¼Œå› ä¸º upstream å¹¶æ²¡æœ‰æŒ‡å®šåè®®ï¼›</p>
<h3 id="1-3-ä»£ç†-fastcgi-åè®®"><a href="#1-3-ä»£ç†-fastcgi-åè®®" class="headerlink" title="1.3 ä»£ç† fastcgi åè®®"></a>1.3 ä»£ç† fastcgi åè®®</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream service &#123;</span><br><span class="line">   server localhost:8888;</span><br><span class="line">   server 192.168.0.2:8889;</span><br><span class="line">   server example.shiguofu.cn:8899;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">   location /app/service&#123;</span><br><span class="line">      fastcgi_pass http://service;</span><br><span class="line">      include fastcgi_params;       #fastcgiå‚æ•°è¡¨ï¼Œåœ¨/etc/nginx/ç›®å½•</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ Nginx çš„ <strong>fastcgi_pass</strong> æŒ‡ä»¤ï¼Œå°†åŒ¹é… location çš„è·¯å¾„çš„è¯·æ±‚è½¬å‘åˆ° <strong>upstream</strong> å—çº§æŒ‡ä»¤ä»£ç†çš„ HTTP æœåŠ¡ï¼ŒåŒæ ·é‡‡ç”¨è½®è¯¢çš„æ–¹å¼ï¼›<br> æ‰€æœ‰çš„ fastcgi æœåŠ¡åœ¨ upstream ä¸­ç”± <strong>server</strong> æŒ‡ä»¤å®Œæˆï¼Œserver æŒ‡ä»¤æ¥æ”¶ UNIX å¥—æ¥å­—ã€IP åœ°å€ã€FQDN ååŠä¸€äº›å¯é€‰å‚æ•°ï¼Œå‚æ•°ä¸‹æ–‡ä¼šæåŠï¼›</p>
<h3 id="1-4-ä»£ç†-TCP"><a href="#1-4-ä»£ç†-TCP" class="headerlink" title="1.4 ä»£ç† TCP"></a>1.4 ä»£ç† TCP</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">   upstream mysql_backend&#123;</span><br><span class="line">      server localhost:3306;</span><br><span class="line">	   server mysql.shiguofu.cn:3306;</span><br><span class="line">   &#125;</span><br><span class="line">   server&#123;</span><br><span class="line">     listen 3307;</span><br><span class="line">     proxy_pass mysql_backend;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ Nginx çš„ <strong>stream</strong> å—æŒ‡ä»¤ï¼Œå®ƒä¸ <strong>http</strong> æŒ‡ä»¤åŒä¸€çº§åˆ«ï¼Œå†™çš„æ—¶å€™è¦æ³¨æ„ï¼Œåœ¨ ubuntu ç³»ç»Ÿä¸­ï¼Œhttp å—å†™åœ¨/etc/nginx/nginx.conf ä¸­ï¼›å› æ­¤ç¬”è€…å½“æ—¶åœ¨/etc/nginx/nginx.conf ä¸­æ·»åŠ çš„è¿™æ®µé…ç½®ï¼›</p>
<p>è®¿é—®æœåŠ¡å™¨çš„ 3307 ç«¯å£ï¼Œæµ‹è¯• OK</p>
<blockquote>
<p>root@VM-0-15-ubuntu:/etc/nginx# mysql -h 127.0.0.1 -P 3307 -uroot -p<br>Enter password:<br>Welcome to the MySQL monitor. Commands end with ; or \g.<br>Your MySQL connection id is 27868<br>Server version: 5.7.23-0ubuntu0.16.04.1-log (Ubuntu)</p>
<p>Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</p>
<p>Oracle is a registered trademark of Oracle Corporation and/or its<br>affiliates. Other names may be trademarks of their respective<br>owners.</p>
<p>Type â€˜help;â€™ or â€˜\hâ€™ for help. Type â€˜\câ€™ to clear the current input statement.</p>
<p>mysql&gt;</p>
</blockquote>
<h2 id="2-Nginx-è´Ÿè½½å‡è¡¡"><a href="#2-Nginx-è´Ÿè½½å‡è¡¡" class="headerlink" title="2 Nginx è´Ÿè½½å‡è¡¡"></a>2 Nginx è´Ÿè½½å‡è¡¡</h2><p>Nginx èƒ½å¤Ÿå¹¿æ³›ä½¿ç”¨ï¼Œä¸ä»…æ˜¯å› ä¸ºå®ƒå¯ä»¥ä½œä¸ºä»£ç†æœåŠ¡ï¼Œå®ƒè¿˜æä¾›äº†é€‚åº”äºä¸åŒä¸šåŠ¡çš„è´Ÿè½½å‡è¡¡ç®—æ³•ä»¥åŠåˆ¤æ–­ç›®æ ‡æœåŠ¡çš„å¯ç”¨æ€§ç­‰å¼ºå¤§çš„åŠŸèƒ½ï¼›</p>
<h3 id="2-1-è½®è¯¢ç®—æ³•"><a href="#2-1-è½®è¯¢ç®—æ³•" class="headerlink" title="2.1 è½®è¯¢ç®—æ³•"></a>2.1 è½®è¯¢ç®—æ³•</h3><p>æœ€ç®€å•çš„ç®—æ³•ï¼Œä¹Ÿæ˜¯ Nginx é»˜è®¤çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼›</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream service &#123;</span><br><span class="line">   server localhost:8888 weight=1 max_fails=3 fail_timeout=30;</span><br><span class="line">   server 192.168.0.2:8889 weight=2;</span><br><span class="line">   server tbk.shiguofu.cn:80 backup;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">   location /app/service&#123;</span><br><span class="line">      proxy_pass http://service;</span><br><span class="line">      include proxy_params;      </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šé…ç½®æ˜¯åœ¨è½®è¯¢çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†æƒé‡çš„é…ç½®ï¼Œåœ¨ä¸Šé¢ç¤ºä¾‹ä¸­ï¼ŒNginx ä¼šå°†ä¸‰ä¸ªè¯·æ±‚ä¸­çš„ä¸¤ä¸ªåˆ†å‘åˆ° 8889 ç«¯å£å¯¹åº”çš„æœåŠ¡ï¼Œå°†å¦ä¸€ä¸ªè¯·æ±‚åˆ†å‘åˆ°æœ¬åœ°çš„ 8888 ç«¯å£çš„æœåŠ¡ï¼Œå¹¶å°†å°† tbk.shiguofu.cn ä¸Šçš„æœåŠ¡ä½œä¸ºå¤‡ç”¨ï¼Œå½“åˆ†å‘è¯·æ±‚å¤±è´¥ä¼šå¯ç”¨å¤‡ä»½æœåŠ¡ï¼›</p>
<ol>
<li>ä½¿ç”¨ Nginx çš„æŒ‡ä»¤ <strong>weight</strong> æŒ‡ä»¤ä¸ºè½®è¯¢çš„ service é…ç½®æƒé‡ï¼›</li>
<li>max_fails ä¸ fail_timtou ä¸ºæœåŠ¡çš„é«˜å¯ç”¨é…ç½®ï¼›è¡¨ç¤ºåœ¨ 30 ç§’å†…å¦‚æœæœ‰ 3 ä¸ªå¤±è´¥çš„è¯·æ±‚ï¼Œåˆ™è®¤ä¸ºè¯¥æœåŠ¡å·²ç»å®•æ‰ï¼Œåœ¨è¿™ 30 ç§’ç»“æŸä¹‹å‰ä¸ä¼šæœ‰æ–°çš„è¯·æ±‚ä¼šå‘é€åˆ°å¯¹åº”çš„æœåŠ¡ä¸Šï¼›ç­‰è¿™ 30 ç§’ç»“æŸåï¼ŒNginx ä¼šå°è¯•å‘é€ä¸€ä¸ªæ–°çš„è¯·æ±‚åˆ°è¯¥æœåŠ¡ï¼Œå¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œåˆ™ç­‰å¾… 30 ç§’â€¦ä»¥æ­¤å¾ªç¯ï¼›</li>
</ol>
<h3 id="2-2-æœ€å°‘è¿æ¥æ•°"><a href="#2-2-æœ€å°‘è¿æ¥æ•°" class="headerlink" title="2.2 æœ€å°‘è¿æ¥æ•°"></a>2.2 æœ€å°‘è¿æ¥æ•°</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream service &#123;</span><br><span class="line">   least_conn;</span><br><span class="line">   server localhost:8888;</span><br><span class="line">   server 192.168.0.2:8889;</span><br><span class="line">   server tbk.shiguofu.cn:80;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ <strong>least_conn</strong> æŒ‡ä»¤ä¸ºæ‰€è´Ÿè½½çš„åº”ç”¨æœåŠ¡æŒ‡å®šé‡‡ç”¨æœ€å°‘è¿æ¥æ•°è´Ÿè½½å‡è¡¡ï¼›<br> å®ƒä¼šå°†è®¿é—®è¯·æ±‚åˆ†å‘åˆ° upstream æ‰€ä»£ç†çš„æœåŠ¡ä¸­ï¼Œå½“å‰æ‰“å¼€è¿æ¥æ•°æœ€å°‘çš„åº”ç”¨æœåŠ¡å™¨ï¼›å®ƒåŒæ—¶æ”¯æŒè½®è¯¢ä¸­çš„ weightã€max_failsã€fail_timeout é€‰é¡¹ï¼Œæ¥å†³å®šç»™æ€§èƒ½æ›´å¥½çš„åº”ç”¨æœåŠ¡å™¨åˆ†é…æ›´å¤šçš„è®¿é—®è¯·æ±‚ï¼›</p>
<h3 id="2-3-æœ€çŸ­å“åº”æ—¶é—´"><a href="#2-3-æœ€çŸ­å“åº”æ—¶é—´" class="headerlink" title="2.3 æœ€çŸ­å“åº”æ—¶é—´"></a>2.3 æœ€çŸ­å“åº”æ—¶é—´</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream service &#123;</span><br><span class="line">   least_time;</span><br><span class="line">   server localhost:8888;</span><br><span class="line">   server 192.168.0.2:8889;</span><br><span class="line">   server tbk.shiguofu.cn:80;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥æŒ‡ä»¤ <strong>least_time</strong> ä»…ä»…åœ¨ NGINX PLUS ç‰ˆæœ¬ä¸­æ”¯æŒï¼Œä¸å¤šè¯´ã€‚</p>
<h3 id="2-4-æ•£åˆ—ç®—æ³•"><a href="#2-4-æ•£åˆ—ç®—æ³•" class="headerlink" title="2.4 æ•£åˆ—ç®—æ³•"></a>2.4 æ•£åˆ—ç®—æ³•</h3><p>åˆ†ä¸ºé€šç”¨æ•£åˆ—ç®—æ³•ä¸ ip æ•£åˆ—ç®—æ³•ï¼›</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream service &#123;</span><br><span class="line">   hash $host;</span><br><span class="line">   server localhost:8888;</span><br><span class="line">   server 192.168.0.2:8889;</span><br><span class="line">   server tbk.shiguofu.cn:80;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ <strong>hash</strong> æŒ‡ä»¤å®ç°ï¼Œæ ¹æ®è¯·æ±‚æˆ–è¿è¡Œæ—¶æä¾›çš„æ–‡æœ¬ã€å˜é‡æˆ–è€…å…¶ä»–å˜é‡çš„ç»„åˆç”Ÿæˆæ•£åˆ—å€¼ï¼›<br> ä¸€èˆ¬æƒ…å†µï¼Œ åœ¨éœ€è¦å¯¹è®¿é—®è¯·æ±‚è¿›è¡Œè´Ÿè½½å¯æ§ï¼Œæˆ–å°†è®¿é—®è¯·æ±‚è´Ÿè½½åˆ°å·²ç»æœ‰æ•°æ®ç¼“å­˜çš„åº”ç”¨æœåŠ¡çš„åœºæ™¯ä¸‹ï¼Œè¯¥ç®—æ³•ä¼šéå¸¸æœ‰ç”¨ï¼›<br> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ upstream ä¸­æœ‰åº”ç”¨æœåŠ¡çš„åŠ å…¥æˆ–è€…åˆ é™¤æ—¶ï¼Œä¼šé‡æ–°è®¡ç®—æ•£åˆ—å€¼è¿›è¡Œåˆ†å‘ï¼›</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream service &#123;</span><br><span class="line">   ip_hash;</span><br><span class="line">   server localhost:8888;</span><br><span class="line">   server 192.168.0.2:8889;</span><br><span class="line">   server tbk.shiguofu.cn:80;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æŒ‡ä»¤ <strong>ip_hash</strong> å®ç°ï¼Œé€šè¿‡è®¡ç®—å®¢æœç«¯çš„ ip åœ°å€æ¥ç”Ÿæˆæ•£åˆ—å€¼ã€‚</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/08/03/Goroutine åœ¨é¡¹ç›®ä¸­çš„å®è·µ/">Goroutine åœ¨é¡¹ç›®ä¸­çš„å®è·µ</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://shiguofu2012.github.io/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2021-08-03T15:00:00.000Z" itemprop="datePublished">2021-08-03</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/Golang/">Golang</a>, <a class="article-tag-link" href="/tags/Goroutines/">Goroutines</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h3 id="Goroutine-åœ¨é¡¹ç›®ä¸­çš„å®è·µ"><a href="#Goroutine-åœ¨é¡¹ç›®ä¸­çš„å®è·µ" class="headerlink" title="Goroutine åœ¨é¡¹ç›®ä¸­çš„å®è·µ"></a>Goroutine åœ¨é¡¹ç›®ä¸­çš„å®è·µ</h3><blockquote>
<p>Goroutine æ˜¯Golangè¯­è¨€çš„ä¸€å¤§ç‰¹è‰²ï¼ŒGoroutineçš„å‡ºç°ï¼Œä½¿å¾—å¹¶å‘å¾—åˆ°å¤§å¹…æå‡ã€‚æˆ‘ä»¬ä¸€èµ·çœ‹ä¸‹Goroutineåœ¨é¡¹ç›®ä¸­çš„å®è·µã€‚</p>
</blockquote>
<h4 id="Goroutineå¹¶å‘æ§åˆ¶"><a href="#Goroutineå¹¶å‘æ§åˆ¶" class="headerlink" title="Goroutineå¹¶å‘æ§åˆ¶"></a>Goroutineå¹¶å‘æ§åˆ¶</h4><p>åœ¨ä¸šåŠ¡å¼€å‘ä¸­ï¼Œä¼šç¢°åˆ°å‡ ä¸ªç›¸äº’ç‹¬ç«‹çš„è€—æ—¶æ“ä½œï¼Œå¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œè¿™ä¸ªæ—¶å€™Goroutineæ˜¯å¾ˆæ–¹ä¾¿æ´¾ä¸Šç”¨åœºçš„ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// someOperation your work to do</span></span><br><span class="line"><span class="comment">// if we have some data to return use channel to pass data</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">someOperation</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// anotherOperation</span></span><br><span class="line"><span class="comment">// another work indenpendent with someOperation</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">anotherOperation</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bizFunc</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  wg := sync.WaitGroup&#123;&#125;  <span class="comment">// sync.WatiGroup to sync goroutine</span></span><br><span class="line">  wg.Add(<span class="number">2</span>) <span class="comment">// we have 2 operation to do, so we add 2</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    err := someOperation()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="comment">// whatever handler</span></span><br><span class="line">    &#125;</span><br><span class="line">    wg.Done()</span><br><span class="line">  &#125;()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">    err := anotherOperation()</span><br><span class="line">    wg.Done()</span><br><span class="line">  &#125;()</span><br><span class="line">  wg.Wait() <span class="comment">// wait all goroutine to return</span></span><br><span class="line">  <span class="comment">// other operation depend on the two before</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Gorotine-æœ€å¤§ä¸ªæ•°"><a href="#Gorotine-æœ€å¤§ä¸ªæ•°" class="headerlink" title="Gorotine æœ€å¤§ä¸ªæ•°"></a>Gorotine æœ€å¤§ä¸ªæ•°</h4><p>ä¸Šé¢çš„æ¡ˆä¾‹éœ€è¦æˆ‘ä»¬çŸ¥é“åç¨‹çš„æ•°é‡ï¼Œç„¶åç­‰å¾…æ‰€æœ‰åç¨‹ç»“æŸï¼Œé‚£å¦‚æœæˆ‘ä»¬ä¸ç¡®å®šåç¨‹çš„ä¸ªæ•°æˆ–è€…æˆ‘ä»¬éœ€è¦è®¾ç½®å›ºå®šä¸ªæ•°çš„åç¨‹ï¼Œè¯¥å¦‚ä½•åšå‘¢ï¼Ÿ</p>
<p>å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œåˆ©ç”¨channelçš„é˜»å¡ç‰¹æ€§ï¼Œåˆ›å»ºä¸€ä¸ªå›ºå®šé•¿åº¦çš„channelï¼Œåˆ›å»ºä¸€ä¸ªåç¨‹ï¼Œåœ¨channelä¸­å†™å…¥ä¸€æ¡æ•°æ®ï¼Œå½“channelè¢«å¡«æ»¡åï¼Œå°±ä¼šé˜»å¡ï¼›åç¨‹ç»“æŸåï¼Œä»channleä¸­æ¶ˆè´¹ä¸€æ¡æ•°æ®ï¼Œåç¨‹å°±åˆå¯ä»¥å†™å…¥æ•°æ®ï¼Œå¦‚æ­¤å¯å›ºå®šåç¨‹çš„æ•°é‡ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wrapped for wait group</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> defaultSize = <span class="number">32</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// SizeWaitGroup the struct control limit of waitgroup</span></span><br><span class="line"><span class="keyword">type</span> SizeWaitGroup <span class="keyword">struct</span> &#123;</span><br><span class="line">	buf <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;  <span class="comment">// buffer to buf the current number of goroutines</span></span><br><span class="line">	wg  sync.WaitGroup <span class="comment">// the real wait group</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewSizeWaitGroup wait group with limit</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSizeWaitGroup</span><span class="params">(size <span class="keyword">int</span>)</span> *<span class="title">SizeWaitGroup</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> size &lt;= <span class="number">0</span> &#123;</span><br><span class="line">		size = defaultSize</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;SizeWaitGroup&#123;</span><br><span class="line">		buf: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, size), <span class="comment">// init the size of channel</span></span><br><span class="line">		wg:  sync.WaitGroup&#123;&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *SizeWaitGroup)</span> <span class="title">Add</span><span class="params">()</span></span> &#123;</span><br><span class="line">	_ = c.AddWithContext(context.Background())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddWithContext</span></span><br><span class="line"><span class="comment">// blocking if the number of goroutines has been reached</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *SizeWaitGroup)</span> <span class="title">AddWithContext</span><span class="params">(ctx context.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> &lt;-ctx.Done():   <span class="comment">// parent goroutines call canceled or timedout or other happend</span></span><br><span class="line">		<span class="keyword">return</span> ctx.Err()</span><br><span class="line">	<span class="keyword">case</span> c.buf &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;: <span class="comment">// block if channel is full</span></span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	&#125;</span><br><span class="line">	c.wg.Add(<span class="number">1</span>) <span class="comment">// we created a goroutine</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Done</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *SizeWaitGroup)</span> <span class="title">Done</span><span class="params">()</span></span> &#123;</span><br><span class="line">	&lt;-c.buf  <span class="comment">// a goroutine finished</span></span><br><span class="line">	c.wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Wait</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *SizeWaitGroup)</span> <span class="title">Wait</span><span class="params">()</span></span> &#123;</span><br><span class="line">	c.wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚ä¸Šä»£ç æ‰€ç¤ºï¼Œåˆ›å»ºä¸€ä¸ªå›ºå®šé•¿åº¦çš„channelï¼Œæ·»åŠ åç¨‹ä¹‹å‰å…ˆå¾€é˜Ÿåˆ—é‡Œå¢åŠ ä¸€ä¸ªå ä½ç¬¦(struct{} ç»“æ„ä¸å ç”¨å†…å­˜ï¼Œåç¨‹æ•°é‡å¤§æ—¶ä¸ä¼šå¤ªå ç”¨å†…å­˜)ï¼Œç„¶åå†è°ƒç”¨çœŸæ­£çš„WaitGroupå¢åŠ åç¨‹æ§åˆ¶ï¼Œæ‰§è¡Œå®Œæˆåè°ƒç”¨Doneæ–¹æ³•ï¼Œä»é˜Ÿåˆ—ä¸­å–å‡ºå ä½ç¬¦è°ƒç”¨çœŸæ­£çš„WaitGroupçš„Doneå‡½æ•°ã€‚</p>
<p>è°ƒç”¨å¦‚ä¸‹:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">swg := NewSizeWaitGroup(<span class="number">128</span>)</span><br><span class="line"><span class="keyword">for</span> index := <span class="number">0</span>; index &lt; <span class="number">1000</span>; index += <span class="number">1</span> &#123;</span><br><span class="line">  swg.Add()</span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// do what you want</span></span><br><span class="line">    swg.Done()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">swg.Wait()</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·ï¼Œåç¨‹çš„æœ€å¤§æ•°é‡ä¼šä¿æŒåœ¨128ä¸ªã€‚</p>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>Golangæä¾›çš„channelä¸Goroutine æä¾›å¾ˆæ–¹ä¾¿çš„é€šä¿¡ä¸å¹¶å‘åŠŸèƒ½ï¼Œåœ¨å®é™…çš„ä¸šåŠ¡å¼€å‘ä¸­ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿è®²ç›¸äº’ç‹¬ç«‹çš„åŠŸèƒ½å¹¶å‘å¤„ç†ï¼Œæé«˜ç³»ç»Ÿçš„ååé‡ã€‚</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/07/15/MySQLæ¨¡ç³ŠæŸ¥æ‰¾/">Mysqlæ¨¡ç³ŠæŸ¥æ‰¾</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://shiguofu2012.github.io/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2021-07-15T03:08:51.000Z" itemprop="datePublished">2021-07-15</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/Mysql/">Mysql</a>, <a class="article-tag-link" href="/tags/service/">service</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h3 id="Mysqlæ¨¡ç³ŠæŸ¥æ‰¾"><a href="#Mysqlæ¨¡ç³ŠæŸ¥æ‰¾" class="headerlink" title="Mysqlæ¨¡ç³ŠæŸ¥æ‰¾"></a>Mysqlæ¨¡ç³ŠæŸ¥æ‰¾</h3><blockquote>
<p>åœ¨ä¸šåŠ¡å¼€å‘è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šç¢°åˆ°éœ€è¦æœç´¢çš„éœ€æ±‚ï¼›ç»“åˆmsyqlåœ¨æ¨¡ç³Šæœç´¢çš„æ—¶å€™ï¼Œå¾ˆæ˜æ˜¾ä¼šç”¨åˆ°likeè¯­å¥ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨æ•°æ®é‡æ¯”è¾ƒå°çš„æ—¶å€™ï¼ŒæŒ‰è¡Œæ£€ç´¢çš„æ•ˆç‡ä¹Ÿä¸æ˜¯å¾ˆæ˜æ˜¾çš„ä½æ•ˆï¼Œä½†å½“è¾¾åˆ°ç™¾ä¸‡çº§ï¼Œåƒä¸‡çº§æ•°æ®é‡çš„æ—¶å€™ï¼ŒæŸ¥è¯¢çš„æ•ˆç‡ä½ä¸‹æ˜¯ä¸€å›äº‹ï¼Œå¾ˆå¯èƒ½æŠŠæ•°æ®åº“æ‹–å®ï¼Œä¸¥é‡å½±å“å¯ç”¨æ€§ã€‚è¿™ä¸ªæ—¶å€™æé«˜æŸ¥è¯¢æ•ˆç‡å°±æ˜¾å¾—å¾ˆé‡è¦ï¼</p>
</blockquote>
<h4 id="æ¨¡ç³ŠæŸ¥æ‰¾"><a href="#æ¨¡ç³ŠæŸ¥æ‰¾" class="headerlink" title="æ¨¡ç³ŠæŸ¥æ‰¾"></a>æ¨¡ç³ŠæŸ¥æ‰¾</h4><p>ä¸€èˆ¬æƒ…å†µï¼Œæˆ‘ä»¬åœ¨æŸ¥æ‰¾æ—¶å€™çš„å†™æ³•(fieldè‚¯å®šæ˜¯å·²ç»å»ºäº†ç´¢å¼•):</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">`column`</span> <span class="keyword">FROM</span> <span class="string">`table`</span> <span class="keyword">WHERE</span> <span class="string">`field`</span> <span class="keyword">like</span> <span class="string">'%keyword%'</span>;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„è¯­å¥ç”¨explainè§£é‡Šæ¥çœ‹ï¼ŒSQLè¯­å¥å¹¶æœªä½¿ç”¨ç´¢å¼•ï¼Œè€Œæ˜¯å…¨è¡¨æ‰«æï¼Œæ•°æ®é‡æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œè¿™æ•ˆç‡å¯æƒ³è€ŒçŸ¥ã€‚</p>
<p>å¯¹æ¯”ä¸‹é¢çš„å†™æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT `column` FROM `table` WHERE `field` like &apos;keyword%&apos;;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·çš„å†™æ³•ç”¨explainè§£é‡Šçœ‹åˆ°ï¼ŒSQLè¯­å¥ä½¿ç”¨äº†ç´¢å¼•ï¼Œæœç´¢çš„æ•ˆç‡å¤§å¤§çš„æé«˜äº†ã€‚</p>
<p>ä½†æ˜¯æœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨åšåŠŸèƒ½éœ€æ±‚çš„æ—¶å€™ï¼Œå¹¶éè¦æƒ³æŸ¥è¯¢çš„å…³é”®è¯éƒ½åœ¨å¼€å¤´ï¼Œæ‰€ä»¥å¦‚æœä¸æ˜¯ç‰¹åˆ«çš„è¦æ±‚ï¼Œâ€keywork%â€å¹¶ä¸èƒ½é€‚åº”æ‰€æœ‰çš„æŸ¥æ‰¾ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦å¦ä¸€ç§æ–¹æ³•ã€‚</p>
<h4 id="LOCATEï¼ˆâ€™substrâ€™-str-start-posï¼‰"><a href="#LOCATEï¼ˆâ€™substrâ€™-str-start-posï¼‰" class="headerlink" title="LOCATEï¼ˆâ€™substrâ€™,str,start_posï¼‰"></a>LOCATEï¼ˆâ€™substrâ€™,str,start_posï¼‰</h4><p>Mysqlæä¾›LOCATEå‡½æ•°ï¼Œè¯¥æ–¹æ³•è¿”å›æŸ¥è¯¢å­—ç¬¦ä¸²åœ¨è¢«æŸ¥è¯¢å­—æ®µä¸‹çš„ç´¢å¼•ã€‚ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºè¦æŸ¥è¯¢çš„å­—ç¬¦ä¸²ï¼Œç¬¬äºŒä¸ªä¸ºæ•°æ®åº“ä¸­çš„å­—æ®µåç§°ï¼Œç¬¬ä¸‰ä¸ªä»£è¡¨ä»å­—æ®µå¯¹åº”çš„å€¼çš„ç¬¬å‡ ä¸ªå­—ç¬¦ä¸²å¼€å§‹æŸ¥æ‰¾.</p>
<p>ä¾‹ï¼Œ æœ‰å¦‚ä¸‹è¡¨ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`meetings`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`des`</span> <span class="built_in">varchar</span>(<span class="number">225</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸‹sqlåˆ™æŸ¥è¯¢deså­—æ®µåŒ¹é…â€œhelloâ€çš„è¡Œæ•°ã€‚è¿™ä¸ªâ€œhelloâ€ åœ¨desä¸­çš„å¯ä»¥æ˜¯å¼€å¤´ï¼Œå¯ä»¥æ˜¯ç»“å°¾ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸­é—´ï¼Œéå¸¸æ–¹ä¾¿ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> meetings <span class="keyword">where</span> <span class="keyword">LOCATE</span>(<span class="string">'hello'</span>,<span class="string">`des`</span>) &gt; <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>LOCTATEè¿™ä¸ªå‡½æ•°æœ‰ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œæ˜¯æŸ¥æ‰¾çš„èµ·å§‹ä½ç½®ï¼Œæ¯”å¦‚å¯ä»¥åœ¨ä¸Šé¢çš„sqlä¸­åŠ å…¥ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> meetings <span class="keyword">where</span> <span class="keyword">LOCATE</span>(<span class="string">'hello'</span>,<span class="string">`des`</span>, <span class="number">5</span>) &gt; <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä½¿ç”¨explainæ¥æ£€æŸ¥æ‰§è¡Œæ˜¯å¦å‘½ä¸­ç´¢å¼•ï¼Œä¼šå‘ç°å¯¹æœç´¢çš„å­—æ®µå¦‚æœå­˜åœ¨ç´¢å¼•ï¼Œç¡®å®å¯ä»¥å‘½ä¸­ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain SELECT * from meetings where LOCATE('hello',`des`) &gt; 0\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: meetings</span><br><span class="line">   partitions: NULL</span><br><span class="line">         type: index</span><br><span class="line">possible_keys: NULL</span><br><span class="line">          key: des_meeting</span><br><span class="line">      key_len: 227</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 3</span><br><span class="line">     filtered: 100.00</span><br><span class="line">        Extra: Using where; Using index</span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>å¦‚ä¸Šexplainçš„è¾“å‡ºè¯­å¥ï¼Œç¡®å®ä½¿ç”¨äº†ç´¢å¼•ã€‚</p>
<h4 id="POSITION-â€˜substrâ€™-IN-field"><a href="#POSITION-â€˜substrâ€™-IN-field" class="headerlink" title="POSITION(â€˜substrâ€™ IN field)"></a>POSITION(â€˜substrâ€™ IN <code>field</code>)</h4><p>positionå¯ä»¥çœ‹åšæ˜¯locateçš„åˆ«åï¼ŒåŠŸèƒ½è·Ÿlocateä¸€æ ·ã€‚å…¶å®ä¸ªäººç†è§£ï¼Œpositionåªæ˜¯æŸ¥æ‰¾æ˜¯å¦åŒ…å«å­ä¸²ï¼Œä¸èƒ½æŒ‡å®šä½ç½®å¼€å§‹ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> meetings <span class="keyword">where</span> <span class="keyword">POSITION</span>(<span class="string">'hello'</span> <span class="keyword">in</span> <span class="string">`des`</span>);</span><br></pre></td></tr></table></figure>

<h4 id="INSTR-str-â€™substrâ€™"><a href="#INSTR-str-â€™substrâ€™" class="headerlink" title="INSTR(str,â€™substrâ€™)"></a>INSTR(<code>str</code>,â€™substrâ€™)</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">`column`</span> <span class="keyword">FROM</span> <span class="string">`table`</span> <span class="keyword">WHERE</span> <span class="keyword">INSTR</span>(<span class="string">`field`</span>, <span class="string">'keyword'</span> )&gt;<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªINSTRä¹Ÿæ˜¯å­ä¸²åˆ¤æ–­</p>
<h4 id="FIND-IN-SET"><a href="#FIND-IN-SET" class="headerlink" title="FIND_IN_SET"></a>FIND_IN_SET</h4><p>FIND_IN_SET(str1,str2)</p>
<p>è¿”å›str2ä¸­str1æ‰€åœ¨çš„ä½ç½®ç´¢å¼•ï¼Œå…¶ä¸­str2å¿…é¡»ä»¥â€,â€åˆ†å‰²å¼€ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> person <span class="keyword">WHERE</span> FIND_IN_SET(<span class="string">'apply'</span>,<span class="keyword">name</span>);</span><br></pre></td></tr></table></figure>

<p>nameçš„å†…å®¹æ˜¯ä»¥é€—å·åˆ†éš”çš„ï¼Œå¦‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apple,pear,orange</span><br></pre></td></tr></table></figure>

<p>å°±å¯ä»¥ä½¿ç”¨FIND_IN_SET</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="string">`table`</span> <span class="keyword">where</span> FIND_IN_SET(<span class="string">'apple'</span>, <span class="keyword">name</span>);</span><br></pre></td></tr></table></figure>

<p>ä¸ªäººè§‰å¾—è¿™ä¸ªä¸»è¦æ˜¯é’ˆå¯¹sqlæ•°ç»„æ•°æ®çš„æŸ¥æ‰¾; æ•°ç»„æ•°æ®ä»¥é€—å·åˆ†éš”å­˜å‚¨åˆ°ä¸€ä¸ªå­—æ®µï¼ŒFIND_IN_SETå¯ä»¥å¿«é€Ÿæ‰¾åˆ°åŒ…å«æ•°ç»„å…ƒç´ çš„è¡Œã€‚</p>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>Mysqlåœ¨è¿›è¡Œæ¨¡ç³ŠæŸ¥æ‰¾éœ€è¦æ³¨æ„ï¼Œå‰ç¼€åŒ¹é…çš„æ—¶å€™ä¼šç”¨åˆ°ç´¢å¼•ï¼Œå‰åéƒ½æ¨¡ç³Šï¼Œåˆ™æ— æ³•ä½¿ç”¨ç´¢å¼•ï¼›</p>
<p>å¯ä»¥ä½¿ç”¨Mysqlæä¾›çš„å‡½æ•°æ¥â€œæ›²çº¿æ•‘å›½â€æ¥å‘½ä¸­ç´¢å¼•ã€‚</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/04/14/Grpcæ‹¦æˆªå™¨/">Grpcæ‹¦æˆªå™¨</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://shiguofu2012.github.io/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2021-04-14T02:23:59.000Z" itemprop="datePublished">2021-04-14</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/Golang/">Golang</a>, <a class="article-tag-link" href="/tags/gRPC/">gRPC</a>, <a class="article-tag-link" href="/tags/æ‹¦æˆªå™¨/">æ‹¦æˆªå™¨</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h1 id="gRPC-æ‹¦æˆªå™¨"><a href="#gRPC-æ‹¦æˆªå™¨" class="headerlink" title="gRPC æ‹¦æˆªå™¨"></a>gRPC æ‹¦æˆªå™¨</h1><h2 id="æœåŠ¡ç«¯æ‹¦æˆªå™¨"><a href="#æœåŠ¡ç«¯æ‹¦æˆªå™¨" class="headerlink" title="æœåŠ¡ç«¯æ‹¦æˆªå™¨"></a>æœåŠ¡ç«¯æ‹¦æˆªå™¨</h2><p>grpcæ¥å£æœåŠ¡ç«¯æ‹¦æˆªå™¨ï¼Œä¸€èˆ¬ç”¨æ¥åšä¸€äº›é¢„å¤„ç†åŠåå¤„ç†æ“ä½œã€‚å¦‚ä¸‹ï¼Œä¸¾ä¸¤ä¸ªå¸¸ç”¨çš„ä¾‹å­ã€‚</p>
<ol>
<li>åœ¨å¾®æœåŠ¡ä¹‹é—´ä½¿ç”¨gRPCäº’ç›¸è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šä¼ å…¥ä¸€äº›å…¬å…±çš„ä¸ä¸šåŠ¡ä¸ç›¸å…³çš„å…ƒæ•°æ®ï¼Œè¿™äº›æ•°æ®å°±å¾ˆé€‚åˆåœ¨æ‹¦æˆªå™¨ä¸­å®ç°ã€‚</li>
</ol>
<p>å¦‚ä¸‹æœåŠ¡ç«¯çš„æ‹¦æˆªå™¨å°†gRPC clientä¼ å…¥çš„æ•°æ®æ”¾å…¥gRPCçš„contextä¸­ï¼Œæ¥å£ä¸­å°±å¯ä»¥ä½¿ç”¨ctx.Valueå»è·å–è¯¥æ•°æ®ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MetaDataInterceptor get grpc server info, requestId/traceId/LogId</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MetaServerDataInterceptor</span><span class="params">()</span> <span class="title">grpc</span>.<span class="title">UnaryServerInterceptor</span></span> &#123;</span><br><span class="line">  <span class="comment">// æ‹¦æˆªå™¨å‡½æ•°ç­¾å</span></span><br><span class="line">  <span class="comment">// @params ctx Grpc context</span></span><br><span class="line">  <span class="comment">// @params req grpc request</span></span><br><span class="line">  <span class="comment">// @params info grpc request info</span></span><br><span class="line">  <span class="comment">// @params handler the grpc method</span></span><br><span class="line">   <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context,</span></span></span><br><span class="line"><span class="function"><span class="params">      req <span class="keyword">interface</span>&#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">      info *grpc.UnaryServerInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">      handler grpc.UnaryHandler)</span> <span class="params">(resp <span class="keyword">interface</span>&#123;&#125;, err error)</span></span> &#123;</span><br><span class="line">     </span><br><span class="line">     <span class="comment">// do what you want to do</span></span><br><span class="line">     <span class="comment">// get metadata from grpc client</span></span><br><span class="line">     md, ok := metadata.FromIncomingContext(ctx)</span><br><span class="line">	   <span class="keyword">if</span> !ok &#123;</span><br><span class="line">		     md = metadata.Pairs()</span><br><span class="line">	   &#125;</span><br><span class="line">	   <span class="comment">// Set request info for context.</span></span><br><span class="line">     <span class="comment">// define your key</span></span><br><span class="line">     <span class="keyword">for</span> _, key := <span class="keyword">range</span> []<span class="keyword">string</span>&#123;<span class="string">"requestId"</span>&#125; &#123;</span><br><span class="line">		    value := md.Get(key)</span><br><span class="line">		    <span class="comment">// ignore it if not exists.</span></span><br><span class="line">		    <span class="keyword">if</span> <span class="built_in">len</span>(value) &gt;= <span class="number">1</span> &#123;</span><br><span class="line">            <span class="comment">// set value to context. you can use ctx.Value to get it from your grpc method</span></span><br><span class="line">			      ctx = context.WithValue(ctx, key, value[<span class="number">0</span>])</span><br><span class="line">		    &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// next </span></span><br><span class="line">      <span class="keyword">return</span> handler(ctx, req)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>åœ¨å®é™…çš„ç¯å¢ƒä¸­ï¼Œç»å¸¸ä¼šéœ€è¦åœ¨gRPC æ¥å£ä¹‹å‰ä¹‹ååšä¸€äº›å¤„ç†ã€‚æ¯”å¦‚ï¼Œåœ¨å¼€å§‹ä¹‹å‰è®°å½•æ—¶é—´ï¼Œæ‰§è¡Œä¹‹åè®°å½•è€—æ—¶æ“ä½œï¼›æ‰§è¡Œä¹‹ååˆ¤æ–­æ‰§è¡Œç»“æœç­‰ç­‰</li>
</ol>
<p>å¦‚ä¸‹æ‰€ç¤ºï¼Œå®ç°äº†ä¸€ä¸ªè®°å½•æ¥å£è€—æ—¶åŠŸèƒ½çš„æ‹¦æˆªå™¨ï¼Œå½“ç„¶å®é™…ä¸ä¼šè¿™ä¹ˆlowã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// API time elas time get grpc server info</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">APITimeInterceptor</span><span class="params">()</span> <span class="title">grpc</span>.<span class="title">UnaryServerInterceptor</span></span> &#123;</span><br><span class="line">  <span class="comment">// æ‹¦æˆªå™¨ç­¾å</span></span><br><span class="line">   <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context,</span></span></span><br><span class="line"><span class="function"><span class="params">      req <span class="keyword">interface</span>&#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">      info *grpc.UnaryServerInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">      handler grpc.UnaryHandler)</span> <span class="params">(resp <span class="keyword">interface</span>&#123;&#125;, err error)</span></span> &#123;</span><br><span class="line">     </span><br><span class="line">     <span class="comment">// do what you want to do</span></span><br><span class="line">     start := time.Now().UnixNano()</span><br><span class="line">     <span class="comment">// do gRPC method</span></span><br><span class="line">     ret := handler(ctx, req)</span><br><span class="line">     <span class="comment">// do what you want after the grpc method</span></span><br><span class="line">     fmt.Println(time.Now().UnixNano() - start)</span><br><span class="line">     <span class="keyword">return</span> ret</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æœåŠ¡ç«¯æµå¼æ¥å£æ‹¦æˆªå™¨"><a href="#æœåŠ¡ç«¯æµå¼æ¥å£æ‹¦æˆªå™¨" class="headerlink" title="æœåŠ¡ç«¯æµå¼æ¥å£æ‹¦æˆªå™¨"></a>æœåŠ¡ç«¯æµå¼æ¥å£æ‹¦æˆªå™¨</h2><p>åœ¨golangçš„gRPCä¸­ï¼Œæ™®é€šæ¥å£ä¸streamæ¥å£çš„æ‹¦æˆªå™¨ï¼Œéœ€è¦åˆ†åˆ«å®ç°ã€‚ä»¥ä¸Šçš„æ‹¦æˆªå™¨åªç”¨äºéstreamçš„æ¥å£ï¼Œå¯¹äºstreamæ¥å£ï¼Œä»¥ä¸Šæ‹¦æˆªå™¨æ˜¯ä¸ç”Ÿæ•ˆçš„ã€‚<br>æµå¼æ‹¦æˆªå™¨å‡½æ•°ç­¾åå¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StreamServerInterceptor <span class="function"><span class="keyword">func</span><span class="params">(srv <span class="keyword">interface</span>&#123;&#125;, ss ServerStream, info *StreamServerInfo, handler StreamHandler)</span> <span class="title">error</span></span></span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹æµå¼æ‹¦æˆªå™¨å¯çŸ¥ï¼Œstreamçš„contextæ˜¯åœ¨ServerStreamä¸­çš„ï¼Œå› æ­¤stream è¦ä¼ é€’context éœ€è¦ç»§æ‰¿ServerStreamå¹¶è¦†ç›–contextã€‚å¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WrappedStream wraps around the embedded grpc.ServerStream, and intercepts the Context</span></span><br><span class="line"><span class="keyword">type</span> WrappedStream <span class="keyword">struct</span> &#123;</span><br><span class="line">	grpc.ServerStream <span class="comment">// serverStream interface</span></span><br><span class="line">	Ctx *context.Context <span class="comment">// å®šä¹‰ctxï¼Œè¦†ç›–ServerStreamä¸­çš„context</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Context override the context method and can config the context manually</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c WrappedStream)</span> <span class="title">Context</span><span class="params">()</span> <span class="title">context</span>.<span class="title">Context</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> *c.Ctx</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewWrappedStream wrapper the grpc.ServerStream</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewWrappedStream</span><span class="params">(s grpc.ServerStream, ctx *context.Context)</span> <span class="title">grpc</span>.<span class="title">ServerStream</span></span> &#123;</span><br><span class="line">	wrapper := &amp;WrappedStream&#123;</span><br><span class="line">		ServerStream: s,</span><br><span class="line">		Ctx:          ctx,</span><br><span class="line">	&#125;</span><br><span class="line">	stream := grpc.ServerStream(wrapper)</span><br><span class="line">	<span class="keyword">return</span> stream</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ç°è¯¥å°è£…ä¹‹åï¼Œå°±å¯ä»¥å°†ä¸Šå±‚çš„contextè·å–å¹¶å°†å…ƒæ•°æ®å†™å…¥contextåï¼Œè°ƒç”¨NewWrappedStreamä¼ å…¥gRPCçš„æ¥å£è°ƒç”¨ä¸­ã€‚å¦‚ä¸‹æ‰€ç¤º</p>
<ol>
<li>æµå¼æ‹¦æˆªå™¨å®ç°å…ƒæ•°æ®çš„ä¼ é€’</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// stream method to get meta data</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MetaStreamServerInterceptor</span><span class="params">()</span> <span class="title">grpc</span>.<span class="title">StreamServerInterceptor</span></span> &#123;</span><br><span class="line">  <span class="comment">// å‡½æ•°ç­¾å</span></span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">		srv <span class="keyword">interface</span>&#123;&#125;, ss grpc.ServerStream, info *grpc.StreamServerInfo, handler grpc.StreamHandler)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">     <span class="comment">// è·å–å½“å‰ grpc context</span></span><br><span class="line">     ctx := ss.Context()</span><br><span class="line">     md, ok := metadata.FromIncomingContext(ctx)</span><br><span class="line">	   <span class="keyword">if</span> !ok &#123;</span><br><span class="line">		     md = metadata.Pairs()</span><br><span class="line">	   &#125;</span><br><span class="line">	   <span class="comment">// Set request info for context.</span></span><br><span class="line">     <span class="comment">// define your key</span></span><br><span class="line">     <span class="keyword">for</span> _, key := <span class="keyword">range</span> []<span class="keyword">string</span>&#123;<span class="string">"requestId"</span>&#125; &#123;</span><br><span class="line">		    value := md.Get(key)</span><br><span class="line">		    <span class="comment">// ignore it if not exists.</span></span><br><span class="line">		    <span class="keyword">if</span> <span class="built_in">len</span>(value) &gt;= <span class="number">1</span> &#123;</span><br><span class="line">            <span class="comment">// set value to context. you can use ctx.Value to get it from your grpc method</span></span><br><span class="line">			      ctx = context.WithValue(ctx, key, value[<span class="number">0</span>])</span><br><span class="line">		    &#125;</span><br><span class="line">     &#125;</span><br><span class="line">    <span class="comment">// set context to next </span></span><br><span class="line">		<span class="keyword">return</span> handler(srv, streaminterceptor.NewWrappedStream(ss, &amp;ctx))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="gRPCå®¢æˆ·ç«¯æ‹¦æˆªå™¨"><a href="#gRPCå®¢æˆ·ç«¯æ‹¦æˆªå™¨" class="headerlink" title="gRPCå®¢æˆ·ç«¯æ‹¦æˆªå™¨"></a>gRPCå®¢æˆ·ç«¯æ‹¦æˆªå™¨</h2><p>gRPCå®¢æˆ·ç«¯æ‹¦æˆªå™¨æ˜¯åœ¨è°ƒç”¨gRPCæ¥å£ä¹‹å‰ä¸ä¹‹åæ‰§è¡Œçš„æ“ä½œã€‚æ¯”å¦‚ï¼Œå…ƒæ•°æ®éœ€è¦åœ¨è¯·æ±‚æ¥å£ä¹‹å‰å¡å…¥åˆ°metaDataä¸­(http2.0Header)ï¼Œæ‰ä¼šä¼ é€’åˆ°gRPCçš„æœåŠ¡ç«¯ã€‚<br>å¦‚ä¸‹ï¼Œå°†å½“å‰æ¥å£contextä¸­çš„æ•°æ®æ”¾å…¥headerä¸­ä¼ å…¥æœåŠ¡ç«¯ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// request grpc service with requestId/traceId info.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MetaClientDataInterceptor</span><span class="params">()</span> <span class="title">grpc</span>.<span class="title">UnaryClientInterceptor</span></span> &#123;</span><br><span class="line">  <span class="comment">// å‡½æ•°ç­¾å</span></span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">		ctx context.Context,</span></span></span><br><span class="line"><span class="function"><span class="params">		method <span class="keyword">string</span>, req, resp <span class="keyword">interface</span>&#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">		cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption,</span></span></span><br><span class="line"><span class="function"><span class="params">	)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	  <span class="comment">// è·å–å½“å‰headeræ•°æ®ï¼Œæ²¡æœ‰åˆ™æ–°å»ºä¸€ä¸ª</span></span><br><span class="line">		md, ok := metadata.FromOutgoingContext(ctx)</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			md = metadata.Pairs()</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> _, key := <span class="keyword">range</span> keyNames &#123;</span><br><span class="line">			value := ctx.Value(key)</span><br><span class="line">			<span class="keyword">if</span> strValue, ok := value.(<span class="keyword">string</span>); ok &amp;&amp; strValue != <span class="string">""</span> &#123;</span><br><span class="line">			  </span><br><span class="line">				md.Set(key, strValue)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// å°†headerå†™å…¥</span></span><br><span class="line">		ctx = metadata.NewOutgoingContext(ctx, md)</span><br><span class="line">		<span class="comment">// æ‰§è¡Œè°ƒç”¨</span></span><br><span class="line">		<span class="keyword">return</span> invoker(ctx, method, req, resp, cc, opts...)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æµå¼å®¢æˆ·ç«¯æ‹¦æˆªå™¨"><a href="#æµå¼å®¢æˆ·ç«¯æ‹¦æˆªå™¨" class="headerlink" title="æµå¼å®¢æˆ·ç«¯æ‹¦æˆªå™¨"></a>æµå¼å®¢æˆ·ç«¯æ‹¦æˆªå™¨</h2><p>Stream clientçš„å®ç°ä¹Ÿæ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä¸æœåŠ¡ç«¯ä¸åŒçš„æ˜¯ï¼Œå®¢æˆ·ç«¯çš„æµå¼æ‹¦æˆªå™¨ä¸éœ€è¦å°è£…ä¸€å±‚ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚<br>å¦‚ä¸‹ï¼ŒåŒæ ·å®ç°äº†å…ƒæ•°æ®ä¼ é€’åˆ°æœåŠ¡ç«¯çš„æ‹¦æˆªå™¨ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MetaStreamClientInterceptor get grpc client info, requestId/traceId/LogId for grpc stream server</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MetaStreamClientInterceptor</span><span class="params">()</span> <span class="title">grpc</span>.<span class="title">StreamClientInterceptor</span></span> &#123;</span><br><span class="line">  <span class="comment">// å‡½æ•°ç­¾å</span></span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, desc *grpc.StreamDesc, cc *grpc.ClientConn, method <span class="keyword">string</span>, streamer grpc.Streamer,</span></span></span><br><span class="line"><span class="function"><span class="params">		opts ...grpc.CallOption)</span> <span class="params">(grpc.ClientStream, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»contextè·å–å…ƒæ•°æ®</span></span><br><span class="line">		md, ok := metadata.FromOutgoingContext(ctx)</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			md = metadata.Pairs()</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> _, key := <span class="keyword">range</span> keyNames &#123;</span><br><span class="line">			value := ctx.Value(key)</span><br><span class="line">			<span class="keyword">if</span> strValue, ok := value.(<span class="keyword">string</span>); ok &amp;&amp; strValue != <span class="string">""</span> &#123;</span><br><span class="line">				md.Set(key, strValue)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// set metadata to ctx</span></span><br><span class="line">		ctx = metadata.NewOutgoingContext(ctx, md)</span><br><span class="line"></span><br><span class="line">		clientStream, err := streamer(ctx, desc, cc, method, opts...)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> clientStream, err</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ‹¦æˆªå™¨ä¸ºgRPCçš„æœåŠ¡ç«¯/å®¢æˆ·ç«¯å¤ç”¨å…¬å…±æ¨¡å—æä¾›äº†ä¸€ç§å¾ˆç®€å•æ–¹ä¾¿çš„æ–¹æ³•ï¼Œåªéœ€è¦å®ç°å¯¹åº”çš„æ‹¦æˆªå™¨å‡½æ•°ï¼Œåœ¨æœåŠ¡ç«¯å¯åŠ¨æˆ–è€…å®¢æˆ·ç«¯è¿æ¥çš„æ—¶å€™ä½œä¸ºé€‰é¡¹ä¼ å…¥å³å¯(è‡ªè¡Œæœç´¢)ã€‚<br>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨Golangä¸­ï¼Œæ‹¦æˆªå™¨åˆ†ä¸ºæ™®é€šæ¥å£ä¸æµå¼æ¥å£çš„æ‹¦æˆªå™¨ï¼Œéœ€è¦åˆ†åˆ«å®ç°ã€‚</p>
<ol>
<li>æµå¼æœåŠ¡ç«¯æ‹¦æˆªå™¨</li>
</ol>
<p>gRPCä¸­æ‹¦æˆªå™¨æµå¼æ¥å£æ‹¦æˆªå™¨éœ€è¦å®ç°å¦‚ä¸‹ç­¾åçš„å‡½æ•°ï¼Œæœ‰å…´è¶£å¯æ·±å…¥äº†è§£ä¸‹ã€‚ä¾‹å­å¦‚ä¸Šæ‰€ç¤º</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StreamServerInterceptor provides a hook to intercept the execution of a streaming RPC on the server.</span></span><br><span class="line"><span class="comment">// info contains all the information of this RPC the interceptor can operate on. And handler is the</span></span><br><span class="line"><span class="comment">// service method implementation. It is the responsibility of the interceptor to invoke handler to</span></span><br><span class="line"><span class="comment">// complete the RPC.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(srv <span class="keyword">interface</span>&#123;&#125;, ss grpc.ServerStream, info *grpc.StreamServerInfo, handler grpc.StreamHandler)</span> <span class="title">error</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„streamServeræ‹¦æˆªå™¨å¦‚æœéœ€è¦ä¼ é€’contextï¼Œéœ€è¦å°†ServerStreamè¿›è¡Œå°è£…ï¼Œè¦†ç›–Context å‡½æ•°</p>
</blockquote>
<ol start="2">
<li>æ™®é€šæœåŠ¡ç«¯æ‹¦æˆªå™¨</li>
</ol>
<p>æ™®é€šæ–¹æ³•çš„æ‹¦æˆªå™¨å®ç°æ¯”è¾ƒç®€å•ï¼Œå®ç°å¦‚ä¸‹ç­¾åå‡½æ•°</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @params ctx: grpc context</span></span><br><span class="line"><span class="comment">// @params req: the request params</span></span><br><span class="line"><span class="comment">// @params info: the grpc request info</span></span><br><span class="line"><span class="comment">// @params handler: the real grpc method</span></span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context,</span></span></span><br><span class="line"><span class="function"><span class="params">		req <span class="keyword">interface</span>&#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">		info *grpc.UnaryServerInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">		handler grpc.UnaryHandler)</span> <span class="params">(resp <span class="keyword">interface</span>&#123;&#125;, err error)</span></span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å®¢æˆ·ç«¯æ™®é€šæ‹¦æˆªå™¨</li>
</ol>
<p>golangåœ¨è°ƒç”¨grpcä¹‹å‰æ‰§è¡Œçš„å…¬å…±çš„æ“ä½œï¼Œæ¯”å¦‚è¦æŠŠrequestIdå¡åˆ°headerä¸­ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @params method: the RPC name</span></span><br><span class="line"><span class="comment">// @params req: the request</span></span><br><span class="line"><span class="comment">// @params resp: the response</span></span><br><span class="line"><span class="comment">// @params cc: the ClientConn on which the RPC was invoked</span></span><br><span class="line"><span class="comment">// @params invoker: the invoker of grpc methor</span></span><br><span class="line"><span class="comment">// @params opts: the option</span></span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">		ctx context.Context,</span></span></span><br><span class="line"><span class="function"><span class="params">		method <span class="keyword">string</span>, req, resp <span class="keyword">interface</span>&#123;&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">		cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption,</span></span></span><br><span class="line"><span class="function"><span class="params">	)</span></span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>å®¢æˆ·ç«¯æµå¤±æ‹¦æˆªå™¨</li>
</ol>
<p>å®ç°å¦‚ä¸‹ç­¾åçš„å‡½æ•°å³å¯</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @params desc: contains a description of the stream</span></span><br><span class="line"><span class="comment">// @params cc: the ClientConn on which the RPC was invoked</span></span><br><span class="line"><span class="comment">// @params method: the RPC name</span></span><br><span class="line"><span class="comment">// @params streamer: the handler to create a ClientStream and it is the responsibility of the interceptor to call it</span></span><br><span class="line"><span class="comment">// @params opts: the option</span></span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, desc *StreamDesc, cc *ClientConn, method <span class="keyword">string</span>, streamer Streamer, opts ...CallOption)</span> <span class="params">(ClientStream, error)</span></span></span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šå³ä¸ºGolangçš„æ‹¦æˆªå™¨å®ç°ï¼Œå¯ä»¥åˆ†ä¸ºæœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„æ‹¦æˆªå™¨ï¼Œä¸¤ç«¯åˆ†åˆ«æœ‰æµå¼æ‹¦æˆªå™¨ä¸æ™®é€šæ¥å£æ‹¦æˆªå™¨ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™å¯æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚å®ç°ã€‚</p>

        
    </section>
</article>




<nav class="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
</nav>


</div>
        <footer class="footer">
    Powered by <a href="http://shiguofu.cn" target="_blank">carlshi</a>,  <a href="https://beian.miit.gov.cn/" target="_blank">é„‚ICPå¤‡18003559å·-1</a>

    
</footer>

    </main>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }
            
            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle();
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp();
            }, 3000);
        }
    });
    </script>
    

</body>
</html>
