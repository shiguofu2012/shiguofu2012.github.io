<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">

    

    

    <title>点滴诗词</title>
    <meta name="author" content="shiguofu">
    <meta name="version" content="1.0.0">
    <meta name="keywords" content>
    <meta name="description" content="好玩有趣长知识">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">

    
    <link rel="alternate" href="/atom.xml" title="点滴诗词" type="application/atom+xml">
    
    
    <link rel="icon" href="http://shiguofu.cn/favicon.ico">
    

    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <main class="app">
        <header class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">点滴诗词</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item active" href="/">
                <span class="nav-text">首页</span>
            </a>
        
            <a class="nav-item" href="/categories/backend">
                <span class="nav-text">后端</span>
            </a>
        
            <a class="nav-item" href="/tags">
                <span class="nav-text">标签</span>
            </a>
        
            <a class="nav-item" href="/archives">
                <span class="nav-text">归档</span>
            </a>
        
            <a class="nav-item" href="/about">
                <span class="nav-text">关于</span>
            </a>
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://shiguofu2012.github.io"></form>

        
        

        
        <div class="author-meta">
            
            <div class="author-avatar">
                <a href="/">
                    <img src="http://shiguofu.cn/static/images/diandi.jpg" title="公众号：itman-1">
                </a>
            </div>
            
            <div class="author-name">公众号：itman-1</div>
            <div class="author-work">程序猿，苦B奋斗的伪文艺老年</div>
            <div class="author-location">
                <i class="icon-location vm"></i>
                <span class="vm">wuhan, China</span>
            </div>
            
            <div class="author-thread-wrap">
                <div class="author-threads clearfix">
                    
                        <a class="thread-item" href="https://github.com/shiguofu2012" target="_blank" rel="noopener">
                            <!-- Generated by IcoMoon.io -->
<svg viewbox="0 0 1024 1024" width="38" height="38" fill="currentColor">
<path d="M512 32.12c-265.004 0-479.88 220.23-479.88 492.090 0 217.446 137.536 401.684 328.202 466.81 23.994 4.498 32.778-10.712 32.778-23.78 0-11.782-0.428-42.632-0.642-83.764-133.466 29.778-161.744-65.984-161.744-65.984-21.852-56.772-53.344-71.982-53.344-71.982-43.49-30.636 3.214-29.992 3.214-29.992 48.202 3.428 73.482 50.772 73.482 50.772 42.846 75.196 112.258 53.558 139.68 40.918 4.284-31.706 16.71-53.558 30.42-65.77-106.474-12.426-218.516-54.63-218.516-243.152 0-53.772 18.638-97.69 49.274-131.966-4.928-12.426-21.424-62.556 4.714-130.252 0 0 40.276-13.282 131.966 50.344 38.348-10.926 79.266-16.282 120.184-16.496 40.704 0.214 81.836 5.57 120.184 16.496 91.692-63.626 131.752-50.344 131.752-50.344 26.136 67.698 9.64 117.828 4.714 130.252 30.636 34.492 49.274 78.408 49.274 131.966 0 188.952-112.258 230.514-219.16 242.724 17.138 15.21 32.564 45.202 32.564 91.048 0 65.77-0.642 118.898-0.642 134.966 0 13.068 8.57 28.492 32.992 23.566 191.094-64.912 328.418-249.152 328.418-466.382 0-271.86-214.874-492.090-479.88-492.090z"/>
</svg>

                        </a>
                    
                        <a class="thread-item" href="http://weibo.com/shiguofu2012" target="_blank" rel="noopener">
                            <!-- Generated by IcoMoon.io -->
<svg viewbox="0 0 1024 1024" width="38" height="38" fill="currentColor">
<path d="M21.332 512c0-270.988 219.68-490.666 490.668-490.666s490.666 219.68 490.666 490.666c0 270.988-219.678 490.666-490.666 490.666s-490.666-219.678-490.666-490.666zM960 512c0-247.424-200.576-448-448-448s-448 200.576-448 448c0 247.424 200.576 448 448 448s448-200.576 448-448zM768 597.332c47.128 0 85.332-38.206 85.332-85.332s-38.206-85.332-85.332-85.332c-47.128 0-85.332 38.204-85.332 85.332s38.206 85.332 85.332 85.332zM512 597.332c47.128 0 85.332-38.206 85.332-85.332s-38.206-85.332-85.332-85.332c-47.128 0-85.332 38.204-85.332 85.332s38.204 85.332 85.332 85.332zM255.998 597.332c47.128 0 85.332-38.206 85.332-85.332s-38.204-85.332-85.332-85.332c-47.128 0-85.332 38.204-85.332 85.332s38.204 85.332 85.332 85.332z"/>
</svg>

                        </a>
                    
                        <a class="thread-item" href="https://twitter.com/shiguofu2012" target="_blank" rel="noopener">
                            <!-- Generated by IcoMoon.io -->
<svg viewbox="0 0 1024 1024" width="38" height="38" fill="currentColor">
<path d="M512.029 31.011c-263.32 0-476.784 213.502-476.784 476.784 0 263.32 213.464 476.743 476.784 476.743s476.743-213.424 476.743-476.743c0-263.282-213.444-476.784-476.743-476.784zM752.193 411.663c0.251 5.151 0.349 10.319 0.349 15.548 0 158.786-120.856 341.85-341.85 341.85-67.844 0-131.021-19.884-184.188-53.961 9.41 1.104 18.955 1.665 28.656 1.665 56.305 0 108.115-19.208 149.221-51.425-52.567-0.987-96.925-35.741-112.22-83.468 7.32 1.433 14.85 2.149 22.595 2.149 10.959 0 21.569-1.433 31.656-4.201-54.987-11.035-96.402-59.634-96.402-117.796 0-0.524 0-1.025 0.020-1.549 16.186 9.003 34.716 14.404 54.427 15.044-32.258-21.587-53.458-58.317-53.458-100.023 0-22.015 5.925-42.673 16.264-60.408 59.266 72.683 147.807 120.527 247.676 125.521-2.053-8.77-3.118-17.968-3.118-27.378 0-66.333 53.787-120.14 120.158-120.14 34.561 0 65.771 14.599 87.69 37.93 27.378-5.363 53.091-15.393 76.305-29.16-9.003 28.074-28.036 51.618-52.858 66.47 24.338-2.903 47.495-9.37 69.024-18.917-16.070 24.144-36.459 45.306-59.945 62.248z"/>
</svg>

                        </a>
                    
                </div>
            </div>
            
        </div>
        
    </div>
</aside>

</header>

        <div id="content" class="content">
    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2019/09/17/linux-config/">linux 一些配置</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://shiguofu2012.github.io/page/3/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2019-09-17T02:49:59.000Z" itemprop="datePublished">2019-09-17</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/linux/">linux</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h4 id="TCP最大监听队列修改"><a href="#TCP最大监听队列修改" class="headerlink" title="TCP最大监听队列修改"></a>TCP最大监听队列修改</h4><p>修改somaxconn参数值</p>
<p>该内核参数默认值一般是128（定义了系统中每一个端口最大的监听队列的长度），对于负载很大的服务程序来说大大的不够。一般会将它修改为2048或者更大。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 2048 &gt; /proc/sys/net/core/somaxconn    # 临时修改，立马生效；系统重启丢失</span><br></pre></td></tr></table></figure>

<p>在/etc/sysctl.conf中添加如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.core.somaxconn = 2048</span><br></pre></td></tr></table></figure>

<p>然后在终端中执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<h4 id="redis-（overcommit-memory）WARNING"><a href="#redis-（overcommit-memory）WARNING" class="headerlink" title="redis （overcommit_memory）WARNING"></a>redis （overcommit_memory）WARNING</h4><p>redis 有时background save db不成功，log发现下面的告警，很可能由它引起的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">17427:M 17 Sep 2019 10:54:12.730 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add &apos;vm.overcommit_memory = 1&apos; to /etc/sysctl.conf and then reboot or run the command &apos;sysctl vm.overcommit_memory=1&apos; for this to take effect.</span><br></pre></td></tr></table></figure>

<p>看到这个顺道去查了下，发现</p>
<p><strong>内核参数overcommit_memory</strong> </p>
<p>它是内存分配策略，可选值：0、1、2。</p>
<p>0 – 表示内核将检查是否有足够的可用内存供应用进程使用；如果有足够的可用内存，内存申请允许；否则，内存申请失败，并把错误返回给应用进程。<br>1 – 表示内核允许分配所有的物理内存，而不管当前的内存状态如何。<br>2 – 表示内核允许分配超过所有物理内存和交换空间总和的内存</p>
<p><strong>Overcommit 与 OOM</strong></p>
<p>   Linux对大部分申请内存的请求都回复”yes”，以便能跑更多更大的程序。因为申请内存后，并不会马上使用内存。这种技术叫做<strong>Overcommit</strong>。当linux发现内存不足时，会发生OOM killer(OOM=out-of-memory)。它会选择杀死一些进程(用户态进程，不是内核线程)，以便释放内存。</p>
<p>   当oom-killer发生时，linux会选择杀死哪些进程？选择进程的函数是oom_badness函数(在mm/oom_kill.c中)，该函数会计算每个进程的点数(0~1000)。点数越高，这个进程越有可能被杀死。每个进程的点数跟oom_score_adj有关，而且oom_score_adj可以被设置(-1000最低，1000最高)。</p>
<p><strong>解决办法</strong></p>
<p>同样是修改内核参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/vm/overcommit_memory # 临时修改，立马生效；系统重启丢失</span><br></pre></td></tr></table></figure>

<p>编辑/etc/sysctl.conf ，新增下面一行，然后sysctl -p 使配置文件生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.overcommit_memory=1</span><br></pre></td></tr></table></figure>

<h4 id="redis-Transparent-Huge-Pages-WARNING"><a href="#redis-Transparent-Huge-Pages-WARNING" class="headerlink" title="redis (Transparent Huge Pages) WARNING"></a>redis (<strong>Transparent Huge Pages</strong>) WARNING</h4><p>redis 在centos 7 启动后有警告</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">17427:M 17 Sep 2019 10:54:12.730 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command &apos;echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled&apos; as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</span><br></pre></td></tr></table></figure>

<p><strong>Transparent Huge Pages的一些官方介绍</strong></p>
<blockquote>
<p>The kernel will always attempt to satisfy a memory allocation using huge pages. If no huge pages are available (due to non availability of physically continuous memory for example) the kernel will fall back to the regular 4KB pages. THP are also swappable (unlike hugetlbfs). This is achieved by breaking the huge page to smaller 4KB pages, which are then swapped out normally.</p>
</blockquote>
<p><strong>禁止透明大页</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost 6379]# cat /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">always madvise [never]</span><br></pre></td></tr></table></figure>

<p>默认开启的，因此出现找不到文件，就是开启的</p>
<h4 id="打开文件数的限制"><a href="#打开文件数的限制" class="headerlink" title="打开文件数的限制"></a>打开文件数的限制</h4><p>用户级的文件数限制, 可以通过 ulimit -n 来查看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# ulimit -n    # 查看当前用户能够打开的最大文件数</span><br><span class="line">1024</span><br></pre></td></tr></table></figure>

<p>而系统级别的文件数限制，则通过sysctl -a来查看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# sysctl -a | grep file-max</span><br><span class="line">fs.file-max = 284775</span><br></pre></td></tr></table></figure>

<p>一般系统最大文件数会根据硬件资源计算出来的，如果强行需要修改最大打开文件数可以通过ulimit -n 10240来修改，当这种方式只对当前进程有效，如果需要永久有效则需要修改<strong>/etc/security/limits.conf</strong>（重启系统生效）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">#&lt;type&gt; can have the two values:</span><br><span class="line">#        - &quot;soft&quot; for enforcing the soft limits</span><br><span class="line">#        - &quot;hard&quot; for enforcing hard limits</span><br><span class="line">#</span><br><span class="line">#&lt;item&gt; can be one of the following:</span><br><span class="line">#        - core - limits the core file size (KB)</span><br><span class="line">#        - data - max data size (KB)</span><br><span class="line">#        - fsize - maximum filesize (KB)</span><br><span class="line">#        - memlock - max locked-in-memory address space (KB)</span><br><span class="line">#        - nofile - max number of open file descriptors</span><br><span class="line">#        - rss - max resident set size (KB)</span><br><span class="line">#        - stack - max stack size (KB)</span><br><span class="line">#        - cpu - max CPU time (MIN)</span><br><span class="line">#        - nproc - max number of processes</span><br><span class="line">#        - as - address space limit (KB)</span><br><span class="line">#        - maxlogins - max number of logins for this user</span><br><span class="line">#        - maxsyslogins - max number of logins on the system</span><br><span class="line">#        - priority - the priority to run user process with</span><br><span class="line">#        - locks - max number of file locks the user can hold</span><br><span class="line">#        - sigpending - max number of pending signals</span><br><span class="line">#        - msgqueue - max memory used by POSIX message queues (bytes)</span><br><span class="line">#        - nice - max nice priority allowed to raise to values: [-20, 19]</span><br><span class="line">#        - rtprio - max realtime priority</span><br><span class="line">#</span><br><span class="line">#&lt;domain&gt;      &lt;type&gt;  &lt;item&gt;         &lt;value&gt;</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">#*               soft    core            0</span><br><span class="line">#*               hard    rss             10000</span><br><span class="line">#@student        hard    nproc           20</span><br><span class="line">#@faculty        soft    nproc           20</span><br><span class="line">#@faculty        hard    nproc           50</span><br><span class="line">#ftp             hard    nproc           0</span><br><span class="line">#@student        -       maxlogins       4</span><br><span class="line"></span><br><span class="line"># End of file</span><br><span class="line"></span><br><span class="line">root soft nofile 65535   # 新增</span><br><span class="line">root hard nofile 65535</span><br></pre></td></tr></table></figure>

<p>各列意义:</p>
<p>1: 用户名称，对所有用户则“*”</p>
<p>2：soft 软限制/hard 硬件限制</p>
<p>3： 代表最大文件打开数</p>
<p>4： 数量</p>
<h5 id="查看所有进程文件打开数"><a href="#查看所有进程文件打开数" class="headerlink" title="查看所有进程文件打开数"></a>查看所有进程文件打开数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof | wc -l</span><br></pre></td></tr></table></figure>

<h5 id="查看某个进程打开文件数"><a href="#查看某个进程打开文件数" class="headerlink" title="查看某个进程打开文件数"></a>查看某个进程打开文件数</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof  -p [pid] | wc -l</span><br></pre></td></tr></table></figure>

<h5 id="查看系统中各个进程分别打开了多少句柄数"><a href="#查看系统中各个进程分别打开了多少句柄数" class="headerlink" title="查看系统中各个进程分别打开了多少句柄数"></a>查看系统中各个进程分别打开了多少句柄数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -n|awk '&#123;print $2&#125;'|sort|uniq -c|sort -nr|more</span><br></pre></td></tr></table></figure>

<h4 id="SSH-密钥登录"><a href="#SSH-密钥登录" class="headerlink" title="SSH 密钥登录"></a>SSH 密钥登录</h4><ol>
<li>生成公钥私钥对，linux下使用 ssh-keygen  命令生成，一路enter</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ssh-keygen </span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa):    # 存放路径</span><br><span class="line">Enter passphrase (empty for no passphrase):                 # 密码</span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:N9Q7EJosUhKrKw+Utf5jcSgpg7fzJS5EtVfa5iinWOk root@localhost.localdomain</span><br><span class="line">The key's randomart image is:</span><br><span class="line">+---[RSA 2048]----+</span><br><span class="line">|    o..   .      |</span><br><span class="line">|    .+ ..o o     |</span><br><span class="line">|   oo..++ o .    |</span><br><span class="line">|  +.o.o.o. . .   |</span><br><span class="line">|.+...o.+S o o    |</span><br><span class="line">|oo+++oo... . .   |</span><br><span class="line">|oo+*o++          |</span><br><span class="line">| +=.E=           |</span><br><span class="line">|  .++..          |</span><br><span class="line">+----[SHA256]-----+</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成密钥对后，将公钥上传到服务器要登陆的用户 ~/.ssh/authorized_keys</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cat ~/.ssh/id_rsa.pub </span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCyUOANXFleDWrpJop7zrM2eZxrna8+uIiSbz72IRsAO3intbNkyHJpULv9yYUmT4iPf4Vn4QYmyogFhdpTktKSADBbyH5VXIGyFjbWeO7ix1iVr7YVQQ/4P/nELVytCUiIojFdZ+DvyYSariLzLuliFpYTMJ4jpmgpL/pAUobEazpGwjlRUOWik3+8kLGpsxHYJNUmrZKSnNaOYqDJVGfO3KBfozO+I5B/wcwSW5hje7Y5xyfdDzvuVh7uVmKQbjw3WoMiy64pTcKB1S3tQtPZfXnmOd3tUZU8SXSfcvhHdgrbG6kFBrJwqjpj/sE4zL9nWbSZlbpJD7gXtlkdrAH1 root@localhost.localdomain</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>登录服务器 ~/.ssh/authorized_keys</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@wpspic6 opt]# cat ~/.ssh/authorized_keys</span><br><span class="line">sh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCyUOANXFleDWrpJop7zrM2eZxrna8+uIiSbz72IRsAO3intbNkyHJpULv9yYUmT4iPf4Vn4QYmyogFhdpTktKSADBbyH5VXIGyFjbWeO7ix1iVr7YVQQ/4P/nELVytCUiIojFdZ+DvyYSariLzLuliFpYTMJ4jpmgpL/pAUobEazpGwjlRUOWik3+8kLGpsxHYJNUmrZKSnNaOYqDJVGfO3KBfozO+I5B/wcwSW5hje7Y5xyfdDzvuVh7uVmKQbjw3WoMiy64pTcKB1S3tQtPZfXnmOd3tUZU8SXSfcvhHdgrbG6kFBrJwqjpj/sE4zL9nWbSZlbpJD7gXtlkdrAH1 root@localhost.localdomain</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><p>测试登录，这里我用的是root</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# ssh root@10.226.50.30 </span><br><span class="line">Last login: Tue Sep 17 16:23:57 2019 from 10.226.28.68     # 登录成功</span><br></pre></td></tr></table></figure>

<p>增加-v选项，输出登录过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# ssh root@10.226.50.30 -v</span><br><span class="line">OpenSSH_7.4p1, OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">debug1: Reading configuration data /etc/ssh/ssh_config</span><br><span class="line">debug1: /etc/ssh/ssh_config line 58: Applying options for *</span><br><span class="line">debug1: Connecting to 10.226.50.30 [10.226.50.30] port 22.</span><br><span class="line">debug1: Connection established.</span><br><span class="line">debug1: permanently_set_uid: 0/0</span><br><span class="line">debug1: identity file /root/.ssh/id_rsa type 1</span><br><span class="line">debug1: key_load_public: No such file or directory</span><br><span class="line">debug1: identity file /root/.ssh/id_rsa-cert type -1</span><br><span class="line">debug1: key_load_public: No such file or directory</span><br><span class="line">debug1: identity file /root/.ssh/id_dsa type -1</span><br><span class="line">debug1: key_load_public: No such file or directory</span><br><span class="line">debug1: identity file /root/.ssh/id_dsa-cert type -1</span><br><span class="line">debug1: key_load_public: No such file or directory</span><br><span class="line">debug1: identity file /root/.ssh/id_ecdsa type -1</span><br><span class="line">debug1: key_load_public: No such file or directory</span><br><span class="line">debug1: identity file /root/.ssh/id_ecdsa-cert type -1</span><br><span class="line">debug1: key_load_public: No such file or directory</span><br><span class="line">debug1: identity file /root/.ssh/id_ed25519 type -1</span><br><span class="line">debug1: key_load_public: No such file or directory</span><br><span class="line">debug1: identity file /root/.ssh/id_ed25519-cert type -1</span><br><span class="line">debug1: Enabling compatibility mode for protocol 2.0</span><br><span class="line">debug1: Local version string SSH-2.0-OpenSSH_7.4</span><br><span class="line">debug1: Remote protocol version 2.0, remote software version OpenSSH_7.4</span><br><span class="line">debug1: match: OpenSSH_7.4 pat OpenSSH* compat 0x04000000</span><br><span class="line">debug1: Authenticating to 10.226.50.30:22 as &apos;root&apos;</span><br><span class="line">debug1: SSH2_MSG_KEXINIT sent</span><br><span class="line">debug1: SSH2_MSG_KEXINIT received</span><br><span class="line">debug1: kex: algorithm: curve25519-sha256</span><br><span class="line">debug1: kex: host key algorithm: rsa-sha2-512</span><br><span class="line">debug1: kex: server-&gt;client cipher: chacha20-poly1305@openssh.com MAC: &lt;implicit&gt; compression: none</span><br><span class="line">debug1: kex: client-&gt;server cipher: chacha20-poly1305@openssh.com MAC: &lt;implicit&gt; compression: none</span><br><span class="line">debug1: kex: curve25519-sha256 need=64 dh_need=64</span><br><span class="line">debug1: kex: curve25519-sha256 need=64 dh_need=64</span><br><span class="line">debug1: expecting SSH2_MSG_KEX_ECDH_REPLY</span><br><span class="line">debug1: Server host key: ssh-rsa SHA256:yKoRmi5QgIlXrrhYQcP5W0Mx2PhSoTsm5Z+DhdeYFpU</span><br><span class="line">debug1: Host &apos;10.226.50.30&apos; is known and matches the RSA host key.</span><br><span class="line">debug1: Found key in /root/.ssh/known_hosts:1</span><br><span class="line">debug1: rekey after 134217728 blocks</span><br><span class="line">debug1: SSH2_MSG_NEWKEYS sent</span><br><span class="line">debug1: expecting SSH2_MSG_NEWKEYS</span><br><span class="line">debug1: SSH2_MSG_NEWKEYS received</span><br><span class="line">debug1: rekey after 134217728 blocks</span><br><span class="line">debug1: SSH2_MSG_EXT_INFO received</span><br><span class="line">debug1: kex_input_ext_info: server-sig-algs=&lt;rsa-sha2-256,rsa-sha2-512&gt;</span><br><span class="line">debug1: SSH2_MSG_SERVICE_ACCEPT received</span><br><span class="line">debug1: Authentications that can continue: publickey,gssapi-keyex,gssapi-with-mic,password</span><br><span class="line">debug1: Next authentication method: gssapi-keyex</span><br><span class="line">debug1: No valid Key exchange context</span><br><span class="line">debug1: Next authentication method: gssapi-with-mic</span><br><span class="line">debug1: Unspecified GSS failure.  Minor code may provide more information</span><br><span class="line">No Kerberos credentials available (default cache: KEYRING:persistent:0)</span><br><span class="line"></span><br><span class="line">debug1: Unspecified GSS failure.  Minor code may provide more information</span><br><span class="line">No Kerberos credentials available (default cache: KEYRING:persistent:0)</span><br><span class="line"></span><br><span class="line">debug1: Next authentication method: publickey</span><br><span class="line">debug1: Offering RSA public key: /root/.ssh/id_rsa</span><br><span class="line">debug1: Server accepts key: pkalg rsa-sha2-512 blen 279</span><br><span class="line">debug1: Authentication succeeded (publickey).</span><br><span class="line">Authenticated to 10.226.50.30 ([10.226.50.30]:22).</span><br><span class="line">debug1: channel 0: new [client-session]</span><br><span class="line">debug1: Requesting no-more-sessions@openssh.com</span><br><span class="line">debug1: Entering interactive session.</span><br><span class="line">debug1: pledge: network</span><br><span class="line">debug1: client_input_global_request: rtype hostkeys-00@openssh.com want_reply 0</span><br><span class="line">debug1: Sending environment.</span><br><span class="line">debug1: Sending env LANG = en_US.UTF-8</span><br><span class="line">Last login: Wed Sep 18 12:00:12 2019 from 10.226.50.31</span><br><span class="line">[root@wpspic6 ~]#</span><br></pre></td></tr></table></figure>

</li>
</ol>
<blockquote>
<ol>
<li>登录可能失败，可以在ssh命令后增加-v选项查看登录过程；</li>
<li>如果私钥是从其他地方拷贝，最好将id_rsa.pub也拷贝或者原来的删除，否则会影响登录；</li>
</ol>
</blockquote>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2019/09/17/redis-install/">redis 安装</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://shiguofu2012.github.io/page/3/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2019-09-17T01:22:21.000Z" itemprop="datePublished">2019-09-17</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/redis/">redis</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ol>
<li>通过wget直接下载redis源码安装包，目前最新半5.0的</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.redis.io/releases/redis-5.0.5.tar.gz</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>解压</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf redis-5.0.5.tar.gz</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>进入源码目录</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd redis-5.0.5/src</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>编译</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><ul>
<li>安装成功后，配置文件/etc/redis.conf</li>
</ul>
<p>默认daemon 为no，ip：127.0.0.1直接运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server /etc/redis.conf</span><br></pre></td></tr></table></figure>

<p>运行后出现下图，则运行成功：</p>
<p><img src="/2019/09/17/redis-install/redis-start.png" alt="redis-start"></p>
<ul>
<li>访问</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; set foo bar</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;foo&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改配置文件，daemon/ip,基本修改，重新运行便可启动了</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># By default Redis does not run as a daemon. Use &apos;yes&apos; if you need it.</span><br><span class="line"># Note that Redis will write a pid file in /var/run/redis.pid when daemonized.</span><br><span class="line"></span><br><span class="line">daemonize yes</span><br><span class="line"></span><br><span class="line"># Examples:</span><br><span class="line">#</span><br><span class="line"># bind 192.168.1.100 10.0.0.1</span><br><span class="line"># bind 127.0.0.1 ::1</span><br><span class="line">#</span><br><span class="line"># ~~~ WARNING ~~~ If the computer running Redis is directly exposed to the</span><br><span class="line"># internet, binding to all the interfaces is dangerous and will expose the</span><br><span class="line"># instance to everybody on the internet. So by default we uncomment the</span><br><span class="line"># following bind directive, that will force Redis to listen only into</span><br><span class="line"># the IPv4 loopback interface address (this means Redis will be able to</span><br><span class="line"># accept connections only from clients running into the same computer it</span><br><span class="line"># is running).</span><br><span class="line">#</span><br><span class="line"># IF YOU ARE SURE YOU WANT YOUR INSTANCE TO LISTEN TO ALL THE INTERFACES</span><br><span class="line"># JUST COMMENT THE FOLLOWING LINE.</span><br><span class="line"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line"></span><br><span class="line">bind 127.0.0.1</span><br></pre></td></tr></table></figure>

<h3 id="安装过程种可能出现的问题"><a href="#安装过程种可能出现的问题" class="headerlink" title="安装过程种可能出现的问题"></a>安装过程种可能出现的问题</h3><ol>
<li>centos没有安装gcc，会出现</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">command not found: CC</span><br></pre></td></tr></table></figure>

<p>安装gcc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>make时报如下错误：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zmalloc.h:50:31: error: jemalloc/jemalloc.h: No such file or directory</span><br><span class="line">zmalloc.h:55:2: error: #error &quot;Newer version of jemalloc required&quot;</span><br></pre></td></tr></table></figure>

<p>原因是jemalloc重载了Linux下的ANSI C的malloc和free函数。解决办法：make时添加参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make MALLOC=libc</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>make之后，会出现一句提示</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hint: To run &apos;make test&apos; is a good idea ;)</span><br></pre></td></tr></table></figure>

<p>但是不测试，通常是可以使用的。若我们运行make test ，会有如下提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">You need tcl 8.5 or newer in order to run the Redis test</span><br><span class="line">make: *** [test] Error 1</span><br></pre></td></tr></table></figure>

<p>解决办法是用yum安装tcl8.5（或去tcl的官方网站<a href="http://www.tcl.tk/下载8.5版本，并参考官网介绍进行安装）" target="_blank" rel="noopener">http://www.tcl.tk/下载8.5版本，并参考官网介绍进行安装）</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install tcl</span><br></pre></td></tr></table></figure>


        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2019/09/16/mongodb/">mongodb replset 搭建</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://shiguofu2012.github.io/page/3/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2019-09-16T04:04:59.000Z" itemprop="datePublished">2019-09-16</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/mongodb/">mongodb</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Mongodb 副本集由一组Mongod实例（进程）组成，包含一个Primary节点和多个Secondary节点或者Arbiter节点。<br>副本集的所有写操作都交给Primary，Secondary从Primary同步oplog到本实例，以保持复制集内所有成员存储相同的数据集，实现数据的高可用。</p>
<h5 id="常见场景"><a href="#常见场景" class="headerlink" title="常见场景"></a>常见场景</h5><ul>
<li>数据冗余<br>集群可增加延迟写的节点，防止误操作</li>
<li>读写分离<br>适合读多写少的业务</li>
</ul>
<h5 id="典型结构"><a href="#典型结构" class="headerlink" title="典型结构"></a>典型结构</h5><p><img src="/2019/09/16/mongodb/mongo-replset.svg" alt="mongo结构"></p>
<p>集群中的所有节点都可接受读操作；默认的驱动连接时读主节点，可设置read_prefrence指定</p>
<blockquote>
<p>A replica set can have up to 50 members but only 7 voting members.</p>
<p>一个集群可以又最多50个节点，但有7个可投票的节点</p>
</blockquote>
<h3 id="节点角色"><a href="#节点角色" class="headerlink" title="节点角色"></a>节点角色</h3><ol>
<li>主节点(primary)</li>
</ol>
<p>可接收所有的读写请求；同步oplog到从节点。一个Replica Set只能有一个Primary节点，当Primary挂掉后，其他Secondary或者Arbiter节点会重新选举出来一个主节点。</p>
<ol start="2">
<li>副本节点(secondary)</li>
</ol>
<p>与主节点保持同样的数据集。当主节点挂掉的时候，参与选主。</p>
<ol start="3">
<li>仲裁者(arbiter)</li>
</ol>
<p>不保持数据，不可能成为主节点，只进行投票选举主节点。为了打破投票中的偶数个节点的情况，Arbiter几乎没什么大的硬件资源需求.</p>
<blockquote>
<p>Do not run an arbiter on systems that also host the primary or the secondary members of the replica set.</p>
<p>不要把仲裁节点与主节点或者从节点放在一台机器</p>
</blockquote>
<h3 id="两种结构"><a href="#两种结构" class="headerlink" title="两种结构"></a>两种结构</h3><ul>
<li><strong>PSS</strong></li>
</ul>
<p>Primary + Secondary + Secondary模式，通过Primary和Secondary搭建的Replica Set</p>
<p><img src="/2019/09/16/mongodb/PSS.png" alt="PSS"></p>
<ul>
<li><strong>PSA</strong></li>
</ul>
<p>Primary + Secondary + Arbiter模式，使用Arbiter搭建Replica Set</p>
<p><img src="/2019/09/16/mongodb/PSA.png" alt="PSA"></p>
<p>偶数个数据节点，加一个Arbiter构成的Replica Set</p>
<h4 id="选举机制"><a href="#选举机制" class="headerlink" title="选举机制"></a>选举机制</h4><p>副本集通过 replSetInitiate 命令或 rs.initiate() 命令进行初始化。</p>
<p>初始化后各个节点开始发送心跳消息，并发起 Primary 选举操作，获得大多数成员投票支持的节点，会成为 Primary，其余节点成为 Secondary。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">config = &#123;</span><br><span class="line">    _id : "test_replset",   # 副本集名称</span><br><span class="line">    members : [</span><br><span class="line">        &#123;_id : 0, host : "rs1.example.net:27017"&#125;,      # 节点列表</span><br><span class="line">        &#123;<span class="attr">_id</span> : <span class="number">1</span>, <span class="attr">host</span> : <span class="string">"rs2.example.net:27017"</span>&#125;,</span><br><span class="line">        &#123;<span class="attr">_id</span> : <span class="number">2</span>, <span class="attr">host</span> : <span class="string">"rs3.example.net:27017"</span>&#125;,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">rs.initiate(config)</span><br></pre></td></tr></table></figure>

<p>假设复制集内投票成员（后续介绍）数量为 N，则大多数为 N/2 + 1，当复制集内存活成员数量不足大多数时，整个复制集将无法选举出 Primary，复制集将无法提供写服务，处于只读状态</p>
<ul>
<li><p>Mongodb副本集的选举基于Bully算法，这是一种协调者竞选算法</p>
</li>
<li><p>Primary 的选举受节点间心跳、优先级、最新的 oplog 时间等多种因素影响</p>
</li>
</ul>
<h5 id="特殊角色"><a href="#特殊角色" class="headerlink" title="特殊角色"></a><strong>特殊角色</strong></h5><ul>
<li>Arbiter</li>
</ul>
<p>Arbiter 节点只参与投票，不能被选为 Primary，并且不从 Primary 同步数据。</p>
<ul>
<li>Priority==0</li>
</ul>
<p>Priority0节点的选举优先级为0，不会被选举为 Primary。</p>
<ul>
<li>Vote==0</li>
</ul>
<p>Mongodb 3.0里，复制集成员最多50个，参与 Primary 选举投票的成员最多7个，其他成员（Vote0）的 vote 属性必须设置为0，即不参与投票。</p>
<ul>
<li>Hidden==true</li>
</ul>
<p>Hidden 署行的 节点不能被选为primary（Priority 为0），并且对client 不可见。</p>
<ul>
<li>Delayed==time seconds</li>
</ul>
<p>Delayed 节点必须是 Hidden 节点，否则会出现数据不一致的情况； 其数据落后与 Primary 一段时间（可配置，比如半小时1小时等）</p>
<h5 id="所有角色"><a href="#所有角色" class="headerlink" title="所有角色"></a>所有角色</h5><table>
<thead>
<tr>
<th><strong>Number</strong></th>
<th><strong>Name</strong></th>
<th><strong>State Description</strong></th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>STARTUP</td>
<td>还不是集群中的活跃点，读取配置阶段</td>
</tr>
<tr>
<td>1</td>
<td>PRIMARY</td>
<td>唯一的写节点</td>
</tr>
<tr>
<td>2</td>
<td>SECONDARY</td>
<td>从节点，主节点数据的拷贝</td>
</tr>
<tr>
<td>3</td>
<td>RECOVERING</td>
<td>Members either perform startup self-checks, or transition from completing a rollback or resync.</td>
</tr>
<tr>
<td>5</td>
<td>STARTUP2</td>
<td>已经加入集群，同步数据</td>
</tr>
<tr>
<td>6</td>
<td>UNKNOWN</td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>ARBITER</td>
<td>仲裁，投票选举primary</td>
</tr>
<tr>
<td>8</td>
<td>DOWN</td>
<td>不可达节点</td>
</tr>
<tr>
<td>9</td>
<td>ROLLBACK</td>
<td></td>
</tr>
<tr>
<td>10</td>
<td>REMOVED</td>
<td>c曾经再集群，但被移除</td>
</tr>
</tbody></table>
<h5 id="触发选举条件"><a href="#触发选举条件" class="headerlink" title="触发选举条件"></a><strong>触发选举条件</strong></h5><ul>
<li>新增一个节点到副本集</li>
<li>初始化一个副本集</li>
<li>primary放弃角色，如 rs.stepDown()/rs.reconfig()</li>
<li>从库不能连接到主库(默认超过10s，可通过heartbeatTimeoutSecs参数控制)，由从库发起选举</li>
</ul>
<p>副本集的自动failover是通过心跳检测实现的，进而实现高可用</p>
<p><img src="/2019/09/16/mongodb/mongo-failover.png" alt="mongo-failover"></p>
<h3 id="读写配置"><a href="#读写配置" class="headerlink" title="读写配置"></a>读写配置</h3><p><strong>Read Preference</strong></p>
<blockquote>
<p>All read preference modes except primary may return stale data because secondaries replicate operations from the primary with some delay. Ensure that your application can tolerate stale data if you choose to use a non-primary mode.</p>
<p>除了primary节点，其他的都有可能读到脏数据。保证你的app能够容忍脏数据</p>
</blockquote>
<table>
<thead>
<tr>
<th><strong>Read Preference Mode</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody><tr>
<td>primary</td>
<td>优先主节点，默认<br><br> Multi-document transactions that contain read operations must use read preference primary. All operations in a given transaction must route to the same member.</td>
</tr>
<tr>
<td>primaryPreferred</td>
<td>主节点优先，主不可用，读从节点</td>
</tr>
<tr>
<td>secondary</td>
<td>从节点读取</td>
</tr>
<tr>
<td>secondaryPreferred</td>
<td>从节点优先，没有从节点可用，读主节点</td>
</tr>
<tr>
<td>nearest</td>
<td>网络延迟最少的节点，不管主从</td>
</tr>
</tbody></table>
<p><strong>Write Concern</strong></p>
<blockquote>
<p>Write concern describes the level of acknowledgment requested from MongoDB for write operations</p>
<p>写操作的确认</p>
</blockquote>
<p>选项如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; w: &lt;value&gt;, j: &lt;boolean&gt;, wtimeout: &lt;number&gt; &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>w: 写操作已经传播了几个mongod实例</p>
<p>j: 等待写操作写入磁盘journal</p>
<p>wtimeout: 写操作阻塞时间</p>
</blockquote>
<table>
<thead>
<tr>
<th>value</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td><number></number></td>
<td>w: 1,默认值（写入主节点）<br>w: 0,不需要确认写操作，可能会抛出异常<br>w: &gt;1,</td>
</tr>
<tr>
<td>majority</td>
<td>大多数数据可投票节点</td>
</tr>
<tr>
<td><custom write concern name></custom></td>
<td>写入一个标记的节点</td>
</tr>
</tbody></table>
<blockquote>
<p><strong>Hidden</strong>, <strong>delayed</strong>, and <strong>priority 0</strong> members with member[n].votes greater than 0 can acknowledge majority write operations.</p>
</blockquote>
<p><strong>Read Concern</strong>（一致性/隔离性）</p>
<table>
<thead>
<tr>
<th>level</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>local</td>
<td></td>
</tr>
<tr>
<td>available</td>
<td></td>
</tr>
<tr>
<td>marjority</td>
<td></td>
</tr>
<tr>
<td>linearizable</td>
<td></td>
</tr>
<tr>
<td>snapshot</td>
<td></td>
</tr>
</tbody></table>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><ul>
<li>db version v4.2.0</li>
<li>配置文件，复制三份，修改</li>
</ul>
<p>path/dbPath/pidFilePath</p>
<p>bindIp：如果外网，需要将ip绑定为0.0.0.0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"># for documentation of all options, see:</span><br><span class="line">#   http://docs.mongodb.org/manual/reference/configuration-options/</span><br><span class="line"></span><br><span class="line"># where to write logging data.</span><br><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: true</span><br><span class="line">  path: /var/log/mongodb/mongod-27017.log</span><br><span class="line"></span><br><span class="line"># Where and how to store data.</span><br><span class="line">storage:</span><br><span class="line">  dbPath: /var/lib/mongo-27017</span><br><span class="line">  journal:</span><br><span class="line">    enabled: true</span><br><span class="line">#  engine:</span><br><span class="line">#  wiredTiger:</span><br><span class="line"></span><br><span class="line"># how the process runs</span><br><span class="line">processManagement:</span><br><span class="line">  fork: true  # fork and run in background</span><br><span class="line">  pidFilePath: /var/run/mongodb/mongod-27017.pid  # location of pidfile</span><br><span class="line">  timeZoneInfo: /usr/share/zoneinfo</span><br><span class="line"></span><br><span class="line"># network interfaces</span><br><span class="line">net:</span><br><span class="line">  port: 27017</span><br><span class="line">  bindIp: 127.0.0.1  # Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#security:</span><br><span class="line"></span><br><span class="line">#operationProfiling:</span><br><span class="line"></span><br><span class="line">replication:</span><br><span class="line">    replSetName: screensaver    # replset名称，同一副本集取值相同</span><br><span class="line">    oplogSizeMB: 4096</span><br><span class="line"></span><br><span class="line">#sharding:</span><br><span class="line"></span><br><span class="line">## Enterprise-Only Options</span><br><span class="line"></span><br><span class="line">#auditLog:</span><br><span class="line"></span><br><span class="line">#snmp:</span><br></pre></td></tr></table></figure>

<p>这里我搞了三个，启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mongod -f /etc/mongod-27017.conf</span><br><span class="line">mongod -f /etc/mongod-27018.conf</span><br><span class="line">mongod -f /etc/mongod-27019.conf</span><br></pre></td></tr></table></figure>

<p>随便进入一个实例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">&gt; rs.status()</span><br><span class="line">&#123;</span><br><span class="line">	&quot;operationTime&quot; : Timestamp(0, 0),</span><br><span class="line">	&quot;ok&quot; : 0,</span><br><span class="line">	&quot;errmsg&quot; : &quot;no replset config has been received&quot;,</span><br><span class="line">	&quot;code&quot; : 94,</span><br><span class="line">	&quot;codeName&quot; : &quot;NotYetInitialized&quot;,</span><br><span class="line">	&quot;$clusterTime&quot; : &#123;</span><br><span class="line">		&quot;clusterTime&quot; : Timestamp(0, 0),</span><br><span class="line">		&quot;signature&quot; : &#123;</span><br><span class="line">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">			&quot;keyId&quot; : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">&gt; rs.initiate()</span><br><span class="line">&#123;</span><br><span class="line">	&quot;info2&quot; : &quot;no configuration specified. Using a default configuration for the set&quot;,</span><br><span class="line">	&quot;me&quot; : &quot;127.0.0.1:27017&quot;,</span><br><span class="line">	&quot;ok&quot; : 1,</span><br><span class="line">	&quot;$clusterTime&quot; : &#123;</span><br><span class="line">		&quot;clusterTime&quot; : Timestamp(1568625811, 1),</span><br><span class="line">		&quot;signature&quot; : &#123;</span><br><span class="line">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">			&quot;keyId&quot; : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;operationTime&quot; : Timestamp(1568625811, 1)</span><br><span class="line">&#125;</span><br><span class="line">screensaver:OTHER&gt; rs.status()</span><br><span class="line">&#123;</span><br><span class="line">	&quot;set&quot; : &quot;screensaver&quot;,</span><br><span class="line">	&quot;date&quot; : ISODate(&quot;2019-09-16T09:23:35.861Z&quot;),</span><br><span class="line">	&quot;myState&quot; : 1,</span><br><span class="line">	&quot;term&quot; : NumberLong(1),</span><br><span class="line">	&quot;syncingTo&quot; : &quot;&quot;,</span><br><span class="line">	&quot;syncSourceHost&quot; : &quot;&quot;,</span><br><span class="line">	&quot;syncSourceId&quot; : -1,</span><br><span class="line">	&quot;heartbeatIntervalMillis&quot; : NumberLong(2000),</span><br><span class="line">	&quot;optimes&quot; : &#123;</span><br><span class="line">		&quot;lastCommittedOpTime&quot; : &#123;</span><br><span class="line">			&quot;ts&quot; : Timestamp(1568625814, 4),</span><br><span class="line">			&quot;t&quot; : NumberLong(1)</span><br><span class="line">		&#125;,</span><br><span class="line">		&quot;lastCommittedWallTime&quot; : ISODate(&quot;2019-09-16T09:23:34.040Z&quot;),</span><br><span class="line">		&quot;readConcernMajorityOpTime&quot; : &#123;</span><br><span class="line">			&quot;ts&quot; : Timestamp(1568625814, 4),</span><br><span class="line">			&quot;t&quot; : NumberLong(1)</span><br><span class="line">		&#125;,</span><br><span class="line">		&quot;readConcernMajorityWallTime&quot; : ISODate(&quot;2019-09-16T09:23:34.040Z&quot;),</span><br><span class="line">		&quot;appliedOpTime&quot; : &#123;</span><br><span class="line">			&quot;ts&quot; : Timestamp(1568625814, 4),</span><br><span class="line">			&quot;t&quot; : NumberLong(1)</span><br><span class="line">		&#125;,</span><br><span class="line">		&quot;durableOpTime&quot; : &#123;</span><br><span class="line">			&quot;ts&quot; : Timestamp(1568625814, 4),</span><br><span class="line">			&quot;t&quot; : NumberLong(1)</span><br><span class="line">		&#125;,</span><br><span class="line">		&quot;lastAppliedWallTime&quot; : ISODate(&quot;2019-09-16T09:23:34.040Z&quot;),</span><br><span class="line">		&quot;lastDurableWallTime&quot; : ISODate(&quot;2019-09-16T09:23:34.040Z&quot;)</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;lastStableRecoveryTimestamp&quot; : Timestamp(1568625814, 4),</span><br><span class="line">	&quot;lastStableCheckpointTimestamp&quot; : Timestamp(1568625814, 4),</span><br><span class="line">	&quot;members&quot; : [</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;_id&quot; : 0,</span><br><span class="line">			&quot;name&quot; : &quot;127.0.0.1:27017&quot;,</span><br><span class="line">			&quot;ip&quot; : &quot;127.0.0.1&quot;,</span><br><span class="line">			&quot;health&quot; : 1,</span><br><span class="line">			&quot;state&quot; : 1,</span><br><span class="line">			&quot;stateStr&quot; : &quot;PRIMARY&quot;,</span><br><span class="line">			&quot;uptime&quot; : 19222,</span><br><span class="line">			&quot;optime&quot; : &#123;</span><br><span class="line">				&quot;ts&quot; : Timestamp(1568625814, 4),</span><br><span class="line">				&quot;t&quot; : NumberLong(1)</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;optimeDate&quot; : ISODate(&quot;2019-09-16T09:23:34Z&quot;),</span><br><span class="line">			&quot;syncingTo&quot; : &quot;&quot;,</span><br><span class="line">			&quot;syncSourceHost&quot; : &quot;&quot;,</span><br><span class="line">			&quot;syncSourceId&quot; : -1,</span><br><span class="line">			&quot;infoMessage&quot; : &quot;could not find member to sync from&quot;,</span><br><span class="line">			&quot;electionTime&quot; : Timestamp(1568625811, 2),</span><br><span class="line">			&quot;electionDate&quot; : ISODate(&quot;2019-09-16T09:23:31Z&quot;),</span><br><span class="line">			&quot;configVersion&quot; : 1,</span><br><span class="line">			&quot;self&quot; : true,</span><br><span class="line">			&quot;lastHeartbeatMessage&quot; : &quot;&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	&quot;ok&quot; : 1,</span><br><span class="line">	&quot;$clusterTime&quot; : &#123;</span><br><span class="line">		&quot;clusterTime&quot; : Timestamp(1568625814, 4),</span><br><span class="line">		&quot;signature&quot; : &#123;</span><br><span class="line">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">			&quot;keyId&quot; : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;operationTime&quot; : Timestamp(1568625814, 4)</span><br><span class="line">&#125;</span><br><span class="line">screensaver:PRIMARY&gt;</span><br></pre></td></tr></table></figure>

<p>初始化后，该实例成为primary，单机实例，增加其他节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">screensaver:PRIMARY&gt; rs.add(&apos;127.0.0.1:27018&apos;)</span><br><span class="line">&#123;</span><br><span class="line">	&quot;ok&quot; : 1,</span><br><span class="line">	&quot;$clusterTime&quot; : &#123;</span><br><span class="line">		&quot;clusterTime&quot; : Timestamp(1568625914, 2),</span><br><span class="line">		&quot;signature&quot; : &#123;</span><br><span class="line">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">			&quot;keyId&quot; : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;operationTime&quot; : Timestamp(1568625914, 2)</span><br><span class="line">&#125;</span><br><span class="line">screensaver:PRIMARY&gt; rs.addArb(&apos;127.0.0.1:27019&apos;)</span><br><span class="line">&#123;</span><br><span class="line">	&quot;ok&quot; : 1,</span><br><span class="line">	&quot;$clusterTime&quot; : &#123;</span><br><span class="line">		&quot;clusterTime&quot; : Timestamp(1568625931, 1),</span><br><span class="line">		&quot;signature&quot; : &#123;</span><br><span class="line">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">			&quot;keyId&quot; : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;operationTime&quot; : Timestamp(1568625931, 1)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此， PSA 模式的集群已经创建成功</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2019/09/11/hexo-image/">hexo引用图片无法显示</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://shiguofu2012.github.io/page/3/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2019-09-11T10:08:16.000Z" itemprop="datePublished">2019-09-11</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/hexo/">hexo</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>最近使用hexo，但是发现在文章中引用本地图片时总是显示不出来。</p>
<h4 id="插件安装与配置"><a href="#插件安装与配置" class="headerlink" title="插件安装与配置"></a>插件安装与配置</h4><p>首先我们需要安装一个图片路径转换的插件，这个插件名字是<strong>hexo-asset-image</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-asset-image --save</span><br></pre></td></tr></table></figure>

<p>但是这个插件的内容需要修改，不然还是会出现图片无法显示的问题。</p>
<p>打开node_modules/hexo-asset-image/index.js，将内容更换为下面的代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"><span class="keyword">var</span> cheerio = <span class="built_in">require</span>(<span class="string">'cheerio'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPosition</span>(<span class="params">str, m, i</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> str.split(m, i).join(m).length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> version = <span class="built_in">String</span>(hexo.version).split(<span class="string">'.'</span>);</span><br><span class="line">hexo.extend.filter.register(<span class="string">'after_post_render'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> config = hexo.config;</span><br><span class="line">  <span class="keyword">if</span>(config.post_asset_folder)&#123;</span><br><span class="line">    	<span class="keyword">var</span> link = data.permalink;</span><br><span class="line">	<span class="keyword">if</span>(version.length &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">Number</span>(version[<span class="number">0</span>]) == <span class="number">3</span>)</span><br><span class="line">	   <span class="keyword">var</span> beginPos = getPosition(link, <span class="string">'/'</span>, <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	   <span class="keyword">var</span> beginPos = getPosition(link, <span class="string">'/'</span>, <span class="number">3</span>) + <span class="number">1</span>;</span><br><span class="line">	<span class="comment">// In hexo 3.1.1, the permalink of "about" page is like ".../about/index.html".</span></span><br><span class="line">	<span class="keyword">var</span> endPos = link.lastIndexOf(<span class="string">'/'</span>) + <span class="number">1</span>;</span><br><span class="line">    link = link.substring(beginPos, endPos);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> toprocess = [<span class="string">'excerpt'</span>, <span class="string">'more'</span>, <span class="string">'content'</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; toprocess.length; i++)&#123;</span><br><span class="line">      <span class="keyword">var</span> key = toprocess[i];</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">var</span> $ = cheerio.load(data[key], &#123;</span><br><span class="line">        ignoreWhitespace: <span class="literal">false</span>,</span><br><span class="line">        xmlMode: <span class="literal">false</span>,</span><br><span class="line">        lowerCaseTags: <span class="literal">false</span>,</span><br><span class="line">        decodeEntities: <span class="literal">false</span></span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      $(<span class="string">'img'</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ($(<span class="keyword">this</span>).attr(<span class="string">'src'</span>))&#123;</span><br><span class="line">			<span class="comment">// For windows style path, we replace '\' to '/'.</span></span><br><span class="line">			<span class="keyword">var</span> src = $(<span class="keyword">this</span>).attr(<span class="string">'src'</span>).replace(<span class="string">'\\'</span>, <span class="string">'/'</span>);</span><br><span class="line">			<span class="keyword">if</span>(!<span class="regexp">/http[s]*.*|\/\/.*/</span>.test(src) &amp;&amp;</span><br><span class="line">			   !<span class="regexp">/^\s*\//</span>.test(src)) &#123;</span><br><span class="line">			  <span class="comment">// For "about" page, the first part of "src" can't be removed.</span></span><br><span class="line">			  <span class="comment">// In addition, to support multi-level local directory.</span></span><br><span class="line">			  <span class="keyword">var</span> linkArray = link.split(<span class="string">'/'</span>).filter(<span class="function"><span class="keyword">function</span>(<span class="params">elem</span>)</span>&#123;</span><br><span class="line">				<span class="keyword">return</span> elem != <span class="string">''</span>;</span><br><span class="line">			  &#125;);</span><br><span class="line">			  <span class="keyword">var</span> srcArray = src.split(<span class="string">'/'</span>).filter(<span class="function"><span class="keyword">function</span>(<span class="params">elem</span>)</span>&#123;</span><br><span class="line">				<span class="keyword">return</span> elem != <span class="string">''</span> &amp;&amp; elem != <span class="string">'.'</span>;</span><br><span class="line">			  &#125;);</span><br><span class="line">			  <span class="keyword">if</span>(srcArray.length &gt; <span class="number">1</span>)</span><br><span class="line">				srcArray.shift();</span><br><span class="line">			  src = srcArray.join(<span class="string">'/'</span>);</span><br><span class="line">			  $(<span class="keyword">this</span>).attr(<span class="string">'src'</span>, config.root + link + src);</span><br><span class="line">			  <span class="built_in">console</span>.info&amp;&amp;<span class="built_in">console</span>.info(<span class="string">"update link as:--&gt;"</span>+config.root + link + src);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.info&amp;&amp;<span class="built_in">console</span>.info(<span class="string">"no src attr, skipped..."</span>);</span><br><span class="line">			<span class="built_in">console</span>.info&amp;&amp;<span class="built_in">console</span>.info($(<span class="keyword">this</span>));</span><br><span class="line">		&#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      data[key] = $.html();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>打开_config.yml文件，修改下述内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">post_asset_folder: true</span><br><span class="line">url: &lt;你的github page地址或者其他域名&gt;</span><br></pre></td></tr></table></figure>

<h4 id="重新生成"><a href="#重新生成" class="headerlink" title="重新生成"></a>重新生成</h4><h5 id="修改后，新建博客"><a href="#修改后，新建博客" class="headerlink" title="修改后，新建博客"></a>修改后，新建博客</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new test</span><br></pre></td></tr></table></figure>

<p>会发现在source/_posts目录中，新建了test.md与同名的文件夹(<strong>test</strong>)</p>
<h5 id="重新生成html文件，看到输出"><a href="#重新生成html文件，看到输出" class="headerlink" title="重新生成html文件，看到输出"></a>重新生成html文件，看到输出</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update link as:--&gt;//&lt;url&gt;/2019/09/11/xxxx/1568192562650.png</span><br></pre></td></tr></table></figure>

<p>访问即可看见图片出来啦！</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2019/09/11/jenkins部署nodejs/">jenkins</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://shiguofu2012.github.io/page/3/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2019-09-11T08:56:18.000Z" itemprop="datePublished">2019-09-11</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/service/">service</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h4 id="jenkins-安装"><a href="#jenkins-安装" class="headerlink" title="jenkins 安装"></a>jenkins 安装</h4><h5 id="jdk安装"><a href="#jdk安装" class="headerlink" title="jdk安装"></a>jdk安装</h5><ol>
<li>采用java8， 到官网下载jdk</li>
<li>解压配置， JAVA_HOME PATH，执行如下</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@wpspic5 ~]# java -version </span><br><span class="line">openjdk version "1.8.0_161"</span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_161-b14)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.161-b14, mixed mode)</span><br></pre></td></tr></table></figure>

<h5 id="Jenkins-安装"><a href="#Jenkins-安装" class="headerlink" title="Jenkins 安装"></a>Jenkins 安装</h5><ol>
<li><strong>下载RPM包安装</strong></li>
</ol>
<p>jenkins安装也比较简单，有相应的rpm安装包</p>
<p><a href="https://pkg.jenkins.io/redhat-stable/" target="_blank" rel="noopener">官网地址</a> 选择合适的版本，下载安装</p>
<ol start="2">
<li><strong>yum安装</strong></li>
</ol>
<p>导入yum源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo</span><br><span class="line">sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key</span><br></pre></td></tr></table></figure>

<p>安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install jenkins</span><br></pre></td></tr></table></figure>

<h4 id="jenkins-配置"><a href="#jenkins-配置" class="headerlink" title="jenkins 配置"></a>jenkins 配置</h4><p>默认端口号是8080，直接访问，会进行一些初始化，及插件的安装</p>
<p><img src="/2019/09/11/jenkins部署nodejs/1568192562650.png" alt="1568192488358"></p>
<p><strong>jenkins版本： 2.176.3-1.1</strong></p>
<ol>
<li><h4 id="部署节点配置"><a href="#部署节点配置" class="headerlink" title="部署节点配置"></a><strong>部署节点配置</strong></h4></li>
</ol>
<ul>
<li><p>进入jenkins主界面，点击左侧菜单的 “<strong>系统管理-&gt;系统设置</strong>”，拖动配置项到“Publish on ssh”</p>
</li>
<li><p>新增登录主机的ssh private key/ password的登录信息</p>
<p><img src="/2019/09/11/jenkins部署nodejs/jenkins-1.png" alt="jenkins-1"></p>
</li>
<li><p>增加节点，包括登录主机的用户名，IP地址，工作目录等, 可以新增多个节点</p>
<ul>
<li>Name: 主机标识符，用于区分</li>
<li>Hostname： 主机ip地址</li>
<li>Username: 登录主机的用户名</li>
<li>Remote Directory： 远端工作目录</li>
</ul>
</li>
</ul>
<p><img src="/2019/09/11/jenkins部署nodejs/jenkins-host.png" alt="jenkins-host"></p>
<ol start="2">
<li><h4 id="部署配置"><a href="#部署配置" class="headerlink" title="部署配置"></a><strong>部署配置</strong></h4></li>
</ol>
<ul>
<li><p>新建部署项，在主页左边栏，“<strong>新建任务</strong>“，起个有意义的名称，下面选择”<strong>自由风格的软件项目</strong>“</p>
<p>找到源码管理，配置Git 的Repo/credit(获取代码的key),  分支；</p>
<p>如果可以正常获取，不会出现提示</p>
<p><img src="/2019/09/11/jenkins部署nodejs/jenkins-source.png" alt="jenkins-source"></p>
<p>否则会出现如下提示，检查repo的配置是否写错误；检查key是不是有权限拉取代码</p>
</li>
</ul>
<p><img src="/2019/09/11/jenkins部署nodejs/jenkins-source-1.png" alt="jenkins-source-1"></p>
<ul>
<li><p>找到”<strong>构建</strong>“ 选项</p>
<ul>
<li>加入构建的命令，即打包操作（进入到工作目录，直接打包）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd $WORKSPACE</span><br><span class="line">TAR_NAME=wps_eb_`date +%Y-%m-%d`.tar</span><br><span class="line">tar -cf $TAR_NAME ./</span><br></pre></td></tr></table></figure>

<ul>
<li>增加构建步骤，选择 ”send files or execute commands over SSH“, 采用ssh发送项目文件到目标机器并执行命令部署</li>
</ul>
<p><img src="/2019/09/11/jenkins部署nodejs/jenkins-build.png" alt="1567994464334"></p>
<ul>
<li>增加发送到目标机器后的操作命令，依赖于项目文件 (release/project_init.sh)</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">file_name=wps_eb_`date +%Y-%m-%d`.tar</span><br><span class="line">tmp_dir=/tmp/wps_eb_tmp</span><br><span class="line">log_dir=/data/log/pm2/wps_eb-admin</span><br><span class="line">echo $file_name</span><br><span class="line">sudo rm -rf  $tmp_dir</span><br><span class="line">sudo mkdir -p $tmp_dir</span><br><span class="line">sudo tar -xf /tmp/$file_name -C $tmp_dir ./release/*</span><br><span class="line">cd $tmp_dir/release</span><br><span class="line">sudo ./project_init.sh /tmp/$file_name</span><br></pre></td></tr></table></figure>



</li>
</ul>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2019/09/11/一些shell脚本/">一些shell脚本</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://shiguofu2012.github.io/page/3/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2019-09-11T06:50:17.000Z" itemprop="datePublished">2019-09-11</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/shell/">shell</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>最近在搞部署项目的功能，写了不少shell脚本，总结一下</p>
<h4 id="1-sftp上传支持多条命令，用awk分隔文件路径获取文件名称（-NF表示最后一列）"><a href="#1-sftp上传支持多条命令，用awk分隔文件路径获取文件名称（-NF表示最后一列）" class="headerlink" title="1. sftp上传支持多条命令，用awk分隔文件路径获取文件名称（$NF表示最后一列）"></a>1. sftp上传支持多条命令，用awk分隔文件路径获取文件名称（$NF表示最后一列）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash                                                                                                                           </span><br><span class="line">function check() &#123;</span><br><span class="line">    if [ -z $1 ]; then</span><br><span class="line">        echo "please give the filename"</span><br><span class="line">        return</span><br><span class="line">    fi  </span><br><span class="line">    if [ ! -f $1 ]; then</span><br><span class="line">        echo "file not exists, exit..."</span><br><span class="line">        return</span><br><span class="line">    fi  </span><br><span class="line">    echo "ls" &gt; command.txt</span><br><span class="line">    echo "cd bj6-c-grb-screen-admin01/史国富" &gt;&gt; command.txt</span><br><span class="line">    echo "put $1" &gt;&gt; command.txt</span><br><span class="line">    filename=`echo $1 | awk -F/ '&#123;print $NF&#125;'`</span><br><span class="line">    echo $filename</span><br><span class="line">    echo "ls $filename" &gt;&gt; command.txt</span><br><span class="line">    sftp -P 2222 shiguofu@120.92.118.51 &lt; command.txt</span><br><span class="line">    echo "Done"</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">check $1</span><br></pre></td></tr></table></figure>

<h4 id="2-部署项目，未增加测试环境标识（sed修改），手动修改文件"><a href="#2-部署项目，未增加测试环境标识（sed修改），手动修改文件" class="headerlink" title="2. 部署项目，未增加测试环境标识（sed修改），手动修改文件"></a>2. 部署项目，未增加测试环境标识（sed修改），手动修改文件</h4><p>环境变量传入： 由于sudo 会重新初始化环境变量，因此，可以在脚本中传入执行的变量PATH等</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">WALLE_NODE=10.13.88.152</span><br><span class="line">WALLE_USER=root</span><br><span class="line">WALLE_PASSWD=1qaz@WSX</span><br><span class="line">zip_file_name=wps_eb_admin_`date +%Y%m%d%H%M%S`.tar</span><br><span class="line">remote_dest_dir=/tmp</span><br><span class="line">TEST_NODE=10.226.50.22</span><br><span class="line"></span><br><span class="line">function copy_to_walle()</span><br><span class="line">&#123;</span><br><span class="line">    echo "copy to $WALLE_NODE"</span><br><span class="line">    cd ..</span><br><span class="line">    echo "tar service files..."</span><br><span class="line">    tar -cf /tmp/$zip_file_name ./*</span><br><span class="line">    echo "Done. tar file -&gt; /tmp/$zip_file_name"</span><br><span class="line">    sshpass -p "$WALLE_PASSWD" scp /tmp/$zip_file_name $WALLE_USER@$WALLE_NODE:$remote_dest_dir</span><br><span class="line">    echo "copy to remote Done."</span><br><span class="line">    sshpass -p "$WALLE_PASSWD" ssh $WALLE_USER@$WALLE_NODE "</span><br><span class="line">    rm -rf /tmp/wps_eb_tmp</span><br><span class="line">    mkdir -p /tmp/wps_eb_tmp</span><br><span class="line">    tar -xf /tmp/$zip_file_name -C /tmp/wps_eb_tmp</span><br><span class="line">    "</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function deploy()</span><br><span class="line">&#123;</span><br><span class="line">    if [ -z $1 ]; then</span><br><span class="line">        echo "please give the ip address as the first param"</span><br><span class="line">        return</span><br><span class="line">    fi</span><br><span class="line">    USER=root</span><br><span class="line">    echo "deploy to test: $1"</span><br><span class="line">    echo "tar service files..."</span><br><span class="line">    tar -cf /tmp/$zip_file_name ./*</span><br><span class="line">    echo "Done. tar file -&gt; /tmp/$zip_file_name"</span><br><span class="line">    if [ ! -z $2 ]; then</span><br><span class="line">        USER=$2</span><br><span class="line">    fi</span><br><span class="line">    if [ ! -z $3 ]; then</span><br><span class="line">        sshpass -p "$3" scp /tmp/$zip_file_name $USER@$1:$remote_dest_dir</span><br><span class="line">        sshpass -p "$3" ssh $USER@$1 &lt;&lt; eeooff</span><br><span class="line">        sudo -i</span><br><span class="line">        tar -xf $remote_dest_dir/$zip_file_name -C /tmp/ ./release/*;</span><br><span class="line">        cd /tmp/release</span><br><span class="line">        PATH=$PATH:/usr/local/bin &amp;&amp; ./project_init.sh $remote_dest_dir/$zip_file_name</span><br><span class="line">eeooff</span><br><span class="line">    else</span><br><span class="line">        scp /tmp/$zip_file_name $USER@$1:$remote_dest_dir</span><br><span class="line">        echo "Done copy to remote host..."</span><br><span class="line">        ssh $USER@$1 &lt;&lt; eeooff</span><br><span class="line">        sudo -i</span><br><span class="line">        tar -xf $remote_dest_dir/$zip_file_name -C /tmp/ ./release/*;</span><br><span class="line">        cd /tmp/release</span><br><span class="line">        . /etc/profile &amp;&amp; ./project_init.sh $remote_dest_dir/$zip_file_name</span><br><span class="line">eeooff</span><br><span class="line">    fi</span><br><span class="line">    rm /tmp/$zip_file_name</span><br><span class="line">    # ./project_init.sh $remote_dest_dir/$zip_file_name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function deploy_test()</span><br><span class="line">&#123;</span><br><span class="line">    cd ..</span><br><span class="line">    sed -i 's/production/development/g' pm2.json</span><br><span class="line">    deploy 10.226.50.22 root 123456</span><br><span class="line">    sed -i 's/development/production/g' pm2.json</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">echo $1</span><br><span class="line">if [ -z $1 ]; then</span><br><span class="line">    deploy_test</span><br><span class="line">elif [ "$1" == "walle" ]; then</span><br><span class="line">    copy_to_walle</span><br><span class="line">else</span><br><span class="line">    cd ..</span><br><span class="line">    deploy $1 $2 $3</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h4 id="3-初始化服务环境，安装必要的包"><a href="#3-初始化服务环境，安装必要的包" class="headerlink" title="3. 初始化服务环境，安装必要的包"></a>3. 初始化服务环境，安装必要的包</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash                                                                                                                                                                    </span><br><span class="line">SOFT_DIR=/data/soft</span><br><span class="line"> </span><br><span class="line">function install_webp()&#123;</span><br><span class="line">    cd $SOFT_DIR</span><br><span class="line">    wget https://storage.googleapis.com/downloads.webmproject.org/releases/webp/libwebp-1.0.3-linux-x86-64.tar.gz</span><br><span class="line">    tar -xf libwebp-1.0.3-linux-x86-64.tar.gz</span><br><span class="line">    cd libwebp-1.0.3-linux-x86-64/bin</span><br><span class="line">    if [ -f /usr/bin/cwebp ]; then</span><br><span class="line">        mv /usr/bin/cwebp /usr/bin/cweb.bak</span><br><span class="line">    fi</span><br><span class="line">    cp cwebp /usr/bin/</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">function install_node()&#123;</span><br><span class="line">    cd $SOFT_DIR</span><br><span class="line">    wget https://nodejs.org/dist/v10.13.0/node-v10.13.0-linux-x64.tar.xz</span><br><span class="line">    tar xvf node-v10.13.0-linux-x64.tar.xz</span><br><span class="line">    echo "export PATH=$PATH:$SOFT_DIR/node-v10.13.0-linux-x64/bin" &gt;&gt; /etc/profile</span><br><span class="line">    echo "export NODE_PATH=/data/soft/node-v10.13.0-linux-x64/lib/node_modules" &gt;&gt; /etc/profile</span><br><span class="line">    source /etc/profile</span><br><span class="line">    npm install pm2 -g</span><br><span class="line">    echo "10.13.0.29 wpsgit.xxx.net" &gt;&gt; /etc/hosts</span><br><span class="line">    echo "10.13.0.98 cdnshow.xxx.kingsoft.net" &gt;&gt; /etc/hosts</span><br><span class="line">    echo "120.92.115.93 suc.xxx.kingsoft.net" &gt;&gt; /etc/hosts</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span> mongodb 下载地址：https://repo.mongodb.org/yum/redhat/7/mongodb-org/3.4/x86_64/RPMS/ </span><br><span class="line"> </span><br><span class="line">if [ ! -d $SOFT_DIR ];then</span><br><span class="line">    rm -rf $SOFT_DIR</span><br><span class="line">    mkdir -p $SOFT_DIR</span><br><span class="line">fi</span><br><span class="line">which cwebp                                     # 采用which判断是否存在，获取返回值</span><br><span class="line">code=`echo $?`</span><br><span class="line">echo $code</span><br><span class="line">if [ $code != 0 ]; then</span><br><span class="line">    install_webp</span><br><span class="line">fi</span><br><span class="line">which npm</span><br><span class="line">code=`echo $?`</span><br><span class="line">if [ $code != 0 ]; then</span><br><span class="line">    install_node</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h4 id="4-服务初始化脚本"><a href="#4-服务初始化脚本" class="headerlink" title="4. 服务初始化脚本"></a>4. 服务初始化脚本</h4><p>服务需要sudo 执行， 增加了source 初始化环境的头</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line">source /etc/profile</span><br><span class="line"> </span><br><span class="line">function init()</span><br><span class="line">&#123;</span><br><span class="line">    if [ ! -z $1 ] &amp;&amp; [ -d $1 ]; then</span><br><span class="line">        final_dir=$1;</span><br><span class="line">    else</span><br><span class="line">        echo "$1 did not exists... exit"</span><br><span class="line">        return</span><br><span class="line">    fi  </span><br><span class="line">    echo "install package..."</span><br><span class="line">    cd $1</span><br><span class="line">    if [ ! -z $2 ]; then</span><br><span class="line">        sed -i "s/production/$2/g" pm2.json</span><br><span class="line">    fi  </span><br><span class="line">    source /etc/profile</span><br><span class="line">    npm config set @wps:registry http://120.92.93.69:4873</span><br><span class="line">    npm install --no-save --production</span><br><span class="line">    npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br><span class="line">    cnpm install canvas</span><br><span class="line">    echo "install Done."</span><br><span class="line">    echo "stop service sxxx-eb.."</span><br><span class="line">    sh -c 'source /etc/profile &amp;&amp; pm2 delete wps_eb-admin' &amp;&gt;/tmp/pm2.log</span><br><span class="line">    echo "stopped"</span><br><span class="line">    sleep 1</span><br><span class="line">    echo "start service xxx-eb"</span><br><span class="line">    sh -c 'source /etc/profile &amp;&amp; pm2 start pm2.json' &amp;&gt;/tmp/pm2.log</span><br><span class="line">    echo "start Done."</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">function deploy_by_tar()</span><br><span class="line">&#123;</span><br><span class="line">    release_dir=/data/www</span><br><span class="line">    dest_dir=/data/release/xxx_ebook_admin/`date +%Y%m%d-%H%M%S`</span><br><span class="line">    final_xxx_ebook_dir=$release_dir/xxx_ebook_admin</span><br><span class="line">    if [ ! -z $1 ] &amp;&amp; [ -f $1 ]; then</span><br><span class="line">        echo "deploy with $1..."</span><br><span class="line">        zip_file_name=$1</span><br><span class="line">    else</span><br><span class="line">        echo "$1 did not exists... exit"</span><br><span class="line">        return</span><br><span class="line">    fi  </span><br><span class="line">    mkdir -p $release_dir</span><br><span class="line">    mkdir -p $dest_dir</span><br><span class="line">    echo "untar package to $dest_dir"</span><br><span class="line">    `tar -xf $zip_file_name -C $dest_dir`</span><br><span class="line">    echo "untar Done."</span><br><span class="line">    echo "ln -sfn $dest_dir $final_xxx_ebook_dir"</span><br><span class="line">    ln -sfn $dest_dir $final_xxx_ebook_dir</span><br><span class="line">    echo 'Done.'</span><br><span class="line">    init $final_wps_ebook_dir $2</span><br><span class="line">    rm $zip_file_name</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">./init_env.sh</span><br><span class="line">deploy_by_tar $1 $2</span><br></pre></td></tr></table></figure>


        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2019/09/04/shell知识点/">shell知识点.md</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://shiguofu2012.github.io/page/3/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2019-09-04T07:25:01.000Z" itemprop="datePublished">2019-09-04</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/shell/">shell</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h4 id="1-shell函数参数传递不需要在参数列表，是通过-1-2…-这样获取，如"><a href="#1-shell函数参数传递不需要在参数列表，是通过-1-2…-这样获取，如" class="headerlink" title="1. shell函数参数传递不需要在参数列表，是通过$1, $2….这样获取，如"></a>1. shell函数参数传递不需要在参数列表，是通过$1, $2….这样获取，如</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line">function deploy_one_host()                           # 函数定义，小括号不是必须的</span><br><span class="line">&#123;</span><br><span class="line">    cd wps_pic</span><br><span class="line">    zip_file_name=wps_pic_`date +%Y%m%d%H%M%S`.zip</span><br><span class="line">    zip "$zip_file_name" ./* -q</span><br><span class="line">    scp $zip_file_name root@$1:/tmp                  # 获取第一个参数</span><br><span class="line">    ssh root@$1 "sh exec.sh $zip_file_name;"         # ssh 在远端执行命令，多个以分号分隔</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">deploy_one_host 10.229.26.143                       # 传递一个参数，多个可在后面添加，以空格分隔</span><br></pre></td></tr></table></figure>

<h4 id="2-shell-命令行参数"><a href="#2-shell-命令行参数" class="headerlink" title="2. shell 命令行参数"></a>2. shell 命令行参数</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line">echo $1, $2       # 获取命令行参数，第一个第二个， 如果没有就为空</span><br></pre></td></tr></table></figure>

<p>执行：</p>
<p>./exec.sh a b</p>
<h4 id="3-if-判断"><a href="#3-if-判断" class="headerlink" title="3.  if  判断"></a>3.  if  判断</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function check()</span><br><span class="line">&#123;</span><br><span class="line">    if [ ! -d "$release_name" ]; then</span><br><span class="line">        echo "$release_name"" not exists, check the online dir"</span><br><span class="line">        return</span><br><span class="line">    fi</span><br><span class="line">    if [ -z "$1" ]; then</span><br><span class="line">        echo "must give the dir"</span><br><span class="line">        return</span><br><span class="line">    elif [ ! -d "$1" ]; then</span><br><span class="line">        echo "$1" "not exists please give the dir will online"</span><br><span class="line">        return</span><br><span class="line">    else</span><br><span class="line">        echo "check ok"</span><br><span class="line">        do_online $1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>-d  判读是不是一个目录，如果是为真</p>
<p>-f   判断是不是一个普通文件，是为真</p>
<p>-z 判断字符的长度是不是为0，为0则为真</p>
<p>==/!=  字符串相等/不等</p>

        
    </section>
</article>




<nav class="page-nav">
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span>
</nav>


</div>
        <footer class="footer">
    Powered by <a href="http://shiguofu.cn" target="_blank">carlshi</a>,  <a href="https://beian.miit.gov.cn/" target="_blank">鄂ICP备18003559号-1</a>

    
</footer>

    </main>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }
            
            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle();
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp();
            }, 3000);
        }
    });
    </script>
    

</body>
</html>
